"use strict";(self.webpackChunkSUBRIVA_BILLING=self.webpackChunkSUBRIVA_BILLING||[]).push([[331],{26016:(e,t,i)=>{i.d(t,{y:()=>l});var n=i(91449);const l=e=>{let{action:t,success:i,title:l,getAllItems:o,resetForm:a,errorMessage:r}=e;i?((0,n.P0)("success","".concat(l," ").concat(t,"d successfully")),null===o||void 0===o||o(),null===a||void 0===a||a()):(0,n.P0)("error",r||"Failed to ".concat(t," ").concat(l))}},30746:(e,t,i)=>{i.d(t,{y:()=>a});var n=i(65043),l=i(66885),o=i(39177);const a=()=>{const{BillTemplateComponent:e,InvoiceTemplateComponent:t,settings:i}=(0,o.V)();return{printDocument:(0,n.useCallback)(((o,a,r)=>{const s=r||i,d="bill"===a?e:t,c=window.open("","","width=900,height=700");if(!c)return void console.error("Failed to open print window");const u=n.createElement(d,{billData:o,settings:s}),m=l.renderToString(u);c.document.write("\n      <!DOCTYPE html>\n      <html>\n        <head>\n          <title>".concat("bill"===a?"Bill":"Invoice"," - ").concat((null===o||void 0===o?void 0:o.invoice_no)||"","</title>\n          <style>\n            * {\n              margin: 0;\n              padding: 0;\n              box-sizing: border-box;\n            }\n            body {\n              margin: 0;\n              padding: 0;\n            }\n            @media print {\n              @page {\n                margin: 0;\n                size: auto;\n              }\n              body {\n                margin: 0;\n                padding: 0;\n              }\n            }\n          </style>\n        </head>\n        <body>\n          ").concat(m,"\n          <script>\n            // Auto-print after load\n            window.onload = function() {\n              setTimeout(function() {\n                window.print();\n              }, 250);\n            };\n          <\/script>\n        </body>\n      </html>\n    ")),c.document.close()}),[e,t,i]),previewDocument:(0,n.useCallback)(((o,a,r)=>{const s=r||i,d="bill"===a?e:t,c=window.open("","","width=900,height=700");if(!c)return void console.error("Failed to open preview window");const u=n.createElement(d,{billData:o,settings:s}),m=l.renderToString(u);c.document.write("\n      <!DOCTYPE html>\n      <html>\n        <head>\n          <title>Preview - ".concat("bill"===a?"Bill":"Invoice","</title>\n          <style>\n            * {\n              margin: 0;\n              padding: 0;\n              box-sizing: border-box;\n            }\n            body {\n              margin: 0;\n              padding: 20px;\n              background: #f5f5f5;\n            }\n            @media print {\n              @page { margin: 0; }\n              body { margin: 0; padding: 0; background: white; }\n            }\n          </style>\n        </head>\n        <body>\n          ").concat(m,"\n        </body>\n      </html>\n    ")),c.document.close()}),[e,t,i])}}},39177:(e,t,i)=>{i.d(t,{V:()=>r});var n=i(65043),l=i(98350),o=i(89472),a=i(82271);const r=()=>{var e;const t=(0,n.useMemo)((()=>(0,o.HW)()),[]),i=(null===t||void 0===t?void 0:t.organisation_id)||(null===t||void 0===t||null===(e=t.organisationItems)||void 0===e?void 0:e._id),{data:r,isLoading:s}=l.lh.useGetSettingsQuery({organisation_id:i,page:1,limit:1},{skip:!i,refetchOnMountOrArgChange:!1}),d=(0,n.useMemo)((()=>{const e=(null===r||void 0===r?void 0:r.result)||r||{};return Array.isArray(e)?e[0]:e}),[r]),c=(null===d||void 0===d?void 0:d.bill_template)||"classic",u=(null===d||void 0===d?void 0:d.invoice_template)||"classic";return{BillTemplateComponent:(0,a.G6)(c),InvoiceTemplateComponent:(0,a.Qv)(u),billTemplateKey:c,invoiceTemplateKey:u,isLoading:s,settings:d}}},46331:(e,t,i)=>{i.r(t),i.d(t,{default:()=>ni});var n=i(89379),l=i(65043),o=i(83003),a=i(89472),r=i(83833),s=i(16569),d=i(96651),c=i(7866),u=i(12624),m=i(37490),p=i(95206),v=i(60446),f=i.n(v),y=i(62751),x=i(36621),_=i(26553),h=i(93504),g=i(6051),b=i(39249),A=i(73847),j=i(9316),k=i(88143),C=i(47615),w=i(98350),I=i(35708),S=i(70579);const{Search:D}=x.A,T=e=>{let{visible:t,onSelect:i,onCancel:n}=e;const{data:o,isLoading:a}=w.lh.useGetProductQuery({}),r=(null===o||void 0===o?void 0:o.result)||[],[d,c]=(0,l.useState)(""),[u,m]=(0,l.useState)(null),[v,f]=(0,l.useState)(0),[x,_]=(0,l.useState)(!1),h=(0,l.useRef)(null),A=(null===r||void 0===r?void 0:r.filter((e=>{var t,i,n,l,o,a,r;const s=d.toLowerCase();return((null===(t=e.name)||void 0===t?void 0:t.toLowerCase())||"").includes(s)||((null===(i=e.sku)||void 0===i?void 0:i.toLowerCase())||"").includes(s)||(null===(n=e.VariantItem)||void 0===n||null===(l=n.variant_name)||void 0===l?void 0:l.toLowerCase().includes(s))||(null===(o=e.VariantItem)||void 0===o||null===(a=o.variant_code)||void 0===a?void 0:a.toLowerCase().includes(s))||((null===(r=e.selling_price)||void 0===r?void 0:r.toString())||"").includes(s)})).sort(((e,t)=>{var i,n,l,o,a,r,s,c,u,m,p,v,f,y,x,_;const h=d.toLowerCase(),g=((null===(i=e.name)||void 0===i?void 0:i.toLowerCase())||"")===h||(null===(n=e.VariantItem)||void 0===n||null===(l=n.variant_name)||void 0===l?void 0:l.toLowerCase())===h||((null===(o=e.sku)||void 0===o?void 0:o.toLowerCase())||"")===h,b=((null===(a=t.name)||void 0===a?void 0:a.toLowerCase())||"")===h||(null===(r=t.VariantItem)||void 0===r||null===(s=r.variant_name)||void 0===s?void 0:s.toLowerCase())===h||((null===(c=t.sku)||void 0===c?void 0:c.toLowerCase())||"")===h;if(g&&!b)return-1;if(!g&&b)return 1;const A=((null===(u=e.name)||void 0===u?void 0:u.toLowerCase())||"").startsWith(h)||(null===(m=e.VariantItem)||void 0===m||null===(p=m.variant_name)||void 0===p?void 0:p.toLowerCase().startsWith(h))||((null===(v=e.sku)||void 0===v?void 0:v.toLowerCase())||"").startsWith(h),j=((null===(f=t.name)||void 0===f?void 0:f.toLowerCase())||"").startsWith(h)||(null===(y=t.VariantItem)||void 0===y||null===(x=y.variant_name)||void 0===x?void 0:x.toLowerCase().startsWith(h))||((null===(_=t.sku)||void 0===_?void 0:_.toLowerCase())||"").startsWith(h);return A&&!j?-1:!A&&j?1:0})))||[];(0,l.useEffect)((()=>{f(0),A.length>0?m(A[0]._id):m(null)}),[d,t,r]),(0,l.useEffect)((()=>{t&&setTimeout((()=>{var e;null===(e=h.current)||void 0===e||e.focus()}),100)}),[t]);const j=[{title:"Product & Variant",dataIndex:"name",key:"name",width:250,render:(e,t)=>{var i,n;return(0,S.jsxs)("div",{children:[(0,S.jsx)("div",{style:{fontWeight:600,color:"#1890ff"},children:e}),(null===(i=t.VariantItem)||void 0===i?void 0:i.variant_name)&&(0,S.jsxs)("div",{style:{fontSize:"12px",color:"#52c41a",marginTop:"2px"},children:["Variant: ",t.VariantItem.variant_name,(null===(n=t.VariantItem)||void 0===n?void 0:n.variant_code)&&(0,S.jsxs)("span",{style:{marginLeft:"8px",color:"#fa8c16",fontSize:"11px"},children:["(",t.VariantItem.variant_code,")"]})]})]})}},{title:"Variant",dataIndex:"VariantItem",key:"variant",width:120,render:e=>null!==e&&void 0!==e&&e.variant_name?(0,S.jsx)("span",{style:{color:"#52c41a",fontWeight:500},children:e.variant_name}):(0,S.jsx)("span",{style:{color:"#bfbfbf",fontStyle:"italic"},children:"No variant"})},{title:"SKU",dataIndex:"sku",key:"sku",width:120},{title:"Price",dataIndex:"selling_price",key:"selling_price",width:100,render:e=>(0,S.jsxs)("span",{style:{color:"#52c41a",fontWeight:600,fontSize:"14px"},children:["\u20b9",(null===e||void 0===e?void 0:e.toFixed(2))||"0.00"]})}],k=e=>{i(e)};return(0,S.jsxs)(y.A,{title:"Select Product & Variant (F5 to reopen anytime)",open:t,onCancel:n,width:900,footer:null,destroyOnClose:!0,children:[(0,S.jsxs)("div",{onClick:()=>{var e;null===(e=h.current)||void 0===e||e.focus()},children:[(0,S.jsxs)(g.A.Compact,{style:{marginBottom:16,width:"100%"},children:[(0,S.jsx)(D,{ref:h,placeholder:"Search by product name, variant, SKU, or price (use \u2191\u2193 arrows to navigate, Enter to select)",onChange:e=>c(e.target.value),style:{flex:1},autoFocus:!0,onKeyDown:e=>{var t;if(A.length)if("ArrowDown"===e.key)e.preventDefault(),f((e=>{const t=Math.min(e+1,A.length-1);return m(A[t]._id),t})),null===(t=h.current)||void 0===t||t.focus();else if("ArrowUp"===e.key){var i;e.preventDefault(),f((e=>{const t=Math.max(e-1,0);return m(A[t]._id),t})),null===(i=h.current)||void 0===i||i.focus()}else if("Enter"===e.key){e.preventDefault();const t=A[v];t&&k(t)}else"Escape"===e.key&&(e.preventDefault(),n())},onBlur:()=>{setTimeout((()=>{var e;t&&(null===(e=h.current)||void 0===e||e.focus())}),10)},value:d}),(0,S.jsx)(p.Ay,{type:"primary",icon:(0,S.jsx)(C.A,{}),onClick:()=>_(!0),style:{minWidth:100},children:"Scan"})]}),(0,S.jsx)(b.A,{dataSource:A,columns:j,loading:a,rowKey:"_id",size:"small",pagination:!1,onRow:(e,t)=>({onClick:()=>{k(e),setTimeout((()=>{var e;null===(e=h.current)||void 0===e||e.focus()}),10)},onDoubleClick:()=>k(e),className:t===v?"ant-table-row ant-table-row-selected":"ant-table-row",style:{backgroundColor:t===v?"#e6f7ff":void 0,border:t===v?"2px solid #1890ff":void 0}}),rowSelection:{type:"radio",selectedRowKeys:u?[u]:[],onChange:e=>{m(e[0]);const t=A.findIndex((t=>t._id===e[0]));-1!==t&&f(t)}},scroll:{y:300}}),(0,S.jsxs)("div",{style:{marginTop:16,fontSize:"12px",color:"#666"},children:[(0,S.jsx)("strong",{children:"Keyboard Shortcuts:"})," \u2191\u2193 Navigate products | Enter Select | Escape Cancel",(0,S.jsx)("br",{}),(0,S.jsx)("strong",{children:"Search:"})," Product name, variant name, SKU, or price",(0,S.jsx)("br",{}),(0,S.jsx)("strong",{children:"Barcode Scanner:"}),' Click "Scan" button or use USB barcode scanner',(0,S.jsx)("br",{}),(0,S.jsx)("strong",{children:"Tip:"})," Press F5 anytime to reopen this modal for product changes"]})]}),(0,S.jsx)(I.A,{visible:x,onClose:()=>_(!1),onScan:e=>{var t;c(e),_(!1);const n=null===r||void 0===r||null===(t=r.result)||void 0===t?void 0:t.find((t=>{var i,n,l,o;const a=e.toLowerCase();return((null===(i=t.sku)||void 0===i?void 0:i.toLowerCase())||"").includes(a)||((null===(n=t.name)||void 0===n?void 0:n.toLowerCase())||"").includes(a)||(null===(l=t.VariantItem)||void 0===l||null===(o=l.variant_code)||void 0===o?void 0:o.toLowerCase().includes(a))}));n?(setTimeout((()=>{i(n)}),500),s.Ay.success("Product found: ".concat(n.name))):s.Ay.warning("No product found with barcode: ".concat(e))},title:"Scan Product Barcode",description:"Scan barcode to find product automatically"})]})};var P=i(76399),N=i(66507),E=i(39470),B=i(46237);const{Search:L}=x.A,q=e=>{let{visible:t,onSelect:i,onCancel:n,productId:o}=e;const r=(0,a.HW)(),c=N.A.getItem("scope"),u=((null===c||void 0===c?void 0:c.userType)||(null===r||void 0===r?void 0:r.user_type)||(null===r||void 0===r?void 0:r.usertype)||(null===r||void 0===r?void 0:r.user_role)||"").toLowerCase(),m="organisationuser"===u,p="branchuser"===u,v=!!o&&!!t,{data:x,isLoading:_}=w.lh.useGetStockAuditQuery({product_id:o},{skip:!v||!m,refetchOnMountOrArgChange:!0,refetchOnFocus:!0,refetchOnReconnect:!0}),{data:h,isLoading:g}=w.lh.useGetBranchStockQuery({product_id:o},{skip:!v||!p,refetchOnMountOrArgChange:!0,refetchOnFocus:!0,refetchOnReconnect:!0}),A=(m?null===x||void 0===x?void 0:x.result:p?null===h||void 0===h?void 0:h.result:[])||[],j=_||g,[k,C]=(0,l.useState)(""),[I,D]=(0,l.useState)(null),[T,q]=(0,l.useState)(0),[R,G]=(0,l.useState)(""),z=(0,l.useRef)(null),M=(0,l.useRef)(null),V=e=>!(!e.expiry_date||!f()(e.expiry_date).isBefore(f()())),F=e=>e.available_quantity<=0,Y=e=>{const t=f()(e.expiry_date).format("DD/MM/YYYY"),i="Cannot select expired stock! This item expired on ".concat(t,". Please select a valid stock item.");G(i),s.Ay.error(i),setTimeout((()=>{G("")}),5e3)},U=e=>{const t="Cannot select out of stock item! This item has 0 available quantity. Please select a stock item with available quantity.";G(t),s.Ay.error(t),setTimeout((()=>{G("")}),5e3)},K=(Array.isArray(A)?A:[]).filter((e=>{var t,i,n,l,o,a,r,s;const d=k.toLowerCase();return(null===(t=e.batch_no)||void 0===t?void 0:t.toLowerCase().includes(d))||(null===(i=e.ProductItem)||void 0===i||null===(n=i.name)||void 0===n?void 0:n.toLowerCase().includes(d))||(null===(l=e.ProductItem)||void 0===l||null===(o=l.VariantItem)||void 0===o||null===(a=o.variant_name)||void 0===a?void 0:a.toLowerCase().includes(d))||(null===(r=e.available_quantity)||void 0===r?void 0:r.toString().includes(d))||(null===(s=e.sell_price)||void 0===s?void 0:s.toString().includes(d))}));(0,l.useEffect)((()=>{if(q(0),G(""),K.length>0){let e=0;for(;e<K.length&&(K[e].expiry_date&&f()(K[e].expiry_date).isBefore(f()())||K[e].available_quantity<=0);)e++;e<K.length?(D(K[e]._id),q(e)):D(null)}else D(null)}),[k,t,A]),(0,l.useEffect)((()=>{t&&(G(""),setTimeout((()=>{var e;null===(e=M.current)||void 0===e||e.focus()}),0))}),[t]),(0,l.useEffect)((()=>{if(z.current){var e;const t=z.current.querySelector(".ant-table-row[data-row-key='".concat(null===(e=K[T])||void 0===e?void 0:e._id,"']"));null===t||void 0===t||t.scrollIntoView({block:"nearest"})}}),[T,K]);const O=[{title:"Product",dataIndex:"ProductItem",key:"product",render:e=>(null===e||void 0===e?void 0:e.name)||"N/A"},{title:"Variant",dataIndex:"ProductItem",key:"variant",render:e=>{var t;return(null===e||void 0===e||null===(t=e.VariantItem)||void 0===t?void 0:t.variant_name)||"N/A"}},{title:"Batch No",dataIndex:"batch_no",key:"batch_no"},{title:"Available",dataIndex:"available_quantity",key:"available_quantity",render:(e,t)=>{const i=e<=0;return(0,S.jsxs)("span",{style:{color:i?"#ff4d4f":"#52c41a",fontWeight:i?"bold":"normal"},children:[e,i&&(0,S.jsx)(E.A,{style:{marginLeft:4,color:"#ff4d4f"}})]})}},{title:"Price",dataIndex:"sell_price",key:"sell_price"},{title:"Expiry Date",dataIndex:"expiry_date",key:"expiry_date",render:(e,t)=>{if(!e)return(0,S.jsx)("span",{style:{color:"#999"},children:"No Expiry"});const i=f()(e),n=f()(),l=i.isBefore(n),o=i.diff(n,"days");let a="green",r=(0,S.jsx)(B.A,{}),s="Valid";return l?(a="red",r=(0,S.jsx)(E.A,{}),s="Expired"):o<=30&&(a="orange",r=(0,S.jsx)(E.A,{}),s="Expires in ".concat(o," days")),(0,S.jsx)(d.A,{title:s,children:(0,S.jsx)(P.A,{color:a,icon:r,children:i.format("DD/MM/YYYY")})})}}],Q=e=>{var t;V(e)?Y(e):F(e)?U():(G(""),i({id:e._id,_id:e._id,batch_no:e.batch_no,name:(null===(t=e.ProductItem)||void 0===t?void 0:t.name)||e.name||"",code:e.code,available_quantity:e.available_quantity,available_loose_quantity:e.available_loose_quantity,sell_price:e.sell_price,ProductItem:e.ProductItem}))};return(0,S.jsx)(y.A,{title:"Select Stock (F7 to reopen anytime)",open:t,onCancel:n,width:800,footer:null,destroyOnClose:!0,children:(0,S.jsxs)("div",{onClick:()=>{var e;null===(e=M.current)||void 0===e||e.focus()},children:[(0,S.jsx)(L,{ref:M,placeholder:"Search stocks (use \u2191\u2193 arrows to navigate, Enter to select)",onChange:e=>C(e.target.value),style:{marginBottom:16},autoFocus:!0,onKeyDown:e=>{var t;if(K.length)if("ArrowDown"===e.key)e.preventDefault(),q((e=>{let t=e+1;for(;t<K.length&&(K[t].expiry_date&&f()(K[t].expiry_date).isBefore(f()())||K[t].available_quantity<=0);)t++;const i=Math.min(t,K.length-1);return D(K[i]._id),i})),null===(t=M.current)||void 0===t||t.focus();else if("ArrowUp"===e.key){var i;e.preventDefault(),q((e=>{let t=e-1;for(;t>=0&&(K[t].expiry_date&&f()(K[t].expiry_date).isBefore(f()())||K[t].available_quantity<=0);)t--;const i=Math.max(t,0);return D(K[i]._id),i})),null===(i=M.current)||void 0===i||i.focus()}else if("Enter"===e.key){e.preventDefault();const t=K[T];t&&(Q(t),V(t)||F(t)||n())}},onBlur:()=>{setTimeout((()=>{var e;t&&(null===(e=M.current)||void 0===e||e.focus())}),10)}}),R&&(0,S.jsxs)("div",{style:{marginBottom:16,padding:"12px 16px",backgroundColor:"#fff2f0",border:"1px solid #ffccc7",borderRadius:"6px",color:"#cf1322",fontSize:"14px",display:"flex",alignItems:"center",gap:"8px"},children:[(0,S.jsx)(E.A,{style:{color:"#cf1322"}}),R]}),(0,S.jsxs)("div",{onKeyDown:e=>{var t;if(K.length)if("ArrowDown"===e.key)e.preventDefault(),q((e=>{let t=e+1;for(;t<K.length&&(K[t].expiry_date&&f()(K[t].expiry_date).isBefore(f()())||K[t].available_quantity<=0);)t++;const i=Math.min(t,K.length-1);return D(K[i]._id),i})),null===(t=M.current)||void 0===t||t.focus();else if("ArrowUp"===e.key)e.preventDefault(),q((e=>{let t=e-1;for(;t>=0&&(K[t].expiry_date&&f()(K[t].expiry_date).isBefore(f()())||K[t].available_quantity<=0);)t--;const i=Math.max(t,0);return D(K[i]._id),i}));else if("Enter"===e.key){e.preventDefault();const t=K[T];t&&(Q(t),V(t)||F(t)||n())}else if("Escape"===e.key){var i;e.preventDefault(),null===(i=M.current)||void 0===i||i.focus()}else if("Tab"===e.key&&e.shiftKey){var l;e.preventDefault(),null===(l=M.current)||void 0===l||l.focus()}},tabIndex:0,ref:z,style:{outline:"none"},children:[(0,S.jsx)(b.A,{dataSource:K,columns:O,loading:j,rowKey:"_id",size:"small",pagination:!1,title:()=>(0,S.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 0"},children:[(0,S.jsx)("span",{children:"Stock Items"}),(0,S.jsxs)("div",{style:{fontSize:"12px",color:"#666"},children:[(0,S.jsx)("span",{style:{color:"#52c41a"},children:"\ud83d\udfe2 Valid"}),(0,S.jsx)("span",{style:{margin:"0 8px",color:"#faad14"},children:"\ud83d\udfe0 Near Expiry"}),(0,S.jsx)("span",{style:{color:"#ff4d4f"},children:"\ud83d\udd34 Expired/Out of Stock (Disabled)"})]})]}),onRow:(e,t)=>{const i=V(e),n=F(e);return{onClick:()=>{i||n?i?Y(e):n&&U():(Q(e),setTimeout((()=>{var e;null===(e=M.current)||void 0===e||e.focus()}),10))},onDoubleClick:()=>{i||n?i?Y(e):n&&U():Q(e)},className:t===T?"ant-table-row ant-table-row-selected":"ant-table-row","data-row-key":e._id,style:{opacity:i||n?.6:1,cursor:i||n?"not-allowed":"pointer",backgroundColor:i||n?"#f5f5f5":void 0}}},rowSelection:{type:"radio",selectedRowKeys:I?[I]:[],onChange:e=>{D(e[0]);const t=K.findIndex((t=>t._id===e[0]));-1!==t&&q(t)},getCheckboxProps:e=>({disabled:V(e)||F(e)})}}),(0,S.jsxs)("div",{style:{marginTop:16,fontSize:"12px",color:"#666"},children:[(0,S.jsx)("strong",{children:"Keyboard Shortcuts:"})," \u2191\u2193 Navigate stocks | Enter Select | Escape Cancel",(0,S.jsx)("br",{}),(0,S.jsx)("strong",{children:"Tip:"})," Press F7 anytime to reopen this modal for stock changes",(0,S.jsx)("br",{}),(0,S.jsx)("strong",{children:"Note:"})," Expired items (\ud83d\udd34) and out of stock items (\ud83d\udd34) are shown but cannot be selected. Navigation automatically skips expired and out of stock items.",(0,S.jsx)("br",{}),(0,S.jsx)("strong",{children:"Error Handling:"})," Attempting to select expired or out of stock items will show an error message and prevent selection."]})]})]})})},{Text:R}=r.A,G=e=>{let{columns:t,dataSource:i,onSave:o,onAdd:a,onDelete:r,allowAdd:d=!0,allowDelete:u=!0,rowKey:m="key",loading:v=!1,compact:C=!1,enableKeyboardNav:w=!0,size:I="middle",className:D,onProductSelect:P,externalEditingCell:N}=e;const[E,B]=(0,l.useState)([]),[L,G]=(0,l.useState)([]),[z,M]=(0,l.useState)(null),V=(0,l.useRef)(!0);(0,l.useEffect)((()=>{B(i);const e=t.findIndex((e=>"product_id"===e.dataIndex));V.current&&0===i.length&&e>=0?(M({row:0,col:e}),V.current=!1):G(i.length>0?[String(i.length-1)]:[])}),[i,t]),(0,l.useEffect)((()=>{N&&M(N)}),[N]);const F=()=>{null===a||void 0===a||a();const e=t.findIndex((e=>!1!==e.editable));e>=0&&M({row:E.length,col:e})},Y=(e,i,n)=>{const l=t[i];if(l.required&&(!n||""===n))return s.Ay.error("".concat(l.title," is required")),!1;if(l.validation){const e=l.validation(n);if(e)return s.Ay.error(e),!1}const a=[...E];return a[e][t[i].dataIndex]=n,B(a),o(a),!0};(0,l.useEffect)((()=>{const e=e=>{e.ctrlKey&&"s"===e.key&&(e.preventDefault(),o(E)),e.shiftKey&&"a"===e.key.toLowerCase()&&d&&(e.preventDefault(),F())};if(w)return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)}),[E,d,o,w,F]);const U={onChange:(e,t)=>{G([...e])}};function K(e,t,i){let n=e+t;for(;n>=0&&n<i.length;){if(!1!==i[n].editable)return n;n+=t}return-1}const O=e=>{var i,n,a,r;let{row:u,col:m,value:p}=e;const[v,y]=(0,l.useState)(p),g=(0,l.useRef)(null),b=t[m],[A,j]=(0,l.useState)(!1),[k,C]=(0,l.useState)(!1);(0,l.useEffect)((()=>{y(p),setTimeout((()=>{var e;null===(e=g.current)||void 0===e||e.focus()}),50)}),[p]);const w=e=>{y(e),Y(u,m,e)},I=e=>{if("product"===b.type&&"Enter"===e.key)return e.stopPropagation(),void j(!0);if("stock"===b.type&&"Enter"===e.key)return e.stopPropagation(),void C(!0);if("Tab"===e.key){if(e.preventDefault(),b.required&&(!v||""===v))return void s.Ay.error("".concat(b.title," is required"));const i=e.shiftKey?m-1:m+1,n=u+(i>=t.length?1:0),l=(i+t.length)%t.length;n<E.length?M({row:n,col:l}):d&&(F(),M({row:E.length,col:l}))}else"Escape"===e.key&&M(null)},D=e=>{P&&P(e,u),j(!1),M(null)},N=e=>{const t=[...E];t[u].stock_id=e.id||e._id||"",t[u].batch_no=e.batch_no||"",B(t),o(t),C(!1),M(null)};switch(b.type){case"product":const e=null!==(i=E[u])&&void 0!==i&&i.product_name?"".concat(E[u].product_name).concat(null!==(n=E[u])&&void 0!==n&&n.variant_name?" ".concat(E[u].variant_name):"").trim():v;return(0,S.jsxs)(S.Fragment,{children:[(0,S.jsx)("div",{onClick:e=>e.stopPropagation(),children:(0,S.jsx)(x.A,{ref:g,value:e,onKeyDown:I,placeholder:"Press Enter to select product",readOnly:!0,style:{cursor:"pointer"}})}),A&&(0,S.jsx)(T,{visible:A,onSelect:D,onCancel:()=>j(!1)})]});case"stock":return(0,S.jsxs)(S.Fragment,{children:[(0,S.jsx)("div",{onClick:e=>e.stopPropagation(),children:(0,S.jsx)(x.A,{ref:g,value:(null===(a=E[u])||void 0===a?void 0:a.batch_no)||v,onKeyDown:I,placeholder:"Press Enter to select stock",readOnly:!0})}),k&&(0,S.jsx)(q,{visible:k,onSelect:N,onCancel:()=>C(!1),productId:(null===(r=E[u])||void 0===r?void 0:r.product_id)||""})]});case"number":return(0,S.jsx)("div",{onClick:e=>e.stopPropagation(),children:(0,S.jsx)(c.A,{ref:g,value:v,onChange:w,onBlur:()=>M(null),controls:!1,onKeyDown:e=>{if("Tab"===e.key||"Enter"===e.key){if(e.preventDefault(),b.required&&(!v||""===v))return void s.Ay.error("".concat(b.title," is required"));const i=e.shiftKey?-1:1,n=K(m,i,t);if(-1!==n)M({row:u,col:n});else{const e=i>0?u+1:u-1;if(e>=0&&e<E.length){const i=K(-1,1,t);-1!==i&&M({row:e,col:i})}else if(i>0&&d){F();const e=K(-1,1,t);-1!==e&&M({row:E.length,col:e})}else M(null)}}else"Escape"===e.key&&M(null)},style:{width:"100%"}})});case"select":return(0,S.jsx)("div",{onClick:e=>e.stopPropagation(),children:(0,S.jsx)(_.A,{ref:g,value:v,options:b.options,onChange:e=>{if(Y(u,m,e)){const e=m+1,i=u+(e>=t.length?1:0),n=(e+t.length)%t.length;i<E.length?M({row:i,col:n}):d&&(F(),M({row:E.length,col:n}))}else setTimeout((()=>{var e;null===(e=g.current)||void 0===e||e.focus()}),50)},style:{width:"100%"},onKeyDown:e=>{"Enter"!==e.key&&"Tab"!==e.key||e.preventDefault()}})});case"date":return(0,S.jsx)("div",{onClick:e=>e.stopPropagation(),children:(0,S.jsx)(h.A,{ref:g,value:v?f()(v):null,onChange:e=>{w(e?e.format("YYYY-MM-DD"):null),M(null)},onBlur:()=>M(null),onKeyDown:I,style:{width:"100%"}})});default:return(0,S.jsx)("div",{onClick:e=>e.stopPropagation(),children:(0,S.jsx)(x.A,{ref:g,value:v,onChange:e=>w(e.target.value),onBlur:()=>M(null),onKeyDown:I})})}},Q=t.map(((e,t)=>(0,n.A)((0,n.A)({},e),{},{onCell:(e,i)=>({onClick:()=>{"number"===typeof i&&M({row:i,col:t})},onContextMenu:e=>{e.preventDefault(),"number"===typeof i&&M({row:i,col:t})}}),render:(i,n,l)=>{if(z&&z.row===l&&z.col===t)return(0,S.jsx)(O,{row:l,col:t,value:n[e.dataIndex]},"".concat(l,"-").concat(t));if("function"===typeof e.render)return e.render(i,n,l);if("batch_no"===e.dataIndex)return n.batch_no||n[e.dataIndex];if("product_id"===e.dataIndex)return n.product_name||n[e.dataIndex];if("select"===e.type&&e.options){const t=e.options.find((t=>t.value===n[e.dataIndex]));return t?t.label:n[e.dataIndex]}return n[e.dataIndex]}})));return(0,S.jsxs)("div",{className:"antd-editable-table ".concat(C?"compact":""," ").concat(D||""),children:[(0,S.jsxs)("div",{className:"table-toolbar",children:[(0,S.jsxs)(g.A,{children:[d&&(0,S.jsx)(p.Ay,{type:"primary",icon:(0,S.jsx)(A.A,{}),onClick:F,children:"Add Row (Shift+A)"}),u&&(0,S.jsx)(p.Ay,{danger:!0,icon:(0,S.jsx)(j.A,{}),onClick:()=>{0!==E.length?y.A.confirm({title:"Are you sure you want to delete the selected Bill Items?",onOk:()=>{const e=E.slice(0,-1);B(e),o(e),null===r||void 0===r||r(L)}}):s.Ay.warning("No rows to delete")},children:"Delete Row"}),(0,S.jsx)(p.Ay,{type:"primary",icon:(0,S.jsx)(k.A,{}),onClick:()=>o(E),children:"Save (Ctrl+S)"})]}),(0,S.jsx)(R,{type:"secondary",className:"table-info",children:"Use Tab / Shift+Tab to navigate cells"})]}),(0,S.jsx)(b.A,{bordered:!0,dataSource:E,columns:Q,rowKey:m,loading:v,pagination:!1,size:I,scroll:{y:400},rowSelection:(0,n.A)((0,n.A)({},U),{},{type:"checkbox",selectedRowKeys:L})})]})};var z=i(47246);var M=i(36091),V=i(93310),F=i(94834),Y=i(53986),U=i(62305),K=i(47419),O=i(11645),Q=i(8354),W=i(87534),H=i(75388),X=i(46011),J=i(72411),Z=i(67177),$=i(15615),ee=i(53722),te=i(71281);const ie=["create"],{Title:ne,Text:le}=r.A,{Option:oe}=_.A,ae=e=>{let{visible:t,onSelect:i,onCancel:o}=e;const[a,r]=(0,l.useState)(""),[d,c]=(0,l.useState)(""),[u,m]=(0,l.useState)(!1),[v,f]=(0,l.useState)(null),[_,h]=(0,l.useState)(-1),[j,C]=(0,l.useState)(!1),[I,D]=(0,l.useState)({full_name:"",email:"",mobile:"",address:"",customer_type:"regular"}),[T]=U.A.useForm(),N=(0,l.useRef)(null),E=(0,l.useRef)(null),B=(0,l.useRef)(null),L=(0,l.useRef)(null),q=(0,l.useRef)(null),{data:R,isLoading:G,refetch:M}=w.lh.useGetCustomerQuery({searchString:d},{skip:!t}),V=(0,z.Ib)("Customer").useCreate(),{create:F}=V,oe=(0,Y.A)(V,ie),ae=oe.isLoading,re=(0,l.useMemo)((()=>R&&(null===R||void 0===R?void 0:R.result)||[]),[R]),se=(0,l.useMemo)((()=>{if(!a.trim())return re;const e=a.toLowerCase();return re.filter((t=>{var i,n,l;return(null===(i=t.full_name)||void 0===i?void 0:i.toLowerCase().includes(e))||(null===(n=t.mobile)||void 0===n?void 0:n.includes(e))||(null===(l=t.email)||void 0===l?void 0:l.toLowerCase().includes(e))}))}),[re,a]),de=(0,l.useMemo)((()=>a.trim()&&!G&&0===se.length),[a,G,se.length]),ce=(0,l.useCallback)((e=>({vip:"gold",wholesale:"blue",regular:"green"}[e]||"green")),[]),ue=(0,l.useCallback)((e=>{if(0===se.length)return;let t;switch(e){case"up":t=-1===_?se.length-1:Math.max(_-1,0);break;case"down":t=-1===_?0:Math.min(_+1,se.length-1);break;case"home":t=0;break;case"end":t=se.length-1;break;default:return}h(t),f(se[t]),setTimeout((()=>{const i=document.querySelector('[data-row-key="'.concat(se[t]._id,'"]'));if(i){const t="home"===e?"start":"end"===e?"end":"nearest";i.scrollIntoView({behavior:"smooth",block:t})}}),100)}),[se,_]),me=(0,l.useCallback)((e=>{r(e),B.current&&clearTimeout(B.current),B.current=setTimeout((()=>{c(e.trim())}),500)}),[]),pe=(0,l.useCallback)((e=>{f(e),i(e),setTimeout((()=>o()),100)}),[i,o]),ve=(0,l.useCallback)((()=>{D({full_name:"",email:"",mobile:"",address:"",customer_type:"regular"}),T.resetFields()}),[T]),fe=(0,l.useCallback)((async()=>{try{if(!I.full_name.trim())return void s.Ay.error("Full name is required");if(!I.mobile.trim())return void s.Ay.error("Mobile number is required");const i=await F(I);if(!i.error&&i.data){var e,t;const n=(null===(e=i.data)||void 0===e?void 0:e.data)||(null===(t=i.data)||void 0===t?void 0:t.result)||i.data;n&&(ve(),m(!1),C(!1),M(),setTimeout((()=>{pe(n)}),100))}}catch(i){s.Ay.error("Failed to create customer"),ve()}}),[I,F,pe,ve,M]),ye=(0,l.useCallback)(((e,t)=>{D((i=>(0,n.A)((0,n.A)({},i),{},{[e]:t})))}),[]),xe=(0,l.useCallback)((e=>{if("Escape"===e.key)o();else if(["ArrowDown","ArrowUp","Home","End"].includes(e.key)){e.preventDefault(),e.stopPropagation();ue({ArrowDown:"down",ArrowUp:"up",Home:"home",End:"end"}[e.key])}}),[ue,o]),_e=(0,l.useCallback)((e=>{if(!t)return;const i=e.target;if("INPUT"!==i.tagName&&"TEXTAREA"!==i.tagName&&!i.classList.contains("ant-select-selector")&&!i.closest(".ant-select-dropdown")){if(e.ctrlKey&&"f"===e.key)return e.preventDefault(),e.stopPropagation(),void(N.current&&(N.current.focus(),N.current.select()));if(e.ctrlKey&&"n"===e.key)return e.preventDefault(),e.stopPropagation(),void(de&&(C(!0),setTimeout((()=>{if(L.current){const e=L.current.querySelector("input");e&&(e.focus(),e.select())}}),100)));if(["ArrowDown","ArrowUp","Home","End"].includes(e.key)){e.preventDefault(),e.stopPropagation();ue({ArrowDown:"down",ArrowUp:"up",Home:"home",End:"end"}[e.key])}}}),[t,ue,de]),he=(0,l.useMemo)((()=>[{title:"",key:"select",width:60,render:(e,t)=>(0,S.jsx)("div",{style:{cursor:"pointer",display:"flex",justifyContent:"center",alignItems:"center"},onClick:()=>{f(t);const e=se.findIndex((e=>e._id===t._id));h(e)},children:(0,S.jsx)("div",{style:{width:"18px",height:"18px",borderRadius:"50%",border:(null===v||void 0===v?void 0:v._id)===t._id?"2px solid #1890ff":"2px solid #d9d9d9",backgroundColor:(null===v||void 0===v?void 0:v._id)===t._id?"#1890ff":"white",display:"flex",alignItems:"center",justifyContent:"center",transition:"all 0.2s ease"},children:(null===v||void 0===v?void 0:v._id)===t._id&&(0,S.jsx)("div",{style:{width:"8px",height:"8px",borderRadius:"50%",backgroundColor:"white"}})})})},{title:"Customer Name",dataIndex:"full_name",key:"full_name",render:(e,t)=>(0,S.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:8},children:[(0,S.jsx)(le,{strong:!0,children:e}),(0,S.jsx)(P.A,{color:ce(t.customer_type),children:t.customer_type.toUpperCase()})]})},{title:"Mobile",dataIndex:"mobile",key:"mobile",render:e=>(0,S.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:8},children:[(0,S.jsx)(W.A,{style:{color:"#666"}}),(0,S.jsx)(le,{children:e})]})},{title:"Email",dataIndex:"email",key:"email",render:e=>(0,S.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:8},children:[(0,S.jsx)(H.A,{style:{color:"#666"}}),(0,S.jsx)(le,{children:e||"-"})]})},{title:"Address",dataIndex:"address",key:"address",render:e=>(0,S.jsxs)("div",{style:{display:"flex",alignItems:"flex-start",gap:8},children:[(0,S.jsx)(X.A,{style:{color:"#666",marginTop:"2px"}}),(0,S.jsx)(le,{type:"secondary",style:{fontSize:"12px"},children:e||"-"})]})}]),[v,se,ce]),ge=(0,l.useCallback)(((e,t)=>({onClick:()=>{f(e),h(null!==t&&void 0!==t?t:0)},style:{cursor:"pointer",backgroundColor:(null===v||void 0===v?void 0:v._id)===e._id?"#f0f8ff":"white",border:(null===v||void 0===v?void 0:v._id)===e._id?"2px solid #1890ff":"1px solid #f0f0f0",borderRadius:"4px",transition:"all 0.2s ease"},onMouseEnter:t=>{(null===v||void 0===v?void 0:v._id)!==e._id&&(t.currentTarget.style.backgroundColor="#f5f5f5")},onMouseLeave:t=>{(null===v||void 0===v?void 0:v._id)!==e._id&&(t.currentTarget.style.backgroundColor="white")}})),[v]);(0,l.useEffect)((()=>(t?(f(null),h(-1),C(!1)):(r(""),f(null),h(-1),C(!1),m(!1),ve(),B.current&&(clearTimeout(B.current),B.current=null)),()=>{B.current&&clearTimeout(B.current)})),[t,ve]),(0,l.useEffect)((()=>{!de||j||u||C(!0)}),[de,j,u]),(0,l.useEffect)((()=>{if(t&&N.current&&!u&&!j){const e=()=>{N.current&&(N.current.focus(),N.current.select())};e();const t=setTimeout(e,100);return()=>clearTimeout(t)}}),[t,u,j]),(0,l.useEffect)((()=>{if((u||j)&&t){const e=setTimeout((()=>{q.current&&(q.current.focus(),q.current.select())}),100);return()=>clearTimeout(e)}}),[u,j,t]),(0,l.useEffect)((()=>{if(t)return document.addEventListener("keydown",_e,!0),()=>document.removeEventListener("keydown",_e,!0)}),[t,_e]),(0,te.z)({action:"create",title:"Customer",mutationResult:oe,refetch:M}),(0,l.useEffect)((()=>{ae?s.Ay.loading({content:"Creating customer...",key:"customer-creation",duration:0}):s.Ay.destroy("customer-creation")}),[ae]);const be=(0,l.useCallback)((()=>{f(null),h(-1)}),[]);return(0,S.jsxs)(y.A,{title:"Select Customer",open:t,onCancel:o,footer:null,width:1e3,style:{top:20},afterOpenChange:e=>{e&&N.current&&!u&&!j&&setTimeout((()=>{var e,t;null===(e=N.current)||void 0===e||e.focus(),null===(t=N.current)||void 0===t||t.select()}),100)},children:[(0,S.jsx)("div",{ref:E,style:{marginBottom:16},onKeyDown:xe,tabIndex:0,children:(0,S.jsxs)(g.A.Compact,{style:{width:"100%"},children:[(0,S.jsx)(x.A,{ref:N,placeholder:"Search customers... (Ctrl+N: New customer, \u2191\u2193: Navigate, Enter: Select, Esc: Close)",value:a,onChange:e=>me(e.target.value),prefix:(0,S.jsx)(J.A,{}),style:{flex:1},onKeyDown:e=>{"Enter"===e.key&&v&&pe(v)},onFocus:be,autoFocus:!u&&!j,onBlur:u||j?void 0:()=>{t&&N.current&&setTimeout((()=>{t&&N.current&&!u&&!j&&N.current.focus()}),10)},suffix:a&&G?(0,S.jsx)("div",{style:{fontSize:"12px",color:"#999"},children:"Searching..."}):null}),(0,S.jsx)(p.Ay,{type:u?"default":"primary",icon:(0,S.jsx)(Z.A,{}),onClick:()=>{const e=!u;m(e),e||ve()},style:{minWidth:120},children:u?"Cancel":"Add New"})]})}),(j||u)&&(0,S.jsxs)("div",{ref:L,style:{marginBottom:20,padding:24,border:"2px solid #6366f1",borderRadius:16,backgroundColor:"linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%)",background:"linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%)",boxShadow:"0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)",position:"relative",overflow:"hidden"},tabIndex:-1,children:[(0,S.jsx)("div",{style:{position:"absolute",top:-20,right:-20,width:100,height:100,borderRadius:"50%",background:"linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)",opacity:.1,zIndex:0}}),(0,S.jsx)("div",{style:{position:"absolute",bottom:-30,left:-30,width:80,height:80,borderRadius:"50%",background:"linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%)",opacity:.1,zIndex:0}}),(0,S.jsxs)(K.A,{justify:"space-between",align:"middle",style:{marginBottom:24,position:"relative",zIndex:1},children:[(0,S.jsxs)(O.A,{children:[(0,S.jsxs)(ne,{level:4,style:{margin:0,background:"linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",backgroundClip:"text",fontWeight:700,fontSize:"20px"},children:[(0,S.jsx)(A.A,{style:{marginRight:8,color:"#6366f1"}}),"Create New Customer"]}),(0,S.jsx)(le,{style:{fontSize:"14px",color:"#64748b",fontWeight:500,display:"block",marginTop:4},children:"\u2728 Fill in the details below to create a new customer"})]}),(0,S.jsx)(O.A,{children:(0,S.jsxs)(g.A,{size:"middle",children:[(0,S.jsx)(p.Ay,{size:"middle",icon:(0,S.jsx)($.A,{}),onClick:()=>{C(!1),m(!1),M(),ve()},style:{border:"2px solid #e2e8f0",borderRadius:8,fontWeight:600,color:"#64748b",background:"white",boxShadow:"0 2px 4px rgba(0, 0, 0, 0.05)",height:40,padding:"0 20px"},children:"Cancel"}),(0,S.jsx)(p.Ay,{type:"primary",size:"middle",icon:(0,S.jsx)(k.A,{}),onClick:fe,loading:ae,style:{background:"linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)",border:"none",borderRadius:8,fontWeight:600,height:40,padding:"0 24px",boxShadow:"0 4px 12px rgba(99, 102, 241, 0.3)",transition:"all 0.3s ease"},children:"Create & Select"})]})})]}),(0,S.jsxs)(U.A,{form:T,layout:"vertical",size:"middle",style:{position:"relative",zIndex:1},children:[(0,S.jsxs)("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:20,marginBottom:20},children:[(0,S.jsx)(U.A.Item,{name:"full_name",label:(0,S.jsxs)("span",{style:{fontWeight:600,color:"#374151",fontSize:"14px",display:"flex",alignItems:"center",gap:6},children:[(0,S.jsx)(ee.A,{style:{color:"#6366f1"}}),"Full Name"]}),rules:[{required:!0,message:"Please enter full name"}],children:(0,S.jsx)(x.A,{ref:q,name:"full_name",placeholder:"Enter full name",prefix:(0,S.jsx)(ee.A,{style:{color:"#9ca3af"}}),autoFocus:u||j,value:I.full_name,onChange:e=>ye("full_name",e.target.value),onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),fe())},style:{borderRadius:10,border:"2px solid #e5e7eb",padding:"12px 16px",fontSize:"14px",transition:"all 0.3s ease",boxShadow:"0 2px 4px rgba(0, 0, 0, 0.05)",background:"white"}})}),(0,S.jsx)(U.A.Item,{name:"mobile",label:(0,S.jsxs)("span",{style:{fontWeight:600,color:"#374151",fontSize:"14px",display:"flex",alignItems:"center",gap:6},children:[(0,S.jsx)(W.A,{style:{color:"#10b981"}}),"Mobile Number"]}),rules:[{required:!0,message:"Please enter mobile number"},{pattern:/^[0-9]{10}$/,message:"Mobile must be 10 digits"}],children:(0,S.jsx)(x.A,{name:"mobile",placeholder:"Enter mobile number",prefix:(0,S.jsx)(W.A,{style:{color:"#9ca3af"}}),value:I.mobile,onChange:e=>ye("mobile",e.target.value),onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),fe())},style:{borderRadius:10,border:"2px solid #e5e7eb",padding:"12px 16px",fontSize:"14px",transition:"all 0.3s ease",boxShadow:"0 2px 4px rgba(0, 0, 0, 0.05)",background:"white"}})}),(0,S.jsx)(U.A.Item,{name:"email",label:(0,S.jsxs)("span",{style:{fontWeight:600,color:"#374151",fontSize:"14px",display:"flex",alignItems:"center",gap:6},children:[(0,S.jsx)(H.A,{style:{color:"#f59e0b"}}),"Email"]}),rules:[{type:"email",message:"Please enter valid email"}],children:(0,S.jsx)(x.A,{name:"email",placeholder:"Enter email",prefix:(0,S.jsx)(H.A,{style:{color:"#9ca3af"}}),value:I.email,onChange:e=>ye("email",e.target.value),onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),fe())},style:{borderRadius:10,border:"2px solid #e5e7eb",padding:"12px 16px",fontSize:"14px",transition:"all 0.3s ease",boxShadow:"0 2px 4px rgba(0, 0, 0, 0.05)",background:"white"}})})]}),(0,S.jsx)(U.A.Item,{name:"address",label:(0,S.jsxs)("span",{style:{fontWeight:600,color:"#374151",fontSize:"14px",display:"flex",alignItems:"center",gap:6},children:[(0,S.jsx)(X.A,{style:{color:"#ef4444"}}),"Address"]}),children:(0,S.jsx)(x.A.TextArea,{name:"address",placeholder:"Enter address",rows:3,value:I.address,onChange:e=>ye("address",e.target.value),onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),fe())},style:{borderRadius:10,border:"2px solid #e5e7eb",padding:"12px 16px",fontSize:"14px",transition:"all 0.3s ease",boxShadow:"0 2px 4px rgba(0, 0, 0, 0.05)",background:"white",resize:"none"}})})]})]}),(0,S.jsx)(Q.A,{style:{margin:"16px 0"}}),(0,S.jsx)("div",{style:{maxHeight:400,overflow:"auto"},children:G?(0,S.jsx)("div",{style:{textAlign:"center",padding:40},children:(0,S.jsx)(le,{children:"Loading customers..."})}):0===se.length?(0,S.jsxs)("div",{style:{textAlign:"center",padding:40},children:[(0,S.jsx)(le,{type:"secondary",children:a?"No customers found matching your search.":"No customers available."}),a&&(0,S.jsx)("div",{style:{marginTop:16},children:(0,S.jsx)(le,{type:"secondary",children:"Press Ctrl+N to create a new customer instantly"})})]}):(0,S.jsx)(b.A,{columns:he,dataSource:se,rowKey:"_id",pagination:!1,size:"small",scroll:{y:300},onRow:ge})})]})},re=l.memo(ae);var se=i(85192);const{Text:de}=r.A,ce=e=>{let{visible:t,onSelect:i,onCancel:n}=e;const[o,a]=(0,l.useState)(""),[r,s]=(0,l.useState)(""),[d,c]=(0,l.useState)(null),[u,m]=(0,l.useState)(-1),p=(0,l.useRef)(null),v=(0,l.useRef)(null),f=(0,l.useRef)(null),{data:_,isLoading:h}=w.lh.useGetVendorQuery({searchString:r},{skip:!t}),g=(0,l.useMemo)((()=>_&&(null===_||void 0===_?void 0:_.result)||[]),[_]),A=(0,l.useMemo)((()=>{if(!o.trim())return g;const e=o.toLowerCase();return g.filter((t=>{var i,n,l;return(null===(i=t.vendor_name)||void 0===i?void 0:i.toLowerCase().includes(e))||(null===(n=t.contact_number)||void 0===n?void 0:n.includes(e))||(null===(l=t.email)||void 0===l?void 0:l.toLowerCase().includes(e))}))}),[g,o]),j=(0,l.useCallback)((e=>({premium:"gold",wholesale:"blue",regular:"green"}[e||"regular"]||"green")),[]);(0,l.useEffect)((()=>(f.current&&clearTimeout(f.current),f.current=setTimeout((()=>{s(o)}),300),()=>{f.current&&clearTimeout(f.current)})),[o]);const k=(0,l.useCallback)((e=>{a(e),c(null),m(-1)}),[]);(0,l.useEffect)((()=>{t&&p.current&&setTimeout((()=>{var e,t;null===(e=p.current)||void 0===e||e.focus(),null===(t=p.current)||void 0===t||t.select()}),100)}),[t]),(0,l.useEffect)((()=>{t||(a(""),s(""),c(null),m(-1))}),[t]);const C=(0,l.useCallback)((e=>{if(0===A.length)return;let t=u;"up"===e?t=u<=0?A.length-1:u-1:"down"===e?t=u>=A.length-1?0:u+1:"first"===e?t=0:"last"===e&&(t=A.length-1),m(t),c(A[t]),setTimeout((()=>{const e=document.querySelector(".vendor-selection-table .ant-table-row-selected");e&&e.scrollIntoView({block:"nearest",behavior:"smooth"})}),0)}),[A,u]),I=(0,l.useCallback)((e=>{i(e),n()}),[i,n]),D=(0,l.useCallback)((e=>{"ArrowDown"===e.key?(e.preventDefault(),C("down")):"ArrowUp"===e.key?(e.preventDefault(),C("up")):"Home"===e.key?(e.preventDefault(),C("first")):"End"===e.key?(e.preventDefault(),C("last")):"Enter"===e.key&&d?(e.preventDefault(),I(d)):"Escape"===e.key&&(e.preventDefault(),n())}),[C,d,I,n]),T=(0,l.useMemo)((()=>[{title:"",key:"select",width:60,render:(e,t)=>(0,S.jsx)("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",width:"100%"},children:(0,S.jsx)("div",{style:{width:"24px",height:"24px",borderRadius:"50%",border:"2px solid #6366f1",backgroundColor:(null===d||void 0===d?void 0:d._id)===t._id?"#6366f1":"transparent",display:"flex",alignItems:"center",justifyContent:"center",transition:"all 0.2s ease"},children:(null===d||void 0===d?void 0:d._id)===t._id&&(0,S.jsx)("div",{style:{width:"8px",height:"8px",borderRadius:"50%",backgroundColor:"white"}})})})},{title:"Vendor Name",dataIndex:"vendor_name",key:"vendor_name",render:(e,t)=>(0,S.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:8},children:[(0,S.jsx)(se.A,{style:{color:"#6366f1"}}),(0,S.jsx)(de,{strong:!0,children:e}),t.vendor_type&&(0,S.jsx)(P.A,{color:j(t.vendor_type),children:t.vendor_type.toUpperCase()})]})},{title:"Contact Number",dataIndex:"contact_number",key:"contact_number",render:e=>(0,S.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:8},children:[(0,S.jsx)(W.A,{style:{color:"#666"}}),(0,S.jsx)(de,{children:e||"-"})]})},{title:"Email",dataIndex:"email",key:"email",render:e=>(0,S.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:8},children:[(0,S.jsx)(H.A,{style:{color:"#666"}}),(0,S.jsx)(de,{children:e||"-"})]})},{title:"Address",dataIndex:"address",key:"address",render:e=>(0,S.jsxs)("div",{style:{display:"flex",alignItems:"flex-start",gap:8},children:[(0,S.jsx)(X.A,{style:{color:"#666",marginTop:"2px"}}),(0,S.jsx)(de,{type:"secondary",style:{fontSize:"12px"},children:e||"-"})]})}]),[d,j]),N=(0,l.useCallback)(((e,t)=>({onClick:()=>{c(e),m(null!==t&&void 0!==t?t:-1)},onDoubleClick:()=>I(e),style:{cursor:"pointer",backgroundColor:(null===d||void 0===d?void 0:d._id)===e._id?"#f0f5ff":"transparent"},className:(null===d||void 0===d?void 0:d._id)===e._id?"ant-table-row-selected":""})),[d,I]),E=(0,l.useCallback)((()=>{c(null),m(-1)}),[]);return(0,S.jsxs)(y.A,{title:(0,S.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:8},children:[(0,S.jsx)(se.A,{style:{color:"#6366f1",fontSize:18}}),(0,S.jsx)("span",{children:"Select Vendor"})]}),open:t,onCancel:n,footer:null,width:1e3,style:{top:20},afterOpenChange:e=>{e&&p.current&&setTimeout((()=>{var e,t;null===(e=p.current)||void 0===e||e.focus(),null===(t=p.current)||void 0===t||t.select()}),100)},children:[(0,S.jsx)("div",{ref:v,style:{marginBottom:16},onKeyDown:D,tabIndex:0,children:(0,S.jsx)(x.A,{ref:p,placeholder:"Search vendors... (Click to highlight, Double-click or Enter to select)",value:o,onChange:e=>k(e.target.value),prefix:(0,S.jsx)(J.A,{}),style:{width:"100%"},onFocus:E,autoFocus:!0,suffix:o&&h?(0,S.jsx)("div",{style:{fontSize:"12px",color:"#999"},children:"Searching..."}):null})}),(0,S.jsx)("div",{style:{maxHeight:400,overflow:"auto"},children:h?(0,S.jsx)("div",{style:{textAlign:"center",padding:40},children:(0,S.jsx)(de,{children:"Loading vendors..."})}):0===A.length?(0,S.jsx)("div",{style:{textAlign:"center",padding:40},children:(0,S.jsx)(de,{type:"secondary",children:o?"No vendors found matching your search.":"No vendors available."})}):(0,S.jsx)(b.A,{columns:T,dataSource:A,rowKey:"_id",pagination:!1,size:"small",scroll:{y:300},onRow:N,className:"vendor-selection-table"})}),(0,S.jsx)("div",{style:{marginTop:16,padding:12,backgroundColor:"#f0f5ff",borderRadius:8,fontSize:"12px"},children:(0,S.jsxs)(de,{type:"secondary",children:[(0,S.jsx)("strong",{children:"Shortcuts:"})," Click to highlight \u2022 Double-click or Enter to select \u2022 \u2191\u2193 Navigate \u2022 Esc Close \u2022 Home/End First/Last"]})})]})},ue=l.memo(ce),{Title:me,Text:pe}=r.A,ve=e=>{let{visible:t,onSelect:i,onCancel:n}=e;const{data:o,isLoading:r}=w.lh.useGetBillingUsersQuery({}),s=(null===o||void 0===o?void 0:o.result)||o||{},d=null!==s&&void 0!==s&&s.items||null!==s&&void 0!==s&&s.result||Array.isArray(s)?s:[],[c,u]=(0,l.useState)(""),[m,p]=(0,l.useState)(null),[v,f]=(0,l.useState)(-1),_=(0,l.useMemo)((()=>(0,a.HW)()),[]),h=(0,l.useRef)(null),g=(0,l.useRef)(null),A=(0,l.useRef)(null),j=(0,l.useMemo)((()=>{if(!c.trim())return d;const e=c.toLowerCase();return d.filter((t=>{var i,n,l,o,a,r;return(null===(i=t.name)||void 0===i?void 0:i.toLowerCase().includes(e))||(null===(n=t.email)||void 0===n?void 0:n.toLowerCase().includes(e))||(null===(l=t.mobile)||void 0===l?void 0:l.toLowerCase().includes(e))||(null===(o=t.user_name)||void 0===o?void 0:o.toLowerCase().includes(e))||(null===(a=t.roleItems)||void 0===a||null===(r=a.name)||void 0===r?void 0:r.toLowerCase().includes(e))}))}),[d,c]),k=(0,l.useCallback)((e=>{if(0===j.length)return;let t;switch(e){case"up":t=-1===v?j.length-1:Math.max(v-1,0);break;case"down":t=-1===v?0:Math.min(v+1,j.length-1);break;case"home":t=0;break;case"end":t=j.length-1;break;default:return}f(t),p(j[t]),setTimeout((()=>{const i=document.querySelector('[data-row-key="'.concat(j[t]._id,'"]'));if(i){const t="home"===e?"start":"end"===e?"end":"nearest";i.scrollIntoView({behavior:"smooth",block:t})}}),100)}),[j,v]),C=(0,l.useCallback)((e=>{u(e),A.current&&clearTimeout(A.current)}),[]),I=(0,l.useCallback)((e=>{p(e),i(e),setTimeout((()=>n()),100)}),[i,n]),D=(0,l.useCallback)((e=>{if("Escape"===e.key)n();else if(["ArrowDown","ArrowUp","Home","End"].includes(e.key)){e.preventDefault(),e.stopPropagation();k({ArrowDown:"down",ArrowUp:"up",Home:"home",End:"end"}[e.key])}}),[k,n]),T=(0,l.useCallback)((e=>{if(!t)return;const i=e.target;if("INPUT"!==i.tagName&&"TEXTAREA"!==i.tagName&&!i.classList.contains("ant-select-selector")&&!i.closest(".ant-select-dropdown")){if(e.ctrlKey&&"f"===e.key)return e.preventDefault(),e.stopPropagation(),void(h.current&&(h.current.focus(),h.current.select()));if(["ArrowDown","ArrowUp","Home","End"].includes(e.key)){e.preventDefault(),e.stopPropagation();k({ArrowDown:"down",ArrowUp:"up",Home:"home",End:"end"}[e.key])}}}),[t,k]),N=(0,l.useMemo)((()=>[{title:"",key:"select",width:60,render:(e,t)=>(0,S.jsx)("div",{style:{cursor:"pointer",display:"flex",justifyContent:"center",alignItems:"center"},onClick:()=>{p(t);const e=j.findIndex((e=>e._id===t._id));f(e)},children:(0,S.jsx)("div",{style:{width:"18px",height:"18px",borderRadius:"50%",border:(null===m||void 0===m?void 0:m._id)===t._id?"2px solid #1890ff":"2px solid #d9d9d9",backgroundColor:(null===m||void 0===m?void 0:m._id)===t._id?"#1890ff":"white",display:"flex",alignItems:"center",justifyContent:"center",transition:"all 0.2s ease"},children:(null===m||void 0===m?void 0:m._id)===t._id&&(0,S.jsx)("div",{style:{width:"8px",height:"8px",borderRadius:"50%",backgroundColor:"white"}})})})},{title:"Name",dataIndex:"name",key:"name",render:(e,t)=>(0,S.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:8},children:[(0,S.jsx)(ee.A,{style:{color:"#1890ff"}}),(0,S.jsxs)("div",{children:[(0,S.jsx)(pe,{strong:!0,children:e}),(0,S.jsx)("br",{}),(0,S.jsxs)(pe,{type:"secondary",style:{fontSize:"12px"},children:["@",t.user_name]})]})]})},{title:"Role",key:"role",render:(e,t)=>{var i;return(0,S.jsx)(P.A,{color:"blue",children:(null===(i=t.roleItems)||void 0===i?void 0:i.name)||"No Role"})}},{title:"Mobile",dataIndex:"mobile",key:"mobile",render:e=>(0,S.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:8},children:[(0,S.jsx)(W.A,{style:{color:"#666"}}),(0,S.jsx)(pe,{children:e})]})},{title:"Email",dataIndex:"email",key:"email",render:e=>(0,S.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:8},children:[(0,S.jsx)(H.A,{style:{color:"#666"}}),(0,S.jsx)(pe,{children:e||"-"})]})},{title:"Branch",key:"branch",render:(e,t)=>{var i;return(0,S.jsx)(pe,{type:"secondary",style:{fontSize:"12px"},children:(null===(i=t.branchItems)||void 0===i?void 0:i.branch_name)||"-"})}}]),[m,j]),E=(0,l.useCallback)(((e,t)=>({onClick:()=>{p(e),f(null!==t&&void 0!==t?t:0)},style:{cursor:"pointer",backgroundColor:(null===m||void 0===m?void 0:m._id)===e._id?"#f0f8ff":"white",border:(null===m||void 0===m?void 0:m._id)===e._id?"2px solid #1890ff":"1px solid #f0f0f0",borderRadius:"4px",transition:"all 0.2s ease"},onMouseEnter:t=>{(null===m||void 0===m?void 0:m._id)!==e._id&&(t.currentTarget.style.backgroundColor="#f5f5f5")},onMouseLeave:t=>{(null===m||void 0===m?void 0:m._id)!==e._id&&(t.currentTarget.style.backgroundColor="white")}})),[m]);(0,l.useEffect)((()=>(t?(p(null),f(-1)):(u(""),p(null),f(-1),A.current&&(clearTimeout(A.current),A.current=null)),()=>{A.current&&clearTimeout(A.current)})),[t]),(0,l.useEffect)((()=>{if(t&&d.length>0&&null!==_&&void 0!==_&&_._id&&!m){const e=d.find((e=>e._id===_._id));if(e){p(e);const t=d.findIndex((e=>e._id===_._id));f(t),setTimeout((()=>{const t=document.querySelector('[data-row-key="'.concat(e._id,'"]'));t&&t.scrollIntoView({behavior:"smooth",block:"center"})}),200)}}}),[t,d,null===_||void 0===_?void 0:_._id,m]),(0,l.useEffect)((()=>{if(t&&h.current){const e=()=>{h.current&&(h.current.focus(),h.current.select())};e();const t=setTimeout(e,100);return()=>clearTimeout(t)}}),[t]),(0,l.useEffect)((()=>{if(t)return document.addEventListener("keydown",T,!0),()=>document.removeEventListener("keydown",T,!0)}),[t,T]);const B=(0,l.useCallback)((()=>{p(null),f(-1)}),[]);return(0,S.jsxs)(y.A,{title:"Select User (Billed By)",open:t,onCancel:n,footer:null,width:900,style:{top:20},afterOpenChange:e=>{e&&h.current&&setTimeout((()=>{var e,t;null===(e=h.current)||void 0===e||e.focus(),null===(t=h.current)||void 0===t||t.select()}),100)},children:[(0,S.jsx)("div",{ref:g,style:{marginBottom:16},onKeyDown:D,tabIndex:0,children:(0,S.jsx)(x.A,{ref:h,placeholder:"Search users... (\u2191\u2193: Navigate, Enter: Select, Esc: Close)",value:c,onChange:e=>C(e.target.value),prefix:(0,S.jsx)(J.A,{}),style:{width:"100%"},onKeyDown:e=>{"Enter"===e.key&&m&&I(m)},onFocus:B,autoFocus:!0,onBlur:()=>{t&&h.current&&setTimeout((()=>{t&&h.current&&h.current.focus()}),10)},suffix:c&&r?(0,S.jsx)("div",{style:{fontSize:"12px",color:"#999"},children:"Searching..."}):null})}),(0,S.jsx)("div",{style:{maxHeight:400,overflow:"auto"},children:r?(0,S.jsx)("div",{style:{textAlign:"center",padding:40},children:(0,S.jsx)(pe,{children:"Loading users..."})}):0===j.length?(0,S.jsx)("div",{style:{textAlign:"center",padding:40},children:(0,S.jsx)(pe,{type:"secondary",children:c?"No users found matching your search.":"No users available."})}):(0,S.jsx)(b.A,{columns:N,dataSource:j,rowKey:"_id",pagination:!1,size:"small",scroll:{y:300},onRow:E})})]})};var fe=i(6881),ye=i(76401);const{Title:xe,Text:_e}=r.A,he=e=>{let{visible:t,onNewBill:i,onContinueBill:n,onCancel:l,savedBillData:o}=e;return(0,S.jsxs)(y.A,{title:(0,S.jsxs)("div",{style:{textAlign:"center"},children:[(0,S.jsx)(B.A,{style:{color:"#52c41a",fontSize:"24px",marginRight:"8px"}}),(0,S.jsx)("span",{style:{color:"#52c41a",fontWeight:600},children:"Bill Saved Successfully!"})]}),open:t,onCancel:l,footer:null,width:500,centered:!0,maskClosable:!1,closable:!1,children:[(0,S.jsx)("div",{style:{textAlign:"center",marginBottom:"24px"},children:(0,S.jsx)(_e,{type:"secondary",children:"Your bill has been saved successfully. What would you like to do next?"})}),o&&(0,S.jsxs)("div",{style:{background:"linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)",border:"1px solid #0ea5e9",borderRadius:"8px",padding:"16px",marginBottom:"24px"},children:[(0,S.jsx)(xe,{level:5,style:{marginBottom:"12px",color:"#0369a1"},children:"\ud83d\udccb Bill Summary"}),(0,S.jsxs)("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"12px"},children:[(0,S.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[(0,S.jsx)(M.A,{style:{color:"#0ea5e9"}}),(0,S.jsxs)(_e,{strong:!0,children:["Invoice: ",o.invoice_no]})]}),(0,S.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[(0,S.jsx)(ee.A,{style:{color:"#0ea5e9"}}),(0,S.jsx)(_e,{strong:!0,children:o.customer_name||"N/A"})]}),(0,S.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[(0,S.jsx)(fe.A,{style:{color:"#0ea5e9"}}),(0,S.jsx)(_e,{strong:!0,children:f()(o.date).format("DD/MM/YYYY")})]}),(0,S.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[(0,S.jsx)(ye.A,{style:{color:"#0ea5e9"}}),(0,S.jsxs)(_e,{strong:!0,children:["\u20b9",("number"===typeof o.total_amount?o.total_amount:parseFloat(o.total_amount)||0).toFixed(2)]})]})]})]}),(0,S.jsx)(Q.A,{style:{margin:"20px 0"}}),(0,S.jsxs)(g.A,{direction:"vertical",size:"middle",style:{width:"100%"},children:[(0,S.jsx)(p.Ay,{type:"primary",size:"large",icon:(0,S.jsx)(A.A,{}),onClick:i,style:{width:"100%",height:"48px",background:"linear-gradient(135deg, #10b981 0%, #059669 100%)",border:"none",fontWeight:600,fontSize:"16px",borderRadius:"8px"},children:"\ud83c\udd95 Create New Bill"}),(0,S.jsx)(p.Ay,{size:"large",icon:(0,S.jsx)(M.A,{}),onClick:n,style:{width:"100%",height:"48px",background:"linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)",color:"white",border:"none",fontWeight:600,fontSize:"16px",borderRadius:"8px"},children:"\ud83d\udcdd Continue with Current Bill"})]}),(0,S.jsx)("div",{style:{textAlign:"center",marginTop:"16px"},children:(0,S.jsx)(_e,{type:"secondary",style:{fontSize:"12px"},children:'\ud83d\udca1 Tip: Use "New Bill" to start fresh or "Continue Bill" to add more items'})})]})};var ge=i(48677),be=i(98105),Ae=i(91686),je=i(99472),ke=i(54522),Ce=i(45964),we=i(61118);const{Title:Ie,Text:Se}=r.A,{Search:De}=x.A,Te=e=>{let{visible:t,onClose:i,onViewBill:n,onNewBill:o}=e;const{data:a,isLoading:r}=w.lh.useGetSalesRecordQuery({},{skip:!t}),s=(0,l.useMemo)((()=>(null===a||void 0===a?void 0:a.result)||[]),[a]),[c,u]=(0,l.useState)(""),[m,v]=(0,l.useState)("drafts"),y=(0,l.useMemo)((()=>{if(!s||!Array.isArray(s))return[];let e=s;if(e="drafts"===m?s.filter((e=>"draft"===e.status)):s.filter((e=>!e.status||"completed"===e.status)),!c)return e;const t=c.toLowerCase();return e.filter((e=>{var i;const n=e.invoice_no||"",l=(null===(i=e.customerDetails)||void 0===i?void 0:i.full_name)||"",o=e.date||"",a="number"===typeof e.total_amount?e.total_amount.toString():String(e.total_amount||"");return n.toLowerCase().includes(t)||l.toLowerCase().includes(t)||o.includes(c)||a.includes(c)}))}),[s,c,m]),x=(e,t)=>e&&!t?"Paid":t?"Partial":"Unpaid",_=e=>{n(e),i()},h=()=>{o(),i()};return(0,S.jsxs)(ge.A,{title:(0,S.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[(0,S.jsx)(Ie,{level:4,style:{margin:0,color:"#1f2937"},children:"\ud83d\udccb Bill List"}),(0,S.jsx)(p.Ay,{type:"text",icon:(0,S.jsx)($.A,{}),onClick:i,size:"small"})]}),placement:"left",open:t,onClose:i,width:400,bodyStyle:{padding:"16px"},headerStyle:{borderBottom:"1px solid #e5e7eb",padding:"16px 16px 12px 16px"},children:[(0,S.jsx)("div",{style:{marginBottom:"16px"},children:(0,S.jsxs)(g.A,{direction:"vertical",size:"middle",style:{width:"100%"},children:[(0,S.jsx)(De,{placeholder:"Search bills by invoice, customer, date...",value:c,onChange:e=>u(e.target.value),prefix:(0,S.jsx)(J.A,{}),allowClear:!0,size:"large"}),(0,S.jsx)(p.Ay,{type:"primary",icon:(0,S.jsx)(A.A,{}),onClick:h,style:{width:"100%",height:"40px",background:"linear-gradient(135deg, #10b981 0%, #059669 100%)",border:"none",fontWeight:600,borderRadius:"8px"},children:"\ud83c\udd95 Create New Bill"})]})}),(0,S.jsx)(Q.A,{style:{margin:"16px 0"}}),(0,S.jsx)(be.A,{activeKey:m,onChange:v,items:[{key:"drafts",label:(0,S.jsxs)("span",{children:["\ud83d\udcdd Drafts (",(null===s||void 0===s?void 0:s.filter((e=>"draft"===e.status)).length)||0,")"]})},{key:"completed",label:(0,S.jsxs)("span",{children:["\u2705 Completed (",(null===s||void 0===s?void 0:s.filter((e=>!e.status||"completed"===e.status)).length)||0,")"]})}],style:{marginBottom:16}}),(0,S.jsx)("div",{style:{height:"calc(100vh - 250px)",overflow:"auto"},children:r?(0,S.jsxs)("div",{style:{textAlign:"center",padding:"40px"},children:[(0,S.jsx)(Ae.A,{size:"large"}),(0,S.jsx)("div",{style:{marginTop:"16px"},children:(0,S.jsx)(Se,{type:"secondary",children:"Loading bills..."})})]}):0===y.length?(0,S.jsx)(je.A,{description:(0,S.jsxs)("div",{children:[(0,S.jsx)(Se,{type:"secondary",children:c?"No bills found matching your search.":"No bills available."}),!c&&(0,S.jsx)("div",{style:{marginTop:"8px"},children:(0,S.jsx)(p.Ay,{type:"link",onClick:h,children:"Create your first bill"})})]}),style:{marginTop:"40px"}}):(0,S.jsx)(ke.A,{dataSource:y,renderItem:e=>{var t,i,n;return(0,S.jsx)(ke.A.Item,{style:{padding:"16px",border:"1px solid #e5e7eb",borderRadius:"8px",marginBottom:"12px",background:"white",cursor:"pointer",transition:"all 0.2s ease"},onMouseEnter:e=>{e.currentTarget.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.1)",e.currentTarget.style.transform="translateY(-2px)"},onMouseLeave:e=>{e.currentTarget.style.boxShadow="none",e.currentTarget.style.transform="translateY(0)"},onClick:()=>_(e),children:(0,S.jsxs)("div",{style:{width:"100%"},children:[(0,S.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"8px"},children:[(0,S.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[(0,S.jsx)(Ce.A,{icon:(0,S.jsx)(M.A,{}),style:{background:"linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)",color:"white"}}),(0,S.jsx)(Se,{strong:!0,style:{fontSize:"14px"},children:e.invoice_no})]}),(0,S.jsxs)(g.A,{children:["draft"===e.status?(0,S.jsx)(P.A,{color:"orange",children:"DRAFT"}):(0,S.jsx)(P.A,{color:"green",children:"COMPLETED"}),(0,S.jsx)(P.A,{color:(i=e.is_paid,n=e.is_partially_paid,i&&!n?"success":n?"warning":"error"),children:x(e.is_paid,e.is_partially_paid)})]})]}),(0,S.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"6px"},children:[(0,S.jsx)(ee.A,{style:{color:"#6b7280",fontSize:"12px"}}),(0,S.jsx)(Se,{style:{fontSize:"12px",color:"#374151"},children:(null===(t=e.customerDetails)||void 0===t?void 0:t.full_name)||e.customer_name||"N/A"})]}),(0,S.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,S.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[(0,S.jsx)(fe.A,{style:{color:"#6b7280",fontSize:"12px"}}),(0,S.jsx)(Se,{style:{fontSize:"12px",color:"#6b7280"},children:e.date?f()(e.date).format("DD/MM/YYYY"):"N/A"})]}),(0,S.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[(0,S.jsx)(ye.A,{style:{color:"#10b981",fontSize:"12px"}}),(0,S.jsxs)(Se,{strong:!0,style:{fontSize:"14px",color:"#10b981"},children:["\u20b9",("number"===typeof e.total_amount?e.total_amount:parseFloat(e.total_amount)||0).toFixed(2)]})]})]}),(0,S.jsxs)("div",{style:{display:"flex",gap:"8px",marginTop:"12px",justifyContent:"flex-end"},children:[(0,S.jsx)(d.A,{title:"View Bill",children:(0,S.jsx)(p.Ay,{type:"text",icon:(0,S.jsx)(we.A,{}),size:"small",onClick:t=>{t.stopPropagation(),_(e)},style:{color:"#3b82f6"}})}),"draft"!==e.status&&(0,S.jsx)(d.A,{title:"Print Bill",children:(0,S.jsx)(p.Ay,{type:"text",icon:(0,S.jsx)(F.A,{}),size:"small",onClick:e=>{e.stopPropagation()},style:{color:"#10b981"}})})]})]})})},pagination:!1})}),(0,S.jsx)("div",{style:{position:"absolute",bottom:0,left:0,right:0,padding:"16px",background:"white",borderTop:"1px solid #e5e7eb"},children:(0,S.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,S.jsxs)(Se,{type:"secondary",style:{fontSize:"12px"},children:["Total Bills: ",y.length]}),(0,S.jsx)(Se,{type:"secondary",style:{fontSize:"12px"},children:"\ud83d\udca1 Click on any bill to view details"})]})})]})};var Pe=i(20691);const{Title:Ne,Text:Ee}=r.A,Be=e=>{var t,i,n,o,a,r,s;let{visible:d,onCancel:c,productId:u}=e;const{data:m,isLoading:p}=w.lh.useGetProductQuery({}),v=(null===m||void 0===m?void 0:m.result)||[],[f,x]=(0,l.useState)(null);(0,l.useEffect)((()=>{if(d&&u&&v&&Array.isArray(v)){const e=v.find((e=>e._id===u));e&&x(e)}}),[d,u,v]);const _=()=>{x(null),c()};return f?(0,S.jsx)(y.A,{title:(0,S.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[(0,S.jsx)("span",{children:"\ud83d\udce6 Product Details"}),(0,S.jsx)(P.A,{color:"blue",style:{margin:0},children:f.sku})]}),open:d,onCancel:_,footer:null,width:700,destroyOnClose:!0,children:(0,S.jsxs)("div",{style:{padding:"16px 0"},children:[(0,S.jsxs)("div",{style:{marginBottom:"24px"},children:[(0,S.jsx)(Ne,{level:4,style:{margin:"0 0 8px 0",color:"#1890ff"},children:f.name}),(null===(t=f.VariantItem)||void 0===t?void 0:t.variant_name)&&(0,S.jsxs)(P.A,{color:"green",style:{fontSize:"12px"},children:["Variant: ",f.VariantItem.variant_name]})]}),(0,S.jsx)(Q.A,{style:{margin:"16px 0"}}),(0,S.jsxs)(Pe.A,{title:"Product Information",column:2,size:"small",bordered:!0,style:{marginBottom:"24px"},children:[(0,S.jsx)(Pe.A.Item,{label:"Product Name",span:2,children:(0,S.jsx)(Ee,{strong:!0,children:f.name})}),(null===(i=f.VariantItem)||void 0===i?void 0:i.variant_name)&&(0,S.jsx)(Pe.A.Item,{label:"Variant Name",children:(0,S.jsx)(Ee,{children:f.VariantItem.variant_name})}),(null===(n=f.VariantItem)||void 0===n?void 0:n.variant_code)&&(0,S.jsx)(Pe.A.Item,{label:"Variant Code",children:(0,S.jsx)(Ee,{code:!0,children:f.VariantItem.variant_code})}),(0,S.jsx)(Pe.A.Item,{label:"SKU",children:(0,S.jsx)(Ee,{code:!0,children:f.sku})}),f.brand&&(0,S.jsx)(Pe.A.Item,{label:"Brand",children:(0,S.jsx)(Ee,{children:f.brand})}),f.unit&&(0,S.jsx)(Pe.A.Item,{label:"Unit",children:(0,S.jsx)(Ee,{children:f.unit})}),f.description&&(0,S.jsx)(Pe.A.Item,{label:"Description",span:2,children:(0,S.jsx)(Ee,{children:f.description})})]}),(0,S.jsxs)(Pe.A,{title:"Pricing & Tax",column:2,size:"small",bordered:!0,style:{marginBottom:"24px"},children:[(0,S.jsx)(Pe.A.Item,{label:"Selling Price",children:(0,S.jsxs)(Ee,{strong:!0,style:{color:"#52c41a",fontSize:"16px"},children:["\u20b9",(null===(o=f.selling_price)||void 0===o?void 0:o.toFixed(2))||"0.00"]})}),(0,S.jsx)(Pe.A.Item,{label:"MRP",children:(0,S.jsxs)(Ee,{style:{color:"#fa8c16"},children:["\u20b9",(null===(a=f.mrp)||void 0===a?void 0:a.toFixed(2))||"0.00"]})}),(null===(r=f.CategoryItem)||void 0===r?void 0:r.name)&&(0,S.jsx)(Pe.A.Item,{label:"Category",children:(0,S.jsx)(Ee,{children:f.CategoryItem.name})}),void 0!==(null===(s=f.CategoryItem)||void 0===s?void 0:s.tax_percentage)&&(0,S.jsx)(Pe.A.Item,{label:"Tax Rate",children:(0,S.jsxs)(P.A,{color:"orange",children:[f.CategoryItem.tax_percentage,"%"]})})]}),(void 0!==f.min_stock||void 0!==f.max_stock)&&(0,S.jsxs)(Pe.A,{title:"Stock Information",column:2,size:"small",bordered:!0,children:[void 0!==f.min_stock&&(0,S.jsx)(Pe.A.Item,{label:"Minimum Stock",children:(0,S.jsx)(Ee,{children:f.min_stock})}),void 0!==f.max_stock&&(0,S.jsx)(Pe.A.Item,{label:"Maximum Stock",children:(0,S.jsx)(Ee,{children:f.max_stock})})]}),(0,S.jsx)("div",{style:{marginTop:"24px",padding:"16px",backgroundColor:"#f6f8fa",borderRadius:"8px",textAlign:"center"},children:(0,S.jsx)(Ee,{type:"secondary",style:{fontSize:"12px"},children:"Right-click on product field to view details \u2022 Press ESC to close"})})]})}):(0,S.jsx)(y.A,{title:"Product Details",open:d,onCancel:_,footer:null,width:600,destroyOnClose:!0,children:(0,S.jsx)("div",{style:{textAlign:"center",padding:"40px 20px"},children:p?(0,S.jsx)(Ee,{children:"Loading product details..."}):(0,S.jsx)(Ee,{type:"secondary",children:"Product not found"})})})},Le=e=>{let{value:t,onChange:i}=e;return(0,S.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:8,background:"#fff",padding:"6px 12px",borderRadius:10,boxShadow:"0 2px 6px rgba(0,0,0,0.08)"},children:[(0,S.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:6},children:[(0,S.jsx)(M.A,{style:{fontSize:15,color:"#667eea"}}),(0,S.jsx)("span",{style:{fontWeight:600,fontSize:12,color:"#333"},children:"PRINT TYPE"})]}),(0,S.jsxs)("div",{onClick:()=>i("bill"===t?"invoice":"bill"),style:{position:"relative",width:100,height:30,borderRadius:16,background:"bill"===t?"linear-gradient(135deg, #667eea 0%, #764ba2 100%)":"linear-gradient(135deg, #f093fb 0%, #f5576c 100%)",cursor:"pointer",transition:"all 0.3s ease",boxShadow:"0 2px 6px rgba(0,0,0,0.15)",display:"flex",alignItems:"center",justifyContent:"bill"===t?"flex-start":"flex-end",padding:"0 3px"},children:[(0,S.jsx)("div",{style:{width:24,height:24,borderRadius:"50%",background:"#fff",boxShadow:"0 2px 4px rgba(0,0,0,0.2)",transition:"all 0.3s ease"}}),(0,S.jsx)("div",{style:{position:"absolute",left:"bill"===t?32:"auto",right:"invoice"===t?32:"auto",color:"#fff",fontWeight:"bold",fontSize:10,letterSpacing:.5,userSelect:"none"},children:"bill"===t?"BILL":"INVOICE"})]})]})};var qe=i(30746);const Re="BillDataGrid_mainContainer__Jnuo1",Ge="BillDataGrid_backgroundCircle1__5PBPG",ze="BillDataGrid_backgroundCircle2__J+xMs",Me="BillDataGrid_backgroundCircle3__AgoEw",Ve="BillDataGrid_backgroundCircle4__86Xfd",Fe="BillDataGrid_backgroundCircle5__qpbiT",Ye="BillDataGrid_headerContainer__wfojf",Ue="BillDataGrid_headerCircle1__8+aPI",Ke="BillDataGrid_headerCircle2__Z9w17",Oe="BillDataGrid_headerCircle3__3eMNm",Qe="BillDataGrid_headerCircle4__fVITr",We="BillDataGrid_headerCircle5__0E6vl",He="BillDataGrid_headerContent__6Rnkr",Xe="BillDataGrid_titleSection__LBuxT",Je="BillDataGrid_titleIcon__qffZU",Ze="BillDataGrid_titleText__XlvSS",$e="BillDataGrid_subtitleText__Hgyav",et="BillDataGrid_controlsSection__PSC3w",tt="BillDataGrid_controlGroup__AFGBT",it="BillDataGrid_saleTypeControl__hzHpa",nt="BillDataGrid_gstControl__AiGdY",lt="BillDataGrid_paymentControl__BD0r9",ot="BillDataGrid_partialPaymentControl__unngo",at="BillDataGrid_controlLabel__QP4fP",rt="BillDataGrid_badgesContainer__bqqSt",st="BillDataGrid_itemsBadge__o0Uro",dt="BillDataGrid_amountBadge__IPSqT",ct="BillDataGrid_badgeText__9cTal",ut="BillDataGrid_invoiceDetailsGrid__QPpaj",mt="BillDataGrid_itemsSection__vJE1b",pt="BillDataGrid_itemsCircle1__PQoMB",vt="BillDataGrid_itemsCircle2__0lWcR",ft="BillDataGrid_billItemsGrid__jpWQo",yt="BillDataGrid_billItemsHeader__hxL0O",xt="BillDataGrid_billItemsTitle__MQduV",_t="BillDataGrid_billItemsBadge__vdJMk",ht="BillDataGrid_billSummary__yA4j-",gt="BillDataGrid_summaryCircle1__PuveY",bt="BillDataGrid_summaryCircle2__fdcks",At="BillDataGrid_summaryHeader__h1BtQ",jt="BillDataGrid_summaryTitle__dSOoP",kt="BillDataGrid_summaryRow__yUShR",Ct="BillDataGrid_summaryLabel__cLnHd",wt="BillDataGrid_summaryValue__LUh-6",It="BillDataGrid_summaryTable__ZpVlt",St="BillDataGrid_totalAmountRow__JXMuL",Dt="BillDataGrid_totalAmountLabel__IVRMe",Tt="BillDataGrid_totalAmountValue__5W5mL",Pt="BillDataGrid_discountValue__QjPij",Nt="BillDataGrid_partialPaymentInfo__OpO+-",Et="BillDataGrid_partialPaymentRow__Qy-Ni",Bt="BillDataGrid_partialPaymentLabel__yEvTO",Lt="BillDataGrid_partialPaymentValue__SLg8d",qt="BillDataGrid_controlsContainer__2jCRg",Rt="BillDataGrid_discountControl__n0WOI",Gt="BillDataGrid_discountControlLabel__0iwJ9",zt="BillDataGrid_discountControlInputs__TbgUU",Mt="BillDataGrid_partialPaymentControlLabel__lxP98",Vt="BillDataGrid_actionHub__SlPSg",Ft="BillDataGrid_actionButtonsContainer__BcfKu",Yt="BillDataGrid_actionHubCircle1__ggNzA",Ut="BillDataGrid_actionHubCircle2__Nb-oj",Kt="BillDataGrid_actionHubCircle3__D2pna",Ot="BillDataGrid_actionHubCircle4__ayVXK",Qt="BillDataGrid_saveButton__vWggk",Wt="BillDataGrid_billListButton__ahHFc",Ht="BillDataGrid_printButton__nkIDd",Xt="BillDataGrid_clearButton__518xA",Jt="BillDataGrid_saleTypeSwitch__Xa4gR",Zt="BillDataGrid_gstSwitch__ZQG0t",$t="BillDataGrid_paymentSwitch__KxB-J",ei="BillDataGrid_partialPaymentSwitch__5nNFs",{Title:ti,Text:ii}=r.A,ni=e=>{var t,i;let{billdata:r,onSuccess:v}=e;const y=(0,o.wA)(),x=(0,z.Ib)("Product"),_=(0,z.Ib)("Customer"),h=(0,z.Ib)("Vendor"),g=(0,z.Ib)("BillingUsers"),b=(0,z.Ib)("SalesRecord"),A=(0,z.Ib)("InvoiceNumber"),j=(0,a.HW)(),C=null===j||void 0===j?void 0:j.branch_id,I=(null===j||void 0===j?void 0:j.organisation_id)||(null===j||void 0===j||null===(t=j.organisationItems)||void 0===t?void 0:t._id),{data:D}=w.lh.useGetOrganisationsQuery({organisation_id:I},{skip:!I}),P=(0,l.useMemo)((()=>{const e=null===D||void 0===D?void 0:D.result;return Array.isArray(e)?e[0]:e||(null===j||void 0===j?void 0:j.organisationItems)||{}}),[D,j]),N=(0,l.useMemo)((()=>(null===j||void 0===j?void 0:j.branchItems)||{}),[j]),{data:E,isLoading:B,refetch:L}=x.useGetAll(),{data:R,isLoading:Y,refetch:U}=_.useGetAll(),{data:K,isLoading:O,refetch:Q}=h.useGetAll(),{data:W,isLoading:H,refetch:X}=g.useGetAll(),{data:J,isLoading:Z,refetch:$}=w.lh.useGetStockAuditQuery({},{skip:!r||!!C}),{data:ee,isLoading:te,refetch:ie}=w.lh.useGetBranchStockQuery({},{skip:!r||!C}),{data:ne,refetch:le}=A.useGetAll(),oe=E||{},ae=R||{},se=K||{},de=W||{},ce=J||{},me=ee||{},pe=ne||{},fe=Array.isArray(oe.result)?oe.result:[],ye=Array.isArray(ae.result)?ae.result:[],xe=Array.isArray(null===se||void 0===se?void 0:se.result)?se.result:[],_e=Array.isArray(de.result)?de.result:[],ge=Array.isArray(null===ce||void 0===ce?void 0:ce.result)?ce.result:[],be=Array.isArray(null===me||void 0===me?void 0:me.result)?me.result:[],{create:Ae,isLoading:je}=b.useCreate(),{update:ke,isLoading:Ce}=b.useUpdate(),{create:we,isLoading:Ie}=A.useCreate(),[Se,De]=(0,l.useState)(null),[Pe,Ne]=(0,l.useState)(null),[Ee,ni]=((0,l.useCallback)(((e,t)=>{var i;if(!e||null===t||void 0===t||null===(i=t.VariantItem)||void 0===i||!i.pack_size)return{isValid:!0,expectedLoose:0,totalAvailable:0};const n=parseInt(t.VariantItem.pack_size),l=e.available_quantity||0,o=e.available_loose_quantity||0;return{isValid:!0,expectedLoose:o,totalAvailable:l*n+o}}),[]),(0,l.useState)({invoice_no:"",date:f()().format("YYYY-MM-DD"),customer_id:"",customer_name:"",billed_by_id:"",billed_by_name:"",payment_mode:"cash",items:[]})),[li,oi]=(0,l.useState)({isPaid:!0,isPartiallyPaid:!1,isRetail:!0,isGstIncluded:!0,discount:0,discountType:"percentage",paidAmount:0}),[ai,ri]=(0,l.useState)(null),[si,di]=(0,l.useState)(null),[ci,ui]=(0,l.useState)(!1),[mi,pi]=(0,l.useState)(!1),[vi,fi]=(0,l.useState)(!1),[yi,xi]=(0,l.useState)(!1),[_i,hi]=(0,l.useState)(null),[gi,bi]=(0,l.useState)(!1),[Ai,ji]=(0,l.useState)(""),[ki,Ci]=(0,l.useState)(!1),[wi,Ii]=(0,l.useState)(null),[Si,Di]=(0,l.useState)(0),{data:Ti}=w.lh.useGetSettingsQuery({organisation_id:I,page:1,limit:1},{skip:!I,refetchOnMountOrArgChange:!1}),Pi=(0,l.useMemo)((()=>{const e=(null===Ti||void 0===Ti?void 0:Ti.result)||Ti||{};return Array.isArray(e)?e[0]:e}),[Ti]),[Ni,Ei]=(0,l.useState)("bill"),{printDocument:Bi}=(0,qe.y)();(0,l.useEffect)((()=>{!r&&null!==Pi&&void 0!==Pi&&Pi.default_document_type&&Ei(Pi.default_document_type)}),[null===Pi||void 0===Pi?void 0:Pi.default_document_type,r]);const Li=(e,t,i)=>{var n,l;const o=(C?be:ge).find((t=>t._id===e));if(!o)return{isValid:!1,availablePackQty:0,maxLooseQty:0,message:"Stock not found"};const a=null===o||void 0===o||null===(n=o.ProductItem)||void 0===n||null===(l=n.VariantItem)||void 0===l?void 0:l.pack_size,r=a?parseInt(a):1,s=o.available_quantity||0,d=o.available_loose_quantity||0;if(t>s)return{isValid:!1,availablePackQty:s,maxLooseQty:0,message:"Pack quantity (".concat(t,") exceeds available packs (").concat(s,")")};const c=s-t,u=c*r+d;return i>u?{isValid:!1,availablePackQty:s,maxLooseQty:u,message:"Loose quantity (".concat(i,") exceeds available loose items (").concat(u," = ").concat(c," remaining packs \xd7 ").concat(r," + ").concat(d," loose)")}:{isValid:!0,availablePackQty:s,maxLooseQty:u,message:""}},qi=(0,l.useCallback)(((e,t,i)=>{const l=[...Ee.items],o=l[e];if(!o.stock_id)return l[e]=(0,n.A)((0,n.A)({},o),{},{[t]:i}),void ni((e=>(0,n.A)((0,n.A)({},e),{},{items:l})));const a="qty"===t?i:o.qty||0,r="loose_qty"===t?i:o.loose_qty||0,d=Li(o.stock_id,a,r);d.isValid?l[e]=(0,n.A)((0,n.A)({},o),{},{[t]:i}):(s.Ay.error(d.message),"qty"===t&&a>d.availablePackQty?l[e]=(0,n.A)((0,n.A)({},o),{},{qty:d.availablePackQty}):"loose_qty"===t&&r>d.maxLooseQty&&(l[e]=(0,n.A)((0,n.A)({},o),{},{loose_qty:d.maxLooseQty}))),ni((e=>(0,n.A)((0,n.A)({},e),{},{items:l})))}),[Ee.items,Li]);(0,l.useEffect)((()=>{if(fe.length||L(),ye.length||U(),xe.length||Q(),_e.length||X(),r||Ie||Ee.invoice_no||le(),r){var e,t,i,n,l,o,a,s;const d="invoice"===r.document_type,c=d?r.vendorDetails:r.customerDetails,u=d?r.vendor_id:r.customer_id,m=(null===c||void 0===c?void 0:c.vendor_name)||(null===c||void 0===c?void 0:c.full_name)||(null===c||void 0===c?void 0:c.name)||"";ni({invoice_no:r.invoice_no,date:f()(r.date).format("YYYY-MM-DD"),customer_id:u,customer_name:m,billed_by_id:r.billed_by_id||"",billed_by_name:(null===(e=r.billedByDetails)||void 0===e?void 0:e.name)||"",payment_mode:r.payment_mode,items:(null===(t=r.Items)||void 0===t?void 0:t.map((e=>{var t,i,n;return{_id:e._id,product_id:e.product_id,product_name:(null===(t=e.productItems)||void 0===t?void 0:t.name)||"",variant_name:(null===(i=e.productItems)||void 0===i||null===(n=i.VariantItem)||void 0===n?void 0:n.variant_name)||"",stock_id:C?e.branch_stock_id:e.stock_id,qty:e.qty||0,loose_qty:e.loose_qty||0,price:e.price,mrp:e.mrp||e.price,amount:e.amount,tax_percentage:e.tax_percentage||0}})))||[]}),oi({isPaid:null===(i=r.is_paid)||void 0===i||i,isPartiallyPaid:null!==(n=r.is_partially_paid)&&void 0!==n&&n,isRetail:"retail"===r.sale_type,isGstIncluded:null===(l=r.is_gst_included)||void 0===l||l,discount:null!==(o=r.discount)&&void 0!==o?o:0,discountType:null!==(a=r.discount_type)&&void 0!==a?a:"percentage",paidAmount:null!==(s=r.paid_amount)&&void 0!==s?s:0}),Ei(r.document_type||"bill")}}),[r]),(0,l.useEffect)((()=>{var e;null!==pe&&void 0!==pe&&null!==(e=pe.result)&&void 0!==e&&e.invoice_no&&!r&&ni((e=>(0,n.A)((0,n.A)({},e),{},{invoice_no:pe.result.invoice_no})))}),[pe,r]),(0,l.useEffect)((()=>{if(!r&&0===Ee.items.length){const e=Array(1).fill(null).map(((e,t)=>({product_id:"",product_name:"",variant_name:"",stock_id:"",batch_no:"",qty:0,loose_qty:0,price:0,mrp:0,amount:0,tax_percentage:0})));ni((t=>(0,n.A)((0,n.A)({},t),{},{items:e})))}}),[r,Ee.items.length]),(0,l.useEffect)((()=>{if(!r&&_e&&null!==j&&void 0!==j&&j._id&&!Ee.billed_by_id){const e=_e.find((e=>e._id===j._id));e&&ni((t=>(0,n.A)((0,n.A)({},t),{},{billed_by_id:j._id,billed_by_name:e.name||j.name||""})))}}),[_e,null===j||void 0===j?void 0:j._id,r,Ee.billed_by_id]);const Ri=(0,l.useMemo)((()=>fe.map((e=>{var t;return{label:"".concat(e.name," ").concat((null===e||void 0===e||null===(t=e.VariantItem)||void 0===t?void 0:t.variant_name)||"").trim(),value:e._id}}))),[fe]),Gi=(0,l.useMemo)((()=>ye.map((e=>({label:"".concat(e.full_name," - ").concat(e.mobile),value:e._id})))),[ye]),zi=(0,l.useMemo)((()=>xe.map((e=>({label:"".concat(e.vendor_name," - ").concat(e.contact_number||"N/A"),value:e._id})))),[xe]),Mi=(0,l.useMemo)((()=>"invoice"===Ni?zi:Gi),[Ni,zi,Gi]),Vi=(0,l.useMemo)((()=>{const e=_e.map((e=>{var t;return{label:"".concat(e.name," (").concat((null===(t=e.roleItems)||void 0===t?void 0:t.name)||"No Role",")"),value:e._id}}));return e}),[_e]),Fi=(0,l.useMemo)((()=>[{key:"invoice_no",title:"\ud83d\udcc4 INVOICE #",dataIndex:"invoice_no",type:"text",required:!0,width:180},{key:"date",title:"\ud83d\udcc5 DATE",dataIndex:"date",type:"date",required:!0,width:150},{key:"customer_id",title:"bill"===Ni?"\ud83d\udc64 CUSTOMER":"\ud83c\udfe2 VENDOR",dataIndex:"customer_id",type:"select",options:Mi,required:!0,width:250,render:(e,t)=>{const i=Mi.find((t=>t.value===e)),n="invoice"===Ni,l=n?"Select vendor":"Select customer",o=n?"Click to open vendor selection modal (or press End key)":"Click to open customer selection modal (or press End key)";return(0,S.jsx)(d.A,{title:o,children:(0,S.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",cursor:"pointer",padding:"4px 8px",borderRadius:"4px",border:"1px solid #d9d9d9",backgroundColor:"#fafafa",transition:"all 0.2s ease"},onClick:()=>ui(!0),onMouseEnter:e=>{e.currentTarget.style.backgroundColor="#f0f0f0",e.currentTarget.style.borderColor="#1890ff"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="#fafafa",e.currentTarget.style.borderColor="#d9d9d9"},children:[(0,S.jsx)("span",{children:i?i.label:l}),(0,S.jsx)("span",{style:{fontSize:"10px",color:"#1890ff",backgroundColor:"#f0f8ff",padding:"2px 6px",borderRadius:"4px",border:"1px solid #d6e4ff"},children:"End"})]})})}},{key:"billed_by_id",title:"\ud83d\udc68\u200d\ud83d\udcbc BILLED BY",dataIndex:"billed_by_id",type:"select",options:Vi,required:!1,width:250,render:(e,t)=>{const i=Vi.find((t=>t.value===e));return(0,S.jsx)(d.A,{title:"Click to open user selection modal (or press Ctrl+U key)",children:(0,S.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",cursor:"pointer",padding:"4px 8px",borderRadius:"4px",border:"1px solid #d9d9d9",backgroundColor:"#f0f8ff",transition:"all 0.2s ease"},onClick:()=>pi(!0),onMouseEnter:e=>{e.currentTarget.style.backgroundColor="#e6f7ff",e.currentTarget.style.borderColor="#1890ff"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="#f0f8ff",e.currentTarget.style.borderColor="#d9d9d9"},children:[(0,S.jsx)("span",{children:i?i.label:"Select user"}),(0,S.jsx)("span",{style:{fontSize:"10px",color:"#1890ff",backgroundColor:"#ffffff",padding:"2px 6px",borderRadius:"4px",border:"1px solid #d6e4ff"},children:"Ctrl+U"})]})})}},{key:"payment_mode",title:"\ud83d\udcb3 PAYMENT",dataIndex:"payment_mode",type:"select",options:[{label:"\ud83d\udcb5 Cash",value:"cash"},{label:"\ud83d\udcf1 UPI",value:"upi"},{label:"\ud83d\udcb3 Card",value:"card"}],required:!0,width:150}]),[Mi,Vi,Ni]),Yi=(0,l.useMemo)((()=>[{invoice_no:Ee.invoice_no,date:Ee.date,customer_id:Ee.customer_id,billed_by_id:Ee.billed_by_id,payment_mode:Ee.payment_mode}]),[Ee.invoice_no,Ee.date,Ee.customer_id,Ee.billed_by_id,Ee.payment_mode]),Ui=(0,l.useMemo)((()=>[{key:"product_id",title:"\ud83d\uded2 PRODUCT",dataIndex:"product_id",type:"product",required:!0,width:280,render:(e,t,i)=>{const n=Ri.find((t=>t.value===e)),l=e?(null===n||void 0===n?void 0:n.label)||(t.product_name?"".concat(t.product_name).concat(t.variant_name?" ".concat(t.variant_name):"").trim():"Unknown Product"):"Select product";return(0,S.jsx)(d.A,{title:e?"Product: ".concat(l," - Click to change \u2022 F5 to reopen"):"Click to select product from inventory \u2022 F5 to open",placement:"top",children:(0,S.jsxs)("div",{style:{cursor:"pointer",padding:"4px 8px",borderRadius:"4px",border:e?"1px solid #52c41a":"1px solid #d9d9d9",backgroundColor:e?"#f6ffed":"#fafafa",transition:"all 0.2s ease",minHeight:"32px",display:"flex",alignItems:"center",justifyContent:"space-between"},onClick:()=>{"number"===typeof i&&(Ii(i),Di(i),Ci(!0))},onMouseEnter:e=>{e.currentTarget.style.backgroundColor="#f0f0f0",e.currentTarget.style.borderColor="#1890ff"},onMouseLeave:t=>{t.currentTarget.style.backgroundColor=e?"#f6ffed":"#fafafa",t.currentTarget.style.borderColor=e?"#52c41a":"#d9d9d9"},children:[(0,S.jsx)("span",{style:{color:e?"#52c41a":"#1890ff",fontWeight:e?600:400},children:l}),e&&(0,S.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:[(0,S.jsx)("span",{style:{fontSize:"12px",color:"#52c41a"},children:"\u2705"}),(0,S.jsx)("span",{style:{fontSize:"10px",color:"#52c41a",backgroundColor:"#f6ffed",padding:"2px 4px",borderRadius:"3px"},children:"Selected"})]}),!e&&(0,S.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"4px",marginTop:"2px"},children:[(0,S.jsx)("span",{style:{fontSize:"10px",color:"#ff4d4f"},children:"\u26a0\ufe0f Product required"}),(0,S.jsx)("span",{style:{fontSize:"10px",color:"#1890ff",backgroundColor:"#f0f8ff",padding:"2px 4px",borderRadius:"3px"},children:"Click"})]})]})})}},{key:"stock_id",title:"\ud83d\udce6 STOCK",dataIndex:"batch_no",type:"stock",required:!0,width:280,editable:!0,render:(e,t,i)=>{const n=t.stockData,l=(null===n||void 0===n?void 0:n.available_quantity)||0,o=(null===n||void 0===n?void 0:n.available_loose_quantity)||0,a=(null===n||void 0===n?void 0:n.pack_size)||1,r=l>0&&l<=10,c=0===l,u=!!n;return(0,S.jsx)(d.A,{title:t.product_id?e?"Stock: ".concat(e," - Packs Available: ").concat(l," \u2022 Loose Available: ").concat(o," \u2022 Pack Size: ").concat(a," \u2022 Click to change \u2022 F7 to reopen"):"Click to select stock from available inventory \u2022 F7 to open":"Please select a product first to choose stock \u2022 F7 to open after product selection",placement:"top",children:(0,S.jsxs)("div",{style:{cursor:"pointer",padding:"6px 10px",borderRadius:"6px",border:e?"1px solid #52c41a":"1px solid #d9d9d9",backgroundColor:e?"#f6ffed":"#fafafa",transition:"all 0.2s ease",minHeight:"32px",display:"flex",alignItems:"center",justifyContent:"space-between",width:"100%",gap:"10px"},onClick:()=>{t.product_id&&"number"===typeof i?ri(i):t.product_id||s.Ay.warning("Please select a product first")},onMouseEnter:e=>{e.currentTarget.style.backgroundColor="#f0f0f0",e.currentTarget.style.borderColor="#1890ff"},onMouseLeave:t=>{t.currentTarget.style.backgroundColor=e?"#f6ffed":"#fafafa",t.currentTarget.style.borderColor=e?"#52c41a":"#d9d9d9"},children:[(0,S.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"6px",flex:1,flexWrap:"wrap"},children:[(0,S.jsx)("span",{style:{color:e?"#52c41a":t.product_id?"#1890ff":"#bfbfbf",fontWeight:e?700:400,fontSize:"12px",whiteSpace:"nowrap"},children:e?"\ud83c\udff7\ufe0f ".concat(e):"Select Stock"}),u&&e&&(0,S.jsxs)(S.Fragment,{children:[(0,S.jsx)("span",{style:{color:"#d9d9d9",fontSize:"12px"},children:"|"}),(0,S.jsxs)("span",{style:{color:c?"#ff4d4f":r?"#faad14":"#52c41a",fontWeight:"bold",backgroundColor:c?"#fff2f0":r?"#fffbe6":"#f6ffed",padding:"2px 6px",borderRadius:"4px",border:"1px solid ".concat(c?"#ffccc7":r?"#ffe58f":"#b7eb8f"),fontSize:"11px",whiteSpace:"nowrap"},children:["\ud83d\udce6 A/Q ",l]}),(0,S.jsxs)("span",{style:{color:"#722ed1",fontWeight:"bold",backgroundColor:"#f9f0ff",padding:"2px 6px",borderRadius:"4px",border:"1px solid #d3adf7",fontSize:"11px",whiteSpace:"nowrap"},children:["\ud83d\udccb A/L ",o]})]}),t.product_id&&!e&&(0,S.jsx)("span",{style:{fontSize:"11px",color:"#ff4d4f",whiteSpace:"nowrap"},children:"\u26a0\ufe0f Stock required"})]}),t.product_id&&(0,S.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:[(0,S.jsx)("span",{style:{fontSize:"12px",color:"#1890ff"},children:"\ud83d\udccb"}),(0,S.jsx)("span",{style:{fontSize:"10px",color:"#52c41a",backgroundColor:"#f6ffed",padding:"2px 4px",borderRadius:"3px"},children:"Click"})]})]})})}},{key:"qty",title:"\ud83d\udcca QTY",dataIndex:"qty",type:"number",width:90,render:(e,t,i)=>{const n=(C?be:ge).find((e=>e._id===t.stock_id)),l=(null===n||void 0===n?void 0:n.available_quantity)||0,o=e>l;return(0,S.jsx)("div",{style:{position:"relative"},children:(0,S.jsx)(c.A,{value:e,min:0,max:l,style:{width:"100%",borderColor:o?"#ff4d4f":void 0,backgroundColor:o?"#fff2f0":void 0},onPressEnter:e=>{if(void 0!==i){const t=e.target,n=parseInt(t.value)||0;qi(i,"qty",n)}},onBlur:e=>{if(void 0!==i){const t=e.target,n=parseInt(t.value)||0;qi(i,"qty",n)}},onChange:e=>{null!==e&&e>l&&s.Ay.error("Pack quantity cannot exceed available packs (".concat(l,")"))}})})}},{key:"loose_qty",title:"\ud83d\udccb LOOSE",dataIndex:"loose_qty",type:"number",width:90,render:(e,t,i)=>{var n,l;const o=(C?be:ge).find((e=>e._id===t.stock_id));if(!o)return(0,S.jsx)("div",{style:{position:"relative"},children:(0,S.jsx)(c.A,{value:e,min:0,style:{width:"100%"},disabled:!0})});const a=null===o||void 0===o||null===(n=o.ProductItem)||void 0===n||null===(l=n.VariantItem)||void 0===l?void 0:l.pack_size,r=a?parseInt(a):1,d=(null===o||void 0===o?void 0:o.available_quantity)||0,u=(null===o||void 0===o?void 0:o.available_loose_quantity)||0,m=d-(t.qty||0),p=m*r+u,v=e>p;return(0,S.jsx)("div",{style:{position:"relative"},children:(0,S.jsx)(c.A,{value:e,min:0,max:p,style:{width:"100%",borderColor:v?"#ff4d4f":void 0,backgroundColor:v?"#fff2f0":void 0},onPressEnter:e=>{if(void 0!==i){const t=e.target,n=parseInt(t.value)||0;qi(i,"loose_qty",n)}},onBlur:e=>{if(void 0!==i){const t=e.target,n=parseInt(t.value)||0;qi(i,"loose_qty",n)}},onChange:e=>{null!==e&&e>p&&s.Ay.error("Loose quantity cannot exceed available loose items (".concat(p," = ").concat(m," remaining packs \xd7 ").concat(r," + ").concat(u," loose)"))}})})}},{key:"price",title:"\ud83d\udcb0 RATE",dataIndex:"price",type:"number",required:!0,width:120,editable:!1,render:e=>(0,S.jsx)(c.A,{value:e,disabled:!0,style:{width:"100%"}})},{key:"amount",title:"\ud83d\udcb5 AMOUNT",dataIndex:"amount",type:"number",editable:!1,width:130,render:e=>(0,S.jsx)(c.A,{value:e,disabled:!0,style:{width:"100%"}})}]),[Ri,C,be,ge,qi]),Ki=Ui.findIndex((e=>"qty"===e.key||"qty"===e.dataIndex)),Oi=(0,l.useMemo)((()=>Ee.items.length?function(e){let{items:t,productList:i,isGstIncluded:l,discount:o,discountType:a}=e;const r=t.map((e=>{var t,o;const a=null===i||void 0===i?void 0:i.find((t=>t._id===e.product_id));let r=e.tax_percentage||(null===a||void 0===a||null===(t=a.CategoryItem)||void 0===t?void 0:t.tax_percentage)||18;r&&0!==r||(r=18);const s=Number(e.qty||0)*Number(e.price||0)+Number(e.loose_qty||0)*(Number(e.price||0)/((null===a||void 0===a||null===(o=a.VariantItem)||void 0===o?void 0:o.pack_size)||1)||0);let d=s;return!l&&r>0&&(d=s+s*r/100),(0,n.A)((0,n.A)({},e),{},{tax_percentage:r,baseAmount:s,amount:d})})),s=r.reduce(((e,t)=>e+Number(t.amount)),0),d=r.reduce(((e,t)=>e+Number(t.baseAmount)),0);let c=0;o>0&&(c="percentage"===a?d*(o/100):o);let u=0,m=0,p=0;return r.forEach((e=>{let t=e.baseAmount;o>0&&(t="percentage"===a?e.baseAmount-e.baseAmount*(o/100):e.baseAmount-o/d*e.baseAmount);let i=0;l?e.tax_percentage>0?(i=t*(e.tax_percentage/(100+e.tax_percentage)),m+=t-i,u+=i,p+=t):(m+=t,p+=t):e.tax_percentage>0?(i=t*(e.tax_percentage/100),m+=t,u+=i,p+=t+i):(m+=t,p+=t)})),{sub_total:s,value_of_goods:m,total_gst:u,cgst:u/2,sgst:u/2,total_amount:p,discountValue:c}}({items:Ee.items,productList:fe,isGstIncluded:li.isGstIncluded,discount:li.discount,discountType:li.discountType}):{sub_total:0,value_of_goods:0,total_gst:0,cgst:0,sgst:0,total_amount:0,discountValue:0}),[Ee.items,fe,li]),Qi=(0,l.useCallback)((e=>{const t=e[0];if(t){const e=ye.find((e=>e._id===t.customer_id)),i=_e.find((e=>e._id===t.billed_by_id));ni((l=>(0,n.A)((0,n.A)({},l),{},{invoice_no:t.invoice_no||"",date:t.date||f()().format("YYYY-MM-DD"),customer_id:t.customer_id||"",customer_name:(null===e||void 0===e?void 0:e.full_name)||"",billed_by_id:t.billed_by_id||"",billed_by_name:(null===i||void 0===i?void 0:i.name)||"",payment_mode:t.payment_mode||"cash"})))}}),[ye,_e]),Wi=(0,l.useCallback)((e=>{const t=e.map((e=>{var t;const i={product_id:e.product_id||"",product_name:(null===(t=Ri.find((t=>t.value===e.product_id)))||void 0===t?void 0:t.label)||"",variant_name:e.variant_name||"",stock_id:e.stock_id||"",batch_no:e.batch_no||"",qty:e.qty||0,loose_qty:e.loose_qty||0,price:e.price||0,mrp:e.mrp||0,amount:e.amount||0,tax_percentage:e.tax_percentage||0,stockData:e.stockData};if(e.stock_id&&(e.qty||e.loose_qty)){const t=(C?be:ge).find((t=>t._id===e.stock_id));if(t){var n,l;const o=null===t||void 0===t||null===(n=t.ProductItem)||void 0===n||null===(l=n.VariantItem)||void 0===l?void 0:l.pack_size,a=o?parseInt(o):1,r=t.available_quantity||0,d=t.available_loose_quantity||0;e.qty&&e.qty>r&&(s.Ay.error("Pack quantity (".concat(e.qty,") exceeds available packs (").concat(r,")")),i.qty=r);const c=r-(e.qty||0),u=c*a+d;e.loose_qty&&e.loose_qty>u&&(s.Ay.error("Loose quantity (".concat(e.loose_qty,") exceeds available loose items (").concat(u," = ").concat(c," remaining packs \xd7 ").concat(a," + ").concat(d," loose)")),i.loose_qty=u)}}if(e.product_id&&!e.stock_id){const t=(C?be:ge).filter((t=>{var i;return t.product===e.product_id||(null===(i=t.ProductItem)||void 0===i?void 0:i._id)===e.product_id}));if(t.length>0){const n=t[0];i.stock_id=n._id,i.batch_no=n.batch_no||"",setTimeout((()=>{const t=document.querySelector('td[data-row-key="'.concat(e.key,'"][data-column-key="qty"]'));t&&t.focus()}),300)}}return i})).map((e=>{if(!e.product_id||!e.stock_id)return e;const t=(C?be:ge).find((t=>t._id===e.stock_id));if(t){var i,l,o,a;const r=t.sell_price||0,s=null===t||void 0===t||null===(i=t.ProductItem)||void 0===i||null===(l=i.VariantItem)||void 0===l?void 0:l.pack_size,d=r/(s?parseInt(s):1),c=(e.qty||0)*r+(e.loose_qty||0)*d,u=fe.find((t=>t._id===e.product_id)),m=(null===u||void 0===u||null===(o=u.CategoryItem)||void 0===o?void 0:o.tax_percentage)||0;let p=c;return li.isGstIncluded||(p=c+c*m/100),(0,n.A)((0,n.A)({},e),{},{price:e.price||r,mrp:t.mrp||r,amount:p,tax_percentage:m,product_name:(null===u||void 0===u?void 0:u.name)||"",variant_name:(null===u||void 0===u||null===(a=u.VariantItem)||void 0===a?void 0:a.variant_name)||"",batch_no:t.batch_no||""})}return e}));ni((e=>(0,n.A)((0,n.A)({},e),{},{items:t})))}),[Ri,C,be,ge,fe,li]),Hi=(0,l.useCallback)(((e,t)=>{if(t<0||t>=Ee.items.length)return console.error("Invalid rowIndex: ".concat(t,". Items length: ").concat(Ee.items.length)),void s.Ay.error("Invalid row index: ".concat(t,". Please try again."));const i=[...Ee.items];if(!i[t])return console.error("Item at index ".concat(t," is undefined. Items length: ").concat(i.length)),void s.Ay.error("Selected row is no longer valid. Please try again.");i[t].product_id=e.id||e._id||"",i[t].product_name=e.name||"",i[t].price=e.selling_price||0,Wi(i),ri(t)}),[Wi,Ee.items.length]),Xi=()=>{if(null!==ai)return ri(null),s.Ay.info("Stock modal closed. Opening product selection..."),void setTimeout((()=>{Ji()}),100);Ji()},Ji=()=>{let e=-1;const t=document.activeElement,i=null===t||void 0===t?void 0:t.closest("tr");if(i){const t=i.getAttribute("data-row-key");null!==t&&(e=parseInt(t))}else{const i=null===t||void 0===t?void 0:t.closest("td");if(i){const t=i.closest("tr");if(t){const i=t.getAttribute("data-row-key");null!==i&&(e=parseInt(i))}}}-1===e&&si&&(e=si.row),-1===e&&Si<Ee.items.length&&(e=Si),-1===e&&(e=Ee.items.findIndex((e=>!e.product_id))),-1===e&&(sn(),e=Ee.items.length),Ii(e),Ci(!0),s.Ay.info("Opening product selection for row ".concat(e+1))},Zi=(0,l.useCallback)((()=>{Ii(0),Ci(!0),s.Ay.success("\ud83c\udf89 Bill saved! Ready for next bill - Select product to continue.",4)}),[]),$i=()=>{let e=-1;const t=document.activeElement,i=null===t||void 0===t?void 0:t.closest("tr");if(i){const t=i.getAttribute("data-row-key");if(null!==t){var n;const i=parseInt(t);null!==(n=Ee.items[i])&&void 0!==n&&n.product_id&&(e=i)}}-1===e&&(e=Ee.items.findIndex((e=>e.product_id&&!e.stock_id))),-1===e&&(e=Ee.items.findIndex((e=>e.product_id))),-1!==e?(ri(e),s.Ay.info("Opening stock selection for row ".concat(e+1))):s.Ay.warning("Please select a product first before selecting stock")},en=(0,l.useCallback)((e=>{Ee.customer_id!==e._id&&(ni((t=>(0,n.A)((0,n.A)({},t),{},{customer_id:e._id,customer_name:e.full_name}))),setTimeout((()=>{ui(!1),setTimeout((()=>{pi(!0)}),100)}),50),s.Ay.success('Customer "'.concat(e.full_name,'" selected successfully!')))}),[Ee.customer_id]),tn=(0,l.useCallback)((e=>{Ee.customer_id!==e._id&&(ni((t=>(0,n.A)((0,n.A)({},t),{},{customer_id:e._id,customer_name:e.vendor_name}))),setTimeout((()=>{ui(!1),setTimeout((()=>{pi(!0)}),100)}),50),s.Ay.success('Vendor "'.concat(e.vendor_name,'" selected successfully!')))}),[Ee.customer_id]),nn=(0,l.useCallback)((e=>{Ee.billed_by_id!==e._id&&(ni((t=>(0,n.A)((0,n.A)({},t),{},{billed_by_id:e._id,billed_by_name:e.name}))),setTimeout((()=>{pi(!1)}),50),s.Ay.success('User "'.concat(e.name,'" selected as billed by successfully!')))}),[Ee.billed_by_id]),ln=()=>{on(!1),fi(!1),hi(null),s.Ay.success("New bill form cleared successfully!")},on=(0,l.useCallback)((function(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];ni({invoice_no:"",date:f()().format("YYYY-MM-DD"),customer_id:"",customer_name:"",payment_mode:"cash",items:[{product_id:"",product_name:"",variant_name:"",stock_id:"",batch_no:"",qty:0,loose_qty:0,price:0,mrp:0,amount:0,tax_percentage:0}]}),oi({isPaid:!0,isPartiallyPaid:!1,isRetail:!0,isGstIncluded:!0,discount:0,discountType:"percentage",paidAmount:0}),Ei("bill"),ri(null),di(null),ui(!1),fi(!1),xi(!1),hi(null),bi(!1),ji(""),Ci(!1),Ii(null),le(),e&&s.Ay.success("Ready for next bill!",2)}),[]),an=()=>{on(!1),s.Ay.success("Bill form cleared successfully!")},rn=()=>{if(0===Ee.items.length)return;let e=!1;const t=Ee.items.map((t=>{let i=!1;if(t.product_id&&fe.length>0){const e=fe.find((e=>e._id===t.product_id));var n;if(e&&(t.product_name.includes("Loading...")||t.product_name.includes("Product ID:")||!t.product_name))t.product_name=e.name,t.variant_name=(null===(n=e.VariantItem)||void 0===n?void 0:n.variant_name)||"",i=!0}if(t.stock_id){const e=C?be:ge;if(e.length>0){var l;const n=e.find((e=>e._id===t.stock_id));n&&(null!==(l=t.batch_no)&&void 0!==l&&l.includes("Loading...")||!t.batch_no)&&(t.batch_no=n.batch_no||"",i=!0)}}return i&&(e=!0),t}));e&&ni((e=>(0,n.A)((0,n.A)({},e),{},{items:t})))},sn=()=>{const e={product_id:"",product_name:"",variant_name:"",stock_id:"",batch_no:"",qty:0,loose_qty:0,price:0,mrp:0,amount:0,tax_percentage:0};ni((t=>(0,n.A)((0,n.A)({},t),{},{items:[...t.items,e]})))},dn=async()=>{if(!Ee.invoice_no)return void s.Ay.error("Please enter an invoice number");if(!Ee.items||0===Ee.items.length)return void s.Ay.error("Please add at least one product/item to save as draft");if(0===Ee.items.filter((e=>e.product_id)).length)return void s.Ay.error("Please add at least one product/item to save as draft");const e=(0,n.A)((0,n.A)((0,n.A)({invoice_no:Ee.invoice_no,date:Ee.date||f()().format("YYYY-MM-DD")},"invoice"===Ni?{vendor_id:Ee.customer_id||null}:{customer_id:Ee.customer_id||null}),{},{billed_by_id:Ee.billed_by_id||null,payment_mode:Ee.payment_mode||"cash",items:Ee.items.map((e=>(0,n.A)((0,n.A)({product_id:e.product_id||null,stock_id:e.stock_id||null},C&&e.stock_id&&{branch_stock_id:e.stock_id}),{},{qty:e.qty||0,loose_qty:e.loose_qty||0,price:e.price||0,mrp:e.mrp||0,amount:e.amount||0,tax_percentage:e.tax_percentage||0,_id:e._id})))},Oi),{},{discount:li.discount,discount_type:li.discountType,is_paid:li.isPaid,is_partially_paid:li.isPartiallyPaid,sale_type:li.isRetail?"retail":"wholesale",is_gst_included:li.isGstIncluded,paid_amount:li.isPartiallyPaid?li.paidAmount:li.isPaid?Oi.total_amount:0,status:"draft",document_type:Ni});try{var t;let i;if(r){const t=await ke(r._id,e);if(!t.data)throw t.error;i=t.data,Ne(i)}else{const t=await Ae(e);if(!t.data)throw t.error;i=t.data,De(i)}if(200===(null===(t=i)||void 0===t?void 0:t.statusCode)){s.Ay.success("Draft saved successfully!");const t=(0,n.A)((0,n.A)({},e),{},{customer_name:Ee.customer_name,total_amount:Oi.total_amount,invoice_no:e.invoice_no,date:e.date});hi(t),r?fi(!0):null===v||void 0===v||v()}}catch(i){s.Ay.error("Failed to save draft. Please try again.")}},cn=async()=>{if(!Ee.invoice_no||!Ee.customer_id||!Ee.items.length)return void s.Ay.error("Please fill all required fields");if(Ee.items.some((e=>!e.product_id||!e.stock_id||!e.qty&&!e.loose_qty||!e.price)))return void s.Ay.error("Please complete all item details");const e=[];if(Ee.items.forEach(((t,i)=>{if(t.stock_id&&(t.qty||t.loose_qty)){const n=Li(t.stock_id,t.qty||0,t.loose_qty||0);n.isValid||e.push("Row ".concat(i+1,": ").concat(n.message))}})),e.length>0)return void s.Ay.error("Stock validation errors:\n".concat(e.join("\n")));if(!Ee.customer_id)return void s.Ay.error("Please select a ".concat("invoice"===Ni?"vendor":"customer"));if(!Ee.payment_mode)return void s.Ay.error("Please select a payment mode");const t=(0,n.A)((0,n.A)((0,n.A)({invoice_no:Ee.invoice_no,date:Ee.date},"invoice"===Ni?{vendor_id:Ee.customer_id}:{customer_id:Ee.customer_id}),{},{billed_by_id:Ee.billed_by_id,payment_mode:Ee.payment_mode,items:Ee.items.map((e=>(0,n.A)((0,n.A)({product_id:e.product_id,stock_id:e.stock_id},C&&{branch_stock_id:e.stock_id}),{},{qty:e.qty,loose_qty:e.loose_qty,price:e.price,mrp:e.mrp,amount:e.amount,tax_percentage:e.tax_percentage,_id:e._id})))},Oi),{},{discount:li.discount,discount_type:li.discountType,is_paid:li.isPaid,is_partially_paid:li.isPartiallyPaid,sale_type:li.isRetail?"retail":"wholesale",is_gst_included:li.isGstIncluded,paid_amount:li.isPartiallyPaid?li.paidAmount:li.isPaid?Oi.total_amount:0,status:"completed",document_type:Ni});try{var i;let e;if(r){const i=await ke(r._id,t);if(!i.data)throw i.error;e=i.data,Ne(e)}else{const i=await Ae(t);if(!i.data)throw i.error;e=i.data,De(e)}if(200===(null===(i=e)||void 0===i?void 0:i.statusCode)){const e=(0,n.A)((0,n.A)({},t),{},{customer_name:Ee.customer_name,total_amount:Oi.total_amount,invoice_no:t.invoice_no,date:t.date});hi(e),y(w.lh.util.invalidateTags(["StockAudit","BranchStock"])),r&&fi(!0)}}catch(l){s.Ay.error("Failed to complete bill. Please try again.")}};return(0,l.useEffect)((()=>{if(200===(null===Se||void 0===Se?void 0:Se.statusCode)){var e;null===v||void 0===v||v();"draft"===(null===Se||void 0===Se||null===(e=Se.data)||void 0===e?void 0:e.status)||"draft"===Ee.status||(we({}),r||(fi(!1),setTimeout((()=>{on(!1),setTimeout((()=>{Zi()}),200)}),100))),De(null)}}),[Se,r,on,v,Zi,we,Ee]),(0,l.useEffect)((()=>{200===(null===Pe||void 0===Pe?void 0:Pe.statusCode)&&(null===v||void 0===v||v(),Ne(null))}),[Pe,v]),(0,l.useEffect)((()=>{if(fe.length>0&&Ee.items.length>0){if(Ee.items.some((e=>e.product_id&&(!e.product_name||e.product_name.includes("Loading...")||e.product_name.includes("Product ID:"))))){const e=Ee.items.map((e=>{if(e.product_id&&(!e.product_name||e.product_name.includes("Loading...")||e.product_name.includes("Product ID:"))){const i=fe.find((t=>t._id===e.product_id));var t;if(i)return(0,n.A)((0,n.A)({},e),{},{product_name:i.name,variant_name:(null===(t=i.VariantItem)||void 0===t?void 0:t.variant_name)||""})}return e}));e.some(((e,t)=>e.product_name!==Ee.items[t].product_name))&&ni((t=>(0,n.A)((0,n.A)({},t),{},{items:e})))}}}),[fe,Ee.items]),(0,l.useEffect)((()=>{if(!r)return;const e=C?be:ge;if(e.length>0){if(Ee.items.some((e=>e.stock_id&&!e.stockData))){const t=Ee.items.map((t=>{if(t.stock_id&&!t.stockData){const i=e.find((e=>e._id===t.stock_id));if(i)return(0,n.A)((0,n.A)({},t),{},{stockData:i})}return t}));t.some(((e,t)=>e.stockData&&!Ee.items[t].stockData))&&ni((e=>(0,n.A)((0,n.A)({},e),{},{items:t})))}}}),[ge,be,C,r]),(0,l.useEffect)((()=>{fe.length>0&&Ee.items.length>0&&setTimeout((()=>{rn()}),200)}),[fe,Ee.items]),(0,l.useEffect)((()=>{const e=C?be:ge;if(e.length>0&&Ee.items.length>0){if(Ee.items.some((e=>e.stock_id&&(!e.batch_no||e.batch_no.includes("Loading..."))))){const t=Ee.items.map((t=>{if(t.stock_id&&(!t.batch_no||t.batch_no.includes("Loading..."))){const i=e.find((e=>e._id===t.stock_id));if(i)return(0,n.A)((0,n.A)({},t),{},{batch_no:i.batch_no||""})}return t}));t.some(((e,t)=>e.batch_no!==Ee.items[t].batch_no))&&ni((e=>(0,n.A)((0,n.A)({},e),{},{items:t})))}}}),[be,ge,Ee.items,C]),(0,l.useEffect)((()=>{(C?be:ge).length>0&&Ee.items.length>0&&setTimeout((()=>{rn()}),200)}),[be,ge,Ee.items,C]),(0,l.useEffect)((()=>{if(Ee.items.length>0){const e=setInterval((()=>{Ee.items.some((e=>e.product_id&&(!e.product_name||e.product_name.includes("Loading...")||e.product_name.includes("Product ID:"))||e.stock_id&&(!e.batch_no||e.batch_no.includes("Loading..."))))&&(fe.length>0||(C?be.length>0:ge.length>0))&&rn()}),1e3);return()=>clearInterval(e)}}),[Ee.items,fe,be,ge,C]),(0,l.useEffect)((()=>{const e=e=>{if("F1"===e.key)e.preventDefault(),sn(),setTimeout((()=>{const e=document.querySelector('.ant-table-tbody tr:last-child td[data-column-key="product_id"]');null===e||void 0===e||e.focus()}),200);else if("F2"===e.key)e.preventDefault(),dn();else if("F3"===e.key)e.preventDefault(),cn();else if("F4"===e.key)e.preventDefault(),an();else if("F5"===e.key)e.preventDefault(),Xi();else if("End"===e.key)e.preventDefault(),ui(!0);else if("F6"===e.key)e.preventDefault(),xi(!0);else if("F7"===e.key)e.preventDefault(),$i();else if("F8"===e.key)e.preventDefault(),s.Ay.info("Print functionality coming soon!");else if(e.ctrlKey)switch(e.key){case"s":e.preventDefault(),dn();break;case"n":e.preventDefault(),sn(),setTimeout((()=>{const e=document.querySelector('.ant-table-tbody tr:last-child td[data-column-key="product_id"]');null===e||void 0===e||e.focus()}),200);break;case"p":e.preventDefault(),s.Ay.info("Print functionality coming soon!");break;case"r":e.preventDefault(),on();break;case"u":e.preventDefault(),pi(!0)}else if(e.ctrlKey&&/^[0-9]$/.test(e.key)){e.preventDefault();const t=document.activeElement;if(null!==t&&void 0!==t&&t.closest('td[data-column-key="qty"]')){const i=t.querySelector("input");i&&(i.value=e.key,i.dispatchEvent(new Event("change",{bubbles:!0})))}}};return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)}),[Ee,li,Xi,$i,ai]),(0,S.jsxs)("div",{className:Re,children:[(0,S.jsx)("div",{className:Ge}),(0,S.jsx)("div",{className:ze}),(0,S.jsx)("div",{className:Me}),(0,S.jsx)("div",{className:Ve}),(0,S.jsx)("div",{className:Fe}),(0,S.jsxs)("div",{className:Ye,children:[(0,S.jsx)("div",{className:Ue}),(0,S.jsx)("div",{className:Ke}),(0,S.jsx)("div",{className:Oe}),(0,S.jsx)("div",{className:Qe}),(0,S.jsx)("div",{className:We}),(0,S.jsxs)("div",{className:He,children:[(0,S.jsxs)("div",{className:Xe,children:[(0,S.jsx)("div",{className:Je,children:(0,S.jsx)(M.A,{style:{fontSize:"24px",color:"white"}})}),(0,S.jsxs)("div",{children:[(0,S.jsx)(ti,{level:4,className:Ze,children:r?"\u26a1 EDIT INVOICE":"\ud83d\ude80 NEW INVOICE"}),(0,S.jsxs)(ii,{className:$e,children:["\u26a1Lightning Fast \u2022 ",f()().format("DD MMM YYYY, dddd")]})]})]}),(0,S.jsxs)("div",{className:et,children:[(0,S.jsx)("div",{style:{marginRight:"12px"},children:(0,S.jsx)(Le,{value:Ni,onChange:Ei})}),(0,S.jsxs)("div",{className:"".concat(tt," ").concat(it),children:[(0,S.jsx)(ii,{className:at,children:"\ud83c\udfea SALE TYPE"}),(0,S.jsx)(u.A,{checkedChildren:"RETAIL",unCheckedChildren:"WHOLESALE",checked:li.isRetail,onChange:e=>oi((t=>(0,n.A)((0,n.A)({},t),{},{isRetail:e}))),className:Jt,size:"small"})]}),(0,S.jsxs)("div",{className:"".concat(tt," ").concat(nt),children:[(0,S.jsx)(ii,{className:at,children:"\ud83d\udcca GST"}),(0,S.jsx)(u.A,{checkedChildren:"INCL",unCheckedChildren:"EXCL",checked:li.isGstIncluded,onChange:e=>oi((t=>(0,n.A)((0,n.A)({},t),{},{isGstIncluded:e}))),className:Zt,size:"small"})]}),(0,S.jsxs)("div",{className:"".concat(tt," ").concat(lt),children:[(0,S.jsx)(ii,{className:at,children:"\ud83d\udcb3 PAYMENT"}),(0,S.jsx)(u.A,{checkedChildren:"PAID",unCheckedChildren:"UNPAID",checked:li.isPaid,onChange:e=>oi((t=>(0,n.A)((0,n.A)({},t),{},{isPaid:e,isPartiallyPaid:!e&&t.isPartiallyPaid}))),className:$t,size:"small"})]}),!li.isPaid&&(0,S.jsxs)("div",{className:"".concat(tt," ").concat(ot),children:[(0,S.jsx)(ii,{className:at,children:"\ud83d\udcb0 PARTIAL"}),(0,S.jsx)(u.A,{checkedChildren:"YES",unCheckedChildren:"NO",checked:li.isPartiallyPaid,onChange:e=>oi((t=>(0,n.A)((0,n.A)({},t),{},{isPartiallyPaid:e}))),className:ei,size:"small"})]}),(0,S.jsxs)("div",{className:rt,children:[(0,S.jsx)("div",{className:st,children:(0,S.jsxs)(ii,{className:ct,children:["\ud83c\udfaf ITEMS: ",Ee.items.length]})}),(0,S.jsx)("div",{className:dt,children:(0,S.jsxs)(ii,{className:ct,children:["\ud83d\udcb0 \u20b9",Oi.total_amount.toFixed(2)]})})]})]})]})]}),(0,S.jsx)("div",{className:ut,children:(0,S.jsx)(G,{columns:Fi,dataSource:Yi,onSave:Qi,allowAdd:!1,allowDelete:!1,loading:Y||O,className:"compact-header-grid",size:"small",rowKey:"invoice_no"})}),(0,S.jsxs)("div",{className:mt,children:[(0,S.jsx)("div",{className:pt}),(0,S.jsx)("div",{className:vt}),(0,S.jsxs)("div",{className:ft,children:[(0,S.jsxs)("div",{className:yt,children:[(0,S.jsx)(ii,{className:xt,children:"\ud83d\uded2 BILL ITEMS"}),(0,S.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[(0,S.jsx)(m.A,{count:Ee.items.length,showZero:!0,size:"small",style:{backgroundColor:"rgba(255,255,255,0.2)"},children:(0,S.jsx)(ii,{className:_t,children:"Items"})}),(0,S.jsx)(ii,{style:{fontSize:"10px",color:"#666",backgroundColor:"#f0f0f0",padding:"2px 6px",borderRadius:"4px",border:"1px solid #d9d9d9"}})]})]}),(0,S.jsx)(G,{columns:Ui,dataSource:Ee.items.map(((e,t)=>(0,n.A)((0,n.A)({},e),{},{key:t.toString()}))),onSave:Wi,onAdd:sn,onDelete:e=>{ni((t=>{const i=t.items.filter(((t,i)=>!e.includes(null===i||void 0===i?void 0:i.toString())));return(0,n.A)((0,n.A)({},t),{},{items:i})}))},onProductSelect:Hi,loading:B||Z||te,className:"modern-bill-grid",size:"small",rowKey:"key",externalEditingCell:si})]}),(0,S.jsxs)("div",{className:ht,children:[(0,S.jsx)("div",{className:gt}),(0,S.jsx)("div",{className:bt}),(0,S.jsx)("div",{className:At,children:(0,S.jsx)(ii,{className:jt,children:"\ud83d\udcb0 BILL SUMMARY"})}),(0,S.jsxs)("div",{className:It,children:[(0,S.jsxs)("div",{className:kt,children:[(0,S.jsx)(ii,{className:Ct,children:"Sub Total:"}),(0,S.jsxs)(ii,{className:wt,children:["\u20b9",Oi.sub_total.toFixed(2)]})]}),(0,S.jsxs)("div",{className:kt,children:[(0,S.jsx)(ii,{className:Ct,children:"Value of Goods:"}),(0,S.jsxs)(ii,{className:wt,children:["\u20b9",Oi.value_of_goods.toFixed(2)]})]}),(0,S.jsxs)("div",{className:kt,children:[(0,S.jsx)(ii,{className:Ct,children:"Total GST:"}),(0,S.jsxs)(ii,{className:wt,children:["\u20b9",Oi.total_gst.toFixed(2)]})]}),(0,S.jsxs)("div",{className:kt,children:[(0,S.jsx)(ii,{className:Ct,children:"CGST:"}),(0,S.jsxs)(ii,{className:wt,children:["\u20b9",Oi.cgst.toFixed(2)]})]}),(0,S.jsxs)("div",{className:kt,children:[(0,S.jsx)(ii,{className:Ct,children:"SGST:"}),(0,S.jsxs)(ii,{className:wt,children:["\u20b9",Oi.sgst.toFixed(2)]})]}),li.discount>0&&(0,S.jsxs)("div",{className:kt,children:[(0,S.jsx)(ii,{className:Ct,children:"DISCOUNT:"}),(0,S.jsxs)(ii,{className:Pt,children:["-\u20b9","percentage"===li.discountType?((Oi.sub_total+Oi.total_gst)*("number"===typeof li.discount?li.discount:0)/100).toFixed(2):("number"===typeof li.discount?li.discount:0).toFixed(2)]})]}),(0,S.jsxs)("div",{className:St,children:[(0,S.jsx)(ii,{className:Dt,children:"NET/EXC/REPL:"}),(0,S.jsxs)(ii,{className:Tt,children:["\u20b9",Oi.total_amount.toFixed(2)]})]}),li.isPartiallyPaid&&(0,S.jsxs)("div",{className:Nt,children:[(0,S.jsxs)("div",{className:Et,children:[(0,S.jsx)(ii,{className:Bt,children:"Paid Amount:"}),(0,S.jsxs)(ii,{className:Lt,children:["\u20b9",("number"===typeof li.paidAmount?li.paidAmount:0).toFixed(2)]})]}),(0,S.jsxs)("div",{className:Et,children:[(0,S.jsx)(ii,{className:Bt,children:"Balance:"}),(0,S.jsxs)(ii,{className:Lt,children:["\u20b9",(Oi.total_amount-("number"===typeof li.paidAmount?li.paidAmount:0)).toFixed(2)]})]})]})]}),(0,S.jsxs)("div",{className:qt,children:[(0,S.jsxs)("div",{className:Rt,children:[(0,S.jsx)(ii,{className:Gt,children:"\ud83d\udcb8 DISCOUNT"}),(0,S.jsxs)("div",{className:zt,children:[(0,S.jsx)(c.A,{min:0,value:li.discount,onChange:e=>oi((t=>(0,n.A)((0,n.A)({},t),{},{discount:e||0}))),style:{width:70},size:"small"}),(0,S.jsx)(u.A,{checkedChildren:"%",unCheckedChildren:"\u20b9",checked:"percentage"===li.discountType,onChange:e=>oi((t=>(0,n.A)((0,n.A)({},t),{},{discountType:e?"percentage":"amount"}))),size:"small"})]})]}),li.isPartiallyPaid&&(0,S.jsxs)("div",{className:ot,children:[(0,S.jsx)(ii,{className:Mt,children:"\ud83d\udcb0 PARTIAL PAY"}),(0,S.jsx)(c.A,{min:0,max:Oi.total_amount,value:li.paidAmount,onChange:e=>oi((t=>(0,n.A)((0,n.A)({},t),{},{paidAmount:e||0}))),style:{width:90},size:"small",formatter:e=>"\u20b9".concat(e).replace(/\B(?=(\d{3})+(?!\d))/g,","),parser:e=>Number(e.replace(/\u20b9\s?|(,*)/g,""))})]})]})]})]}),(0,S.jsxs)("div",{className:Vt,children:[(0,S.jsx)("div",{className:Yt}),(0,S.jsx)("div",{className:Ut}),(0,S.jsx)("div",{className:Kt}),(0,S.jsx)("div",{className:Ot}),(0,S.jsxs)("div",{className:Ft,children:[(0,S.jsx)(p.Ay,{type:"primary",size:"large",icon:(0,S.jsx)(k.A,{}),onClick:dn,loading:je,className:Qt,children:"\ud83d\udcbe SAVE DRAFT (F2)"}),(0,S.jsxs)(p.Ay,{type:"primary",size:"large",icon:(0,S.jsx)(k.A,{}),onClick:cn,loading:je||Ce,className:Qt,children:["\ud83d\ude80 ",r?"UPDATE":"COMPLETE BILL"," (F3)"]}),(0,S.jsx)(p.Ay,{size:"large",icon:(0,S.jsx)(M.A,{}),onClick:()=>xi(!0),className:Wt,children:"\ud83d\udccb BILL LIST (F6)"}),(0,S.jsx)(p.Ay,{size:"large",icon:(0,S.jsx)(V.A,{}),onClick:an,className:Xt,children:"\ud83e\uddf9 CLEAR (F4 / Ctrl+R)"}),(0,S.jsxs)(p.Ay,{size:"large",icon:(0,S.jsx)(F.A,{}),className:Ht,onClick:()=>{if(!Ee.items||0===Ee.items.length)return void s.Ay.warning("Please add items before printing");const e=("invoice"===Ni?xe:ye).find((e=>e._id===Ee.customer_id)),t={invoice_no:Ee.invoice_no,date:Ee.date,customerName:(null===e||void 0===e?void 0:e.vendor_name)||(null===e||void 0===e?void 0:e.full_name)||Ee.customer_name||"",customerAddress:(null===e||void 0===e?void 0:e.address)||(null===e||void 0===e?void 0:e.address1)||"",customerCity:(null===e||void 0===e?void 0:e.city)||"",customerState:(null===e||void 0===e?void 0:e.state)||"",customerPincode:(null===e||void 0===e?void 0:e.pincode)||"",customerPhone:(null===e||void 0===e?void 0:e.phone)||(null===e||void 0===e?void 0:e.mobile)||(null===e||void 0===e?void 0:e.contact_number)||"",customerEmail:(null===e||void 0===e?void 0:e.email)||"",customer_gstin:(null===e||void 0===e?void 0:e.gst_no)||(null===e||void 0===e?void 0:e.gst_number)||(null===e||void 0===e?void 0:e.gstin)||"",customer_pan:(null===e||void 0===e?void 0:e.pan_no)||(null===e||void 0===e?void 0:e.pan_number)||"",items:Ee.items,total:Oi.total_amount,total_gst:Oi.total_gst,cgst:Oi.total_gst/2,sgst:Oi.total_gst/2,discount:li.discount,discount_type:li.discountType,payment_mode:Ee.payment_mode,organisationItems:P,branchItems:N};Bi(t,Ni)},children:["\ud83d\udda8\ufe0f PRINT ","bill"===Ni?"BILL":"INVOICE"," (F8)"]})]}),(0,S.jsx)("div",{style:{background:"linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%)",padding:"14px 18px",borderRadius:"10px",border:"1px solid #cbd5e1",position:"relative",zIndex:1,boxShadow:"0 4px 12px rgba(0, 0, 0, 0.05)"},children:(0,S.jsx)("div",{style:{textAlign:"right"},children:(0,S.jsxs)(ii,{style:{color:"#475569",fontSize:"12px",display:"block",fontWeight:600,lineHeight:"18px"},children:["\u26a1 ",(0,S.jsx)("strong",{children:"Keyboard Shortcuts:"})," Ctrl+S (Save) \u2022 Ctrl+N (Add) \u2022 F4/Ctrl+R (Clear) \u2022 Tab/Shift+Tab (Navigate) \u2022 Enter (Edit) \u2022 Esc (Cancel) \u2022 End (Customer) \u2022 Ctrl+U (User) \u2022 F5 (Product) \u2022 F6 (Bill List) \u2022 F7 (Stock)"]})})})]}),null!==ai&&(0,S.jsx)(q,{visible:!0,onSelect:e=>{var t,i;if(null===ai)return;if(ai<0||ai>=Ee.items.length)return console.error("Invalid stockModalRowIndex: ".concat(ai,". Items length: ").concat(Ee.items.length)),s.Ay.error("Invalid row index: ".concat(ai,". Please try again.")),void ri(null);const l=[...Ee.items];if(!l[ai])return console.error("Item at index ".concat(ai," is undefined. Items length: ").concat(l.length)),s.Ay.error("Selected row is no longer valid. Please try again."),void ri(null);l[ai].stock_id=e.id||e._id||e.invoice_id||"",l[ai].batch_no=e.batch_no||"";const o={available_quantity:e.available_quantity||0,available_loose_quantity:e.available_loose_quantity||0,batch_no:e.batch_no||e.name||"",pack_size:(null===(t=e.ProductItem)||void 0===t||null===(i=t.VariantItem)||void 0===i?void 0:i.pack_size)||1};l[ai]=(0,n.A)((0,n.A)({},l[ai]),{},{stockData:o}),Wi(l),ri(null),-1!==Ki&&di({row:ai,col:Ki})},onCancel:()=>ri(null),productId:(null===(i=Ee.items[ai])||void 0===i?void 0:i.product_id)||""}),"bill"===Ni&&(0,S.jsx)(re,{visible:ci,onSelect:en,onCancel:()=>ui(!1)}),"invoice"===Ni&&(0,S.jsx)(ue,{visible:ci,onSelect:tn,onCancel:()=>ui(!1)}),(0,S.jsx)(ve,{visible:mi,onSelect:nn,onCancel:()=>pi(!1)}),(0,S.jsx)(he,{visible:vi,onNewBill:ln,onContinueBill:()=>{fi(!1),hi(null)},onCancel:()=>fi(!1),savedBillData:_i}),(0,S.jsx)(Be,{visible:gi,onCancel:()=>bi(!1),productId:Ai}),(0,S.jsx)(T,{visible:ki,onSelect:e=>{var t;if(null===wi)return;if(wi<0||wi>=Ee.items.length)return console.error("Invalid productSelectionRowIndex: ".concat(wi,". Items length: ").concat(Ee.items.length)),s.Ay.error("Invalid row index: ".concat(wi,". Please try again.")),void Ii(null);const i=[...Ee.items];if(!i[wi])return console.error("Item at index ".concat(wi," is undefined. Items length: ").concat(i.length)),s.Ay.error("Selected row is no longer valid. Please try again."),void Ii(null);i[wi].product_id=e._id||"",i[wi].product_name=e.name||"",i[wi].variant_name=(null===(t=e.VariantItem)||void 0===t?void 0:t.variant_name)||"",i[wi].price=e.selling_price||0,Wi(i),Ci(!1),Ii(null),ri(wi),s.Ay.success('Product "'.concat(e.name,'" selected successfully!'))},onCancel:()=>{Ci(!1),Ii(null)}}),(0,S.jsx)(Te,{visible:yi,onClose:()=>xi(!1),onViewBill:e=>{var t,i,l,o,a;if(!e)return void s.Ay.error("No bill data received");L(),U(),C?ie():$(),0===fe.length&&L(),0===ye.length&&U();0===(C?be:ge).length&&(C?ie():$());let r=[];e.Items&&Array.isArray(e.Items)?r=e.Items:e.items&&Array.isArray(e.items)?r=e.items:e.sales_items&&Array.isArray(e.sales_items)?r=e.sales_items:e.result&&e.result.Items&&Array.isArray(e.result.Items)?r=e.result.Items:e.result&&e.result.items&&Array.isArray(e.result.items)&&(r=e.result.items);const d=r.map(((e,t)=>{var i,l;let o="",a="";var r;if(null!==(i=e.productItems)&&void 0!==i&&i.name)o=e.productItems.name,a=(null===(r=e.productItems.VariantItem)||void 0===r?void 0:r.variant_name)||"";else if(e.product_name)o=e.product_name,a=e.variant_name||"";else if(null!==(l=e.product)&&void 0!==l&&l.name){var s;o=e.product.name,a=(null===(s=e.product.VariantItem)||void 0===s?void 0:s.variant_name)||""}else if(e.product_id){const t=fe.find((t=>t._id===e.product_id));var d;if(t)o=t.name,a=(null===(d=t.VariantItem)||void 0===d?void 0:d.variant_name)||"";else 0===fe.length&&L(),o="Loading... (ID: ".concat(e.product_id,")"),setTimeout((()=>{if(fe.length>0){const i=fe.find((t=>t._id===e.product_id));if(i){const l=[...Ee.items],o=l.findIndex((t=>t.product_id===e.product_id));var t;if(-1!==o)l[o].product_name=i.name,l[o].variant_name=(null===(t=i.VariantItem)||void 0===t?void 0:t.variant_name)||"",ni((e=>(0,n.A)((0,n.A)({},e),{},{items:l})))}}}),100)}let c="",u="";if(e.stock_id?(c=e.stock_id,u=e.batch_no||""):e.branch_stock_id?(c=e.branch_stock_id,u=e.batch_no||""):e.stock&&(c=e.stock,u=e.batch_no||""),c&&!u){var m;const e=C?me:ce,t=null===e||void 0===e||null===(m=e.result)||void 0===m?void 0:m.find((e=>e._id===c));t?u=t.batch_no||"":(null!==e&&void 0!==e&&e.result||(C?ie():$()),u="Loading... (Stock: ".concat(c,")"),setTimeout((()=>{const e=C?me:ce;if(null!==e&&void 0!==e&&e.result){const t=e.result.find((e=>e._id===c));if(t){const e=[...Ee.items],i=e.findIndex((e=>e.stock_id===c));-1!==i&&(e[i].batch_no=t.batch_no||"",ni((t=>(0,n.A)((0,n.A)({},t),{},{items:e}))))}}}),100))}return{_id:e._id||"",product_id:e.product_id||e.product||"",product_name:o,variant_name:a,stock_id:c,batch_no:u,qty:e.qty||0,loose_qty:e.loose_qty||0,price:e.price||0,mrp:e.mrp||e.price||0,amount:e.amount||0,tax_percentage:e.tax_percentage||0}})),c=e.customer_id||"";let u="";if(null!==(t=e.customerDetails)&&void 0!==t&&t.full_name)u=e.customerDetails.full_name;else if(e.customer_name)u=e.customer_name;else if(null!==(i=e.customer)&&void 0!==i&&i.full_name)u=e.customer.full_name;else if(e.customer_id){var m;const t=null===ae||void 0===ae||null===(m=ae.result)||void 0===m?void 0:m.find((t=>t._id===e.customer_id));u=(null===t||void 0===t?void 0:t.full_name)||"Customer ID: ".concat(e.customer_id)}let p=f()().format("YYYY-MM-DD");if(e.date)try{p=f()(e.date).format("YYYY-MM-DD")}catch(x){p=f()().format("YYYY-MM-DD")}let v=[...d];fe.length>0&&(v=v.map((e=>{if(e.product_id&&(e.product_name.includes("Loading...")||e.product_name.includes("Product ID:"))){const i=fe.find((t=>t._id===e.product_id));var t;if(i)return(0,n.A)((0,n.A)({},e),{},{product_name:i.name,variant_name:(null===(t=i.VariantItem)||void 0===t?void 0:t.variant_name)||""})}return e})));const y=C?be:ge;y.length>0&&(v=v.map((e=>{if(e.stock_id&&(e.batch_no.includes("Loading...")||!e.batch_no)){const t=y.find((t=>t._id===e.stock_id));if(t)return(0,n.A)((0,n.A)({},e),{},{batch_no:t.batch_no||""})}return e}))),ni({invoice_no:e.invoice_no||"",date:p,customer_id:c,customer_name:u,payment_mode:e.payment_mode||"cash",items:v}),oi({isPaid:null===(l=e.is_paid)||void 0===l||l,isPartiallyPaid:null!==(o=e.is_partially_paid)&&void 0!==o&&o,isRetail:"retail"===e.sale_type||void 0===e.sale_type,isGstIncluded:null===(a=e.is_gst_included)||void 0===a||a,discount:e.discount||0,discountType:e.discount_type||"percentage",paidAmount:e.paid_amount||0}),s.Ay.success('Bill "'.concat(e.invoice_no,'" loaded successfully!')),setTimeout((()=>{rn()}),100),setTimeout((()=>{rn()}),500),setTimeout((()=>{rn()}),1e3)},onNewBill:ln})]})}},47246:(e,t,i)=>{i.d(t,{Ib:()=>r});var n=i(89379),l=i(65043),o=i(98350),a=i(94265);const r=e=>{const t=(0,l.useMemo)((()=>(0,o.yo)(e)),[e]),i=(0,l.useMemo)((()=>{const t=a.QQ[e];if(!t||"object"!==typeof t||!("GetAll"in t))throw new Error("Entity ".concat(e," not found in API_ROUTES or doesn't follow CRUD pattern"));return t}),[e]);return{useGetAll:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const i=t.useGetQuery(e);return(0,n.A)((0,n.A)({},i),{},{refetch:i.refetch})},useGetById:function(e){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const l=t.useGetByIdQuery((0,n.A)({id:e},i));return(0,n.A)((0,n.A)({},l),{},{refetch:l.refetch})},useCreate:()=>{const[e,i]=t.useCreateMutation(),o=(0,l.useCallback)((async t=>{try{return{data:await e(t).unwrap(),error:null}}catch(i){return{data:null,error:i}}}),[e]);return(0,n.A)({create:o},i)},useUpdate:()=>{const[e,i]=t.useUpdateMutation(),o=(0,l.useCallback)((async(t,i)=>{try{return{data:await e({id:t,data:i}).unwrap(),error:null}}catch(n){return{data:null,error:n}}}),[e]);return(0,n.A)({update:o},i)},useDelete:()=>{const[e,i]=t.useDeleteMutation(),o=(0,l.useCallback)((async t=>{try{return{data:await e(t).unwrap(),error:null}}catch(i){return{data:null,error:i}}}),[e]);return(0,n.A)({delete:o,remove:o},i)},getRoutes:(0,l.useCallback)((()=>({getAll:i.GetAll,get:i.Get,create:i.Create,update:i.Update,delete:i.Delete})),[i]),entityName:e,entityRoutes:i}}},71281:(e,t,i)=>{i.d(t,{z:()=>o});var n=i(26016),l=i(65043);const o=e=>{let{action:t,title:i,mutationResult:o,refetch:a}=e;const{isLoading:r,isSuccess:s,isError:d,data:c,error:u,reset:m}=o,p=(0,l.useRef)(!1),v=(0,l.useRef)("");(0,l.useEffect)((()=>{const e=p.current;if(p.current=r||!1,r)return;if(!e)return;const l="".concat(s,"-").concat(d,"-").concat((null===c||void 0===c?void 0:c.statusCode)||"","-").concat((null===u||void 0===u?void 0:u.status)||"");if(v.current!==l){if(s&&c){200===(null===c||void 0===c?void 0:c.statusCode)||(null===c||void 0===c||c.status);const e=a;(0,n.y)({action:t,title:i,success:!0,getAllItems:e}),v.current=l,m&&setTimeout((()=>{m(),v.current=""}),100)}if(d&&u){var o;const e=(null===u||void 0===u||null===(o=u.data)||void 0===o?void 0:o.message)||(null===u||void 0===u?void 0:u.message)||(null===u||void 0===u?void 0:u.error)||"Failed to ".concat(t," ").concat(i);(0,n.y)({action:t,title:i,success:!1,errorMessage:e}),v.current=l,m&&setTimeout((()=>{m(),v.current=""}),100)}}}),[r,s,d,c,u,t,i,a,m])}},91449:(e,t,i)=>{i.d(t,{P0:()=>o});var n=i(16569),l=i(94265);const o=(e,t)=>{"success"===e?n.Ay.success(t):"error"===e&&n.Ay.error(t)};(e=>{const t=(e=>t=>{var i;const n=null===l.QQ||void 0===l.QQ||null===(i=l.QQ[e])||void 0===i?void 0:i[t];if(!n)throw new Error("API route for ".concat(String(e),".").concat(String(t)," is not defined."));return n})(e)})("Unit")}}]);
//# sourceMappingURL=331.2e373ac5.chunk.js.map