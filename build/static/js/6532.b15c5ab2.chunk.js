"use strict";(self.webpackChunkSUBRIVA_BILLING=self.webpackChunkSUBRIVA_BILLING||[]).push([[6532],{36532:(e,t,n)=>{n.r(t),n.d(t,{default:()=>le});var r=n(89379),o=n(65043),i=n(36621),l=n(26553),s=n(62305),a=n(16569),d=n(42261),c=n(6051),u=n(76399),m=n(95206),x=n(93504),p=n(62751),h=n(73146),j=n(37490),v=n(96651),A=n(79126),_=n(30326),y=n(60446),f=n.n(y),g=n(33359),b=n(45229),R=n(46237),I=n(89967),k=n(80599),S=n(76401),w=n(11951),C=n(55574),N=n(6881),D=n(36091),Y=n(53722),F=n(61118),T=n(94733),P=n(31219),q=n(9316),M=n(18758),E=n(58209),z=n(70579);const L={draft:{color:"default",icon:(0,z.jsx)(g.A,{}),label:"Draft"},pending_approval:{color:"warning",icon:(0,z.jsx)(b.A,{}),label:"Pending Approval"},approved:{color:"success",icon:(0,z.jsx)(R.A,{}),label:"Approved"},rejected:{color:"error",icon:(0,z.jsx)(I.A,{}),label:"Rejected"},completed:{color:"green",icon:(0,z.jsx)(R.A,{}),label:"Completed"},cancelled:{color:"red",icon:(0,z.jsx)(k.A,{}),label:"Cancelled"}},U={cash:{color:"green",icon:(0,z.jsx)(S.A,{}),label:"Cash"},card:{color:"blue",icon:(0,z.jsx)(w.A,{}),label:"Card"},upi:{color:"purple",icon:(0,z.jsx)(w.A,{}),label:"UPI"},points:{color:"orange",icon:(0,z.jsx)(w.A,{}),label:"Customer Points"},bank_transfer:{color:"cyan",icon:(0,z.jsx)(w.A,{}),label:"Bank Transfer"}};var O=n(97679),B=n(7866),G=n(91065),V=n(95240);const{TextArea:Z}=i.A,{Option:W}=l.A,K=e=>{let{value:t=[],onChange:n,disabled:i=!1,showCondition:s=!0}=e;const a=(0,o.useCallback)(((e,o,i)=>{const l=[...t],s=(0,r.A)((0,r.A)({},l[e]),{},{[o]:i});if(["quantity","unit_price","tax_percentage","discount"].includes(o)){const e=Number(s.quantity)||0,t=Number(s.unit_price)||0,n=Number(s.tax_percentage)||0,r=Number(s.discount)||0;let o=e*t;o-="percentage"===(s.discount_type||"percentage")?o*(r/100):r;const i=o*(n/100);s.line_total=Number((o+i).toFixed(2))}l[e]=s,null===n||void 0===n||n(l)}),[t,n]),d=(0,o.useMemo)((()=>{const e=t.reduce(((e,t)=>{const n=Number(t.quantity)||0,r=Number(t.unit_price)||0,o=Number(t.discount)||0;let i=n*r;return i-="percentage"===(t.discount_type||"percentage")?i*(o/100):o,e+i}),0),n=t.reduce(((e,t)=>{const n=Number(t.quantity)||0,r=Number(t.unit_price)||0,o=Number(t.tax_percentage)||0,i=Number(t.discount)||0;let l=n*r;return l-="percentage"===(t.discount_type||"percentage")?l*(i/100):i,e+l*(o/100)}),0),r=e+n;return{subtotal:Number(e.toFixed(2)),taxAmount:Number(n.toFixed(2)),total:Number(r.toFixed(2))}}),[t]),m=[{title:"#",key:"index",width:40,fixed:"left",render:(e,t,n)=>n+1},{title:"Product",key:"product",width:200,fixed:"left",render:(e,t)=>(0,z.jsxs)("div",{children:[(0,z.jsx)("strong",{children:t.product_name}),t.variant_name&&(0,z.jsx)("div",{style:{fontSize:"11px",color:"#888"},children:t.variant_name})]})},{title:"Original Qty",key:"max_quantity",width:100,render:(e,t)=>(0,z.jsx)(u.A,{color:"blue",children:t.max_quantity||t.quantity})},{title:(0,z.jsx)("span",{style:{color:"red"},children:"* Return Qty"}),key:"quantity",width:120,render:(e,t,n)=>(0,z.jsx)(B.A,{min:1,max:t.max_quantity||999,precision:0,style:{width:"100%"},value:t.quantity,onChange:e=>a(n,"quantity",e||1),disabled:i})},{title:"Unit Price",key:"unit_price",width:110,render:(e,t)=>(0,z.jsxs)("span",{children:["\u20b9",Number(t.unit_price||0).toFixed(2)]})},{title:"Tax %",key:"tax_percentage",width:80,render:(e,t)=>(0,z.jsxs)("span",{children:[t.tax_percentage,"%"]})},{title:"Line Total",key:"line_total",width:120,render:(e,t)=>(0,z.jsxs)("strong",{style:{color:"#ff4d4f"},children:["\u20b9",(t.line_total||0).toLocaleString("en-IN",{minimumFractionDigits:2})]})},...s?[{title:"Condition",key:"item_condition",width:130,render:(e,t,n)=>(0,z.jsxs)(l.A,{style:{width:"100%"},value:t.item_condition||"good",onChange:e=>a(n,"item_condition",e),disabled:i,children:[(0,z.jsx)(W,{value:"good",children:(0,z.jsxs)(c.A,{children:[(0,z.jsx)(R.A,{style:{color:"#52c41a"}}),"Good"]})}),(0,z.jsx)(W,{value:"damaged",children:(0,z.jsxs)(c.A,{children:[(0,z.jsx)(V.A,{style:{color:"#faad14"}}),"Damaged"]})}),(0,z.jsx)(W,{value:"expired",children:(0,z.jsxs)(c.A,{children:[(0,z.jsx)(V.A,{style:{color:"#ff4d4f"}}),"Expired"]})}),(0,z.jsx)(W,{value:"defective",children:(0,z.jsxs)(c.A,{children:[(0,z.jsx)(V.A,{style:{color:"#ff4d4f"}}),"Defective"]})})]})}]:[],{title:"Notes",key:"condition_notes",width:200,render:(e,t,n)=>(0,z.jsx)(Z,{rows:1,placeholder:"Condition notes...",value:t.condition_notes,onChange:e=>a(n,"condition_notes",e.target.value),disabled:i})}];return(0,z.jsxs)("div",{style:{width:"100%"},children:[(0,z.jsx)("div",{style:{marginBottom:12},children:(0,z.jsx)("strong",{style:{fontSize:"14px"},children:"Return Items"})}),(0,z.jsx)(G.A,{columns:m,dataSource:t,pagination:!1,size:"small",scroll:{x:"max-content"},rowKey:(e,t)=>"item-".concat(t),bordered:!0,footer:()=>(0,z.jsx)("div",{style:{textAlign:"right"},children:(0,z.jsxs)(c.A,{direction:"vertical",size:"small",style:{width:"100%"},children:[(0,z.jsxs)("div",{style:{display:"flex",justifyContent:"flex-end",gap:"20px"},children:[(0,z.jsx)("span",{children:"Subtotal:"}),(0,z.jsxs)("strong",{children:["\u20b9",d.subtotal.toLocaleString("en-IN",{minimumFractionDigits:2})]})]}),(0,z.jsxs)("div",{style:{display:"flex",justifyContent:"flex-end",gap:"20px"},children:[(0,z.jsx)("span",{children:"Tax Amount:"}),(0,z.jsxs)("strong",{children:["\u20b9",d.taxAmount.toLocaleString("en-IN",{minimumFractionDigits:2})]})]}),(0,z.jsxs)("div",{style:{display:"flex",justifyContent:"flex-end",gap:"20px",fontSize:"16px",color:"#ff4d4f"},children:[(0,z.jsx)("span",{children:"Refund Total:"}),(0,z.jsxs)("strong",{children:["\u20b9",d.total.toLocaleString("en-IN",{minimumFractionDigits:2})]})]})]})})}),0===t.length&&(0,z.jsx)("div",{style:{textAlign:"center",padding:"40px",color:"#999"},children:"No items to return. Please select an invoice first."})]})};var Q=n(72411),H=n(98350);const J=e=>{let{open:t,onClose:n,onSelect:r}=e;const[l,s]=(0,o.useState)(""),[d,x]=(0,o.useState)(null),{data:h,isLoading:j}=H.lh.useGetSalesRecordQuery({pageNumber:1,pageLimit:100}),v=(0,o.useMemo)((()=>(null===h||void 0===h?void 0:h.result)||[]),[h]),A=(0,o.useMemo)((()=>{if(!l)return v;const e=l.toLowerCase();return v.filter((t=>{var n,r;const o=t.invoice_no||t.invoice_number||"",i=(null===(n=t.customerDetails)||void 0===n?void 0:n.full_name)||t.customer_name||"",l=(null===(r=t.customerDetails)||void 0===r?void 0:r.mobile)||t.customer_phone||"";return o.toLowerCase().includes(e)||i.toLowerCase().includes(e)||l.includes(e)}))}),[v,l]),_=[{title:"Invoice Number",key:"invoice_number",width:140,render:e=>(0,z.jsx)(u.A,{color:"blue",icon:(0,z.jsx)(D.A,{}),children:e.invoice_no||e.invoice_number||"-"})},{title:"Date",key:"invoice_date",width:120,render:e=>{const t=e.date||e.invoice_date;return t?(0,z.jsxs)("span",{children:[(0,z.jsx)(N.A,{style:{marginRight:4}}),f()(t).format("DD/MM/YYYY")]}):"-"}},{title:"Customer",key:"customer",width:200,render:e=>{var t,n;const r=(null===(t=e.customerDetails)||void 0===t?void 0:t.full_name)||e.customer_name||"-",o=(null===(n=e.customerDetails)||void 0===n?void 0:n.mobile)||e.customer_phone;return(0,z.jsxs)("div",{children:[(0,z.jsx)(Y.A,{style:{marginRight:4,color:"#1890ff"}}),(0,z.jsx)("strong",{children:r}),o&&(0,z.jsx)("div",{style:{fontSize:"11px",color:"#888"},children:o})]})}},{title:"Amount",dataIndex:"total_amount",key:"total_amount",width:120,render:e=>(0,z.jsxs)("strong",{style:{color:"#52c41a"},children:["\u20b9",Number(e||0).toLocaleString("en-IN",{minimumFractionDigits:2})]})},{title:"Items",key:"items",width:80,align:"center",render:e=>{var t,n,r;const o=(null===(t=e.Items)||void 0===t?void 0:t.length)||(null===(n=e.sales_record_items)||void 0===n?void 0:n.length)||(null===(r=e.items)||void 0===r?void 0:r.length)||0;return(0,z.jsx)(u.A,{color:"geekblue",children:o})}},{title:"Payment",dataIndex:"is_paid",key:"payment_status",width:100,render:e=>{const t=!0===e;return(0,z.jsx)(u.A,{color:t?"green":"orange",children:t?"Paid":"Pending"})}}];return(0,z.jsxs)(p.A,{title:(0,z.jsxs)(c.A,{children:[(0,z.jsx)(Q.A,{style:{color:"#1890ff"}}),(0,z.jsx)("span",{children:"Select Original Invoice"})]}),open:t,onCancel:n,width:900,footer:[(0,z.jsx)(m.Ay,{onClick:n,children:"Cancel"},"cancel"),(0,z.jsx)(m.Ay,{type:"primary",onClick:()=>{d?r(d):a.Ay.warning("Please select an invoice")},disabled:!d,children:"Select Invoice"},"select")],children:[(0,z.jsx)("div",{style:{marginBottom:16},children:(0,z.jsx)(i.A,{prefix:(0,z.jsx)(Q.A,{}),placeholder:"Search by invoice number, customer name, or phone...",value:l,onChange:e=>s(e.target.value),allowClear:!0})}),(0,z.jsx)(G.A,{columns:_,dataSource:A,loading:j,rowKey:"_id",size:"small",scroll:{y:400},pagination:{pageSize:10,showSizeChanger:!1,showTotal:e=>"Total ".concat(e," invoices")},rowSelection:{type:"radio",selectedRowKeys:d?[d._id]:[],onChange:(e,t)=>{x(t[0])}}})]})};var X=n(20691),$=n(8354),ee=n(32513);const te=e=>{var t,n,r;let{open:l,onClose:x,salesReturn:h}=e;const[j]=s.A.useForm(),[v,A]=(0,o.useState)(!1),[_,y]=(0,o.useState)(""),[f,g]=(0,o.useState)(!0),[b,{isLoading:k}]=(0,O.US)(),[S,{isLoading:w}]=(0,O.ui)();return(0,z.jsxs)(z.Fragment,{children:[(0,z.jsxs)(p.A,{title:"Approve / Reject Sales Return",open:l,onCancel:x,width:700,footer:[(0,z.jsx)(m.Ay,{danger:!0,icon:(0,z.jsx)(I.A,{}),loading:w,onClick:()=>A(!0),children:"Reject"},"reject"),(0,z.jsx)(m.Ay,{type:"primary",icon:(0,z.jsx)(R.A,{}),loading:k,onClick:async()=>{try{const e=await j.validateFields();await b({id:h._id,comments:e.comments,auto_restock:f}).unwrap(),a.Ay.success("Sales return approved successfully"),j.resetFields(),x()}catch(t){var e;a.Ay.error((null===t||void 0===t||null===(e=t.data)||void 0===e?void 0:e.message)||"Failed to approve return")}},children:"Approve & Process"},"approve")],children:[(0,z.jsxs)(X.A,{bordered:!0,column:2,size:"small",children:[(0,z.jsx)(X.A.Item,{label:"Return Number",span:2,children:(0,z.jsx)(u.A,{color:"orange",children:null===h||void 0===h?void 0:h.return_number})}),(0,z.jsx)(X.A.Item,{label:"Customer",span:2,children:null===h||void 0===h?void 0:h.customer_name}),(0,z.jsx)(X.A.Item,{label:"Invoice Number",children:(0,z.jsx)(u.A,{color:"blue",children:null===h||void 0===h?void 0:h.invoice_number})}),(0,z.jsx)(X.A.Item,{label:"Refund Type",children:(0,z.jsx)(u.A,{color:"green",children:null===h||void 0===h||null===(t=h.refund_type)||void 0===t?void 0:t.toUpperCase()})}),(0,z.jsx)(X.A.Item,{label:"Refund Amount",span:2,children:(0,z.jsxs)("strong",{style:{color:"#ff4d4f",fontSize:"16px"},children:["\u20b9",Number((null===h||void 0===h?void 0:h.refund_amount)||0).toLocaleString("en-IN",{minimumFractionDigits:2})]})}),(0,z.jsxs)(X.A.Item,{label:"Items",span:2,children:[null===h||void 0===h||null===(n=h.items)||void 0===n?void 0:n.length," items"]}),(0,z.jsxs)(X.A.Item,{label:"Return Reason",span:2,children:[(0,z.jsx)(u.A,{children:null===h||void 0===h||null===(r=h.return_reason)||void 0===r?void 0:r.replace("_"," ").toUpperCase()}),(null===h||void 0===h?void 0:h.return_reason_notes)&&(0,z.jsx)("div",{style:{marginTop:8,fontSize:"12px",color:"#666"},children:h.return_reason_notes})]})]}),(0,z.jsx)($.A,{}),(0,z.jsxs)(s.A,{form:j,layout:"vertical",children:[(0,z.jsx)(s.A.Item,{name:"comments",label:"Comments (Optional)",children:(0,z.jsx)(i.A.TextArea,{rows:3,placeholder:"Add any comments..."})}),(0,z.jsx)(s.A.Item,{children:(0,z.jsx)(ee.A,{checked:f,onChange:e=>g(e.target.checked),children:(0,z.jsxs)(c.A,{direction:"vertical",size:0,children:[(0,z.jsx)("strong",{children:"Auto-restock returned items"}),(0,z.jsx)("span",{style:{fontSize:"11px",color:"#888"},children:"Automatically add items back to inventory"})]})})}),"points"===(null===h||void 0===h?void 0:h.refund_type)&&(0,z.jsx)(d.A,{message:"Customer Points Refund",description:"".concat(Math.floor(h.refund_amount||0)," points (\u20b9").concat(Number(h.refund_amount||0).toFixed(2)," value) will be added to customer's points balance after approval."),type:"info",showIcon:!0,style:{marginTop:16}})]})]}),(0,z.jsx)(p.A,{title:"Reject Sales Return",open:v,onCancel:()=>A(!1),onOk:async()=>{try{if(!_)return void a.Ay.error("Please provide a rejection reason");await S({id:h._id,reason:_}).unwrap(),a.Ay.success("Sales return rejected"),j.resetFields(),y(""),A(!1),x()}catch(t){var e;a.Ay.error((null===t||void 0===t||null===(e=t.data)||void 0===e?void 0:e.message)||"Failed to reject return")}},confirmLoading:w,okText:"Reject",okButtonProps:{danger:!0},children:(0,z.jsx)(s.A.Item,{label:"Rejection Reason",required:!0,children:(0,z.jsx)(i.A.TextArea,{rows:4,value:_,onChange:e=>y(e.target.value),placeholder:"Enter the reason for rejecting this return..."})})})]})},ne=e=>{var t,n,r;let{open:o,onClose:i,salesReturn:l}=e;if(!l)return null;const s={draft:{color:"default",label:"Draft"},pending_approval:{color:"warning",label:"Pending Approval"},approved:{color:"success",label:"Approved"},rejected:{color:"error",label:"Rejected"},completed:{color:"green",label:"Completed"},cancelled:{color:"red",label:"Cancelled"}},a=s[l.status]||s.draft,d=[{title:"Product",key:"product",render:e=>(0,z.jsxs)("div",{children:[(0,z.jsx)("strong",{children:e.product_name}),e.variant_name&&(0,z.jsx)("div",{style:{fontSize:"11px",color:"#888"},children:e.variant_name})]})},{title:"Quantity",dataIndex:"quantity",key:"quantity",render:e=>(0,z.jsx)(u.A,{color:"orange",children:e})},{title:"Unit Price",dataIndex:"unit_price",key:"unit_price",render:e=>"\u20b9".concat(Number(e||0).toFixed(2))},{title:"Tax %",dataIndex:"tax_percentage",key:"tax_percentage",render:e=>"".concat(Number(e||0),"%")},{title:"Line Total",dataIndex:"line_total",key:"line_total",render:e=>(0,z.jsxs)("strong",{style:{color:"#ff4d4f"},children:["\u20b9",Number(e||0).toLocaleString("en-IN",{minimumFractionDigits:2})]})},{title:"Condition",dataIndex:"item_condition",key:"item_condition",render:e=>{const t={good:{color:"green",label:"Good"},damaged:{color:"orange",label:"Damaged"},expired:{color:"red",label:"Expired"},defective:{color:"red",label:"Defective"}},n=t[e]||t.good;return(0,z.jsx)(u.A,{color:n.color,children:n.label})}}];return(0,z.jsxs)(p.A,{title:(0,z.jsxs)(c.A,{children:[(0,z.jsx)(C.A,{style:{color:"#ff4d4f"}}),(0,z.jsx)("span",{children:"Sales Return Details"})]}),open:o,onCancel:i,width:1200,footer:null,children:[(0,z.jsxs)(X.A,{bordered:!0,column:2,size:"small",children:[(0,z.jsx)(X.A.Item,{label:"Return Number",span:1,children:(0,z.jsx)(u.A,{color:"orange",icon:(0,z.jsx)(C.A,{}),children:l.return_number})}),(0,z.jsx)(X.A.Item,{label:"Status",span:1,children:(0,z.jsx)(j.A,{status:a.color,text:(0,z.jsx)(u.A,{color:a.color,children:a.label})})}),(0,z.jsx)(X.A.Item,{label:"Original Invoice",span:1,children:(0,z.jsx)(u.A,{color:"blue",icon:(0,z.jsx)(D.A,{}),children:l.invoice_number})}),(0,z.jsxs)(X.A.Item,{label:"Invoice Date",span:1,children:[(0,z.jsx)(N.A,{style:{marginRight:8}}),l.invoice_date?f()(l.invoice_date).format("DD/MM/YYYY"):"-"]}),(0,z.jsxs)(X.A.Item,{label:"Customer",span:2,children:[(0,z.jsx)(Y.A,{style:{marginRight:8}}),(0,z.jsx)("strong",{children:l.customer_name}),l.customer_phone&&" - ".concat(l.customer_phone)]}),(0,z.jsxs)(X.A.Item,{label:"Return Date",children:[(0,z.jsx)(N.A,{style:{marginRight:8}}),f()(l.return_date).format("DD/MM/YYYY")]}),(0,z.jsx)(X.A.Item,{label:"Return Reason",children:(0,z.jsx)(u.A,{children:null===(t=l.return_reason)||void 0===t?void 0:t.replace("_"," ").toUpperCase()})}),l.return_reason_notes&&(0,z.jsx)(X.A.Item,{label:"Reason Details",span:2,children:l.return_reason_notes})]}),(0,z.jsx)($.A,{orientation:"left",children:"Refund Information"}),(0,z.jsxs)(X.A,{bordered:!0,column:4,size:"small",children:[(0,z.jsx)(X.A.Item,{label:"Refund Type",children:(0,z.jsx)(u.A,{color:"green",icon:(0,z.jsx)(w.A,{}),children:null===(n=l.refund_type)||void 0===n?void 0:n.toUpperCase()})}),(0,z.jsx)(X.A.Item,{label:"Refund Status",children:(0,z.jsx)(u.A,{color:"completed"===l.refund_status?"green":"orange",children:null===(r=l.refund_status)||void 0===r?void 0:r.toUpperCase()})}),(0,z.jsx)(X.A.Item,{label:"Refund Amount",span:2,children:(0,z.jsxs)("strong",{style:{color:"#ff4d4f",fontSize:"16px"},children:[(0,z.jsx)(S.A,{style:{marginRight:8}}),"\u20b9",Number(l.refund_amount||0).toLocaleString("en-IN",{minimumFractionDigits:2})]})}),l.refund_date&&(0,z.jsx)(X.A.Item,{label:"Refund Date",span:2,children:f()(l.refund_date).format("DD/MM/YYYY")}),l.refund_reference&&(0,z.jsx)(X.A.Item,{label:"Refund Reference",span:2,children:l.refund_reference}),"points"===l.refund_type&&(0,z.jsxs)(X.A.Item,{label:"Points Issued",span:4,children:[(0,z.jsxs)(u.A,{color:"orange",icon:(0,z.jsx)(w.A,{}),children:[Math.floor(Number(l.refund_amount||0))," points"]}),(0,z.jsxs)("span",{style:{marginLeft:8,color:"#888"},children:["Points added to customer balance (\u20b9",Number(l.refund_amount||0).toFixed(2)," value)"]})]})]}),(0,z.jsx)($.A,{orientation:"left",children:"Returned Items"}),(0,z.jsx)(G.A,{columns:d,dataSource:l.items||[],rowKey:(e,t)=>"item-".concat(t),pagination:!1,size:"small",bordered:!0,scroll:{x:1e3}}),l.stock_returned&&(0,z.jsxs)("div",{style:{marginTop:16,padding:"12px",background:"#f6ffed",border:"1px solid #b7eb8f",borderRadius:"4px"},children:[(0,z.jsx)(R.A,{style:{color:"#52c41a",marginRight:8}}),(0,z.jsx)("strong",{children:"Stock Returned:"})," Items have been restocked on "," ",f()(l.stock_returned_date).format("DD/MM/YYYY")]}),l.notes&&(0,z.jsxs)(z.Fragment,{children:[(0,z.jsx)($.A,{orientation:"left",children:"Notes"}),(0,z.jsx)("div",{style:{padding:"12px",background:"#fafafa",borderRadius:"4px"},children:l.notes})]}),l.approved_by_name&&(0,z.jsxs)(z.Fragment,{children:[(0,z.jsx)($.A,{orientation:"left",children:"Approval Information"}),(0,z.jsxs)(X.A,{bordered:!0,size:"small",children:[(0,z.jsx)(X.A.Item,{label:"Approved By",children:l.approved_by_name}),(0,z.jsx)(X.A.Item,{label:"Approved Date",children:f()(l.approved_date).format("DD/MM/YYYY HH:mm")})]})]})]})};var re=n(89472);const{TextArea:oe}=i.A,{Option:ie}=l.A,le=()=>{const e=(0,re.getCurrentUser)(),[t]=s.A.useForm(),[n,y]=(0,o.useState)(!1),[b,B]=(0,o.useState)(!1),[G,V]=(0,o.useState)(!1),[Z,W]=(0,o.useState)(null),[H,X]=(0,o.useState)(null),[$]=(0,O.te)(),[ee]=(0,O.US)(),[le]=(0,O.ui)(),[se]=(0,O.EZ)(),[ae]=(0,O.n6)(),de=(0,o.useCallback)((e=>{X(e),y(!1);const n=e.is_gst_included||!1,r=e.Items||e.sales_record_items||e.items||e.SalesRecordItems||[];if(r&&r.length>0){const o=r.map((e=>{var t,r,o,i,l,s;const a=(null===(t=e.productItems)||void 0===t?void 0:t.name)||e.product_name||e.name||"Unknown Product",d=(null===(r=e.productItems)||void 0===r||null===(o=r.VariantItem)||void 0===o?void 0:o.variant_name)||e.variant_name||"",c=(null===(i=e.productItems)||void 0===i||null===(l=i.CategoryItem)||void 0===l?void 0:l.tax_percentage)||e.tax_percentage||0;let u=Number(e.price||e.unit_price)||0,m=Number(e.amount||e.line_total)||0;return n&&c>0&&(u/=1+c/100,m/=1+c/100),{sales_record_item_id:e._id,product_id:e.product_id,product_name:a,variant_id:e.variant_id||(null===(s=e.productItems)||void 0===s?void 0:s.variant),variant_name:d,stock_id:e.stock_id,batch_no:e.batch_no,expiry_date:e.expiry_date,quantity:Number(e.qty||e.quantity)||1,max_quantity:Number(e.qty||e.quantity)||1,loose_qty:Number(e.loose_qty)||0,unit_price:Number(u.toFixed(2)),tax_percentage:Number(c),discount:Number(e.discount)||0,discount_type:e.discount_type||"percentage",line_total:Number(m.toFixed(2)),item_condition:"good",condition_notes:"",is_gst_included:n}}));t.setFieldsValue({items:o,invoice_selector:e._id});const i=n?" (GST Included - base price extracted)":" (GST Excluded)";a.Ay.success("Invoice loaded! ".concat(o.length," item(s) ready to return.").concat(i))}else a.Ay.error("This invoice has no items. Please select a different invoice.")}),[t]),ce=(0,o.useCallback)((function(){let e=0,t=0;(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).forEach((n=>{const r=Number(n.quantity)||0,o=Number(n.unit_price)||0,i=Number(n.tax_percentage)||0,l=Number(n.discount)||0;let s=r*o;s-="percentage"===(n.discount_type||"percentage")?s*(l/100):l,e+=s,t+=s*(i/100)}));const n=e+t;return{subtotal:Number(e.toFixed(2)),tax_amount:Number(t.toFixed(2)),total_amount:Number(n.toFixed(2))}}),[]),ue=(0,o.useMemo)((()=>{var e;return[{name:"invoice_selector",label:"Original Invoice",rules:[{required:!0,message:"Please select an invoice"}],component:(0,z.jsx)("div",{children:H?(0,z.jsx)(d.A,{message:(0,z.jsxs)(c.A,{children:[(0,z.jsx)(D.A,{}),(0,z.jsxs)("span",{children:["Invoice: ",(0,z.jsx)("strong",{children:H.invoice_no||H.invoice_number})]}),(0,z.jsxs)("span",{children:["Customer: ",(0,z.jsx)("strong",{children:(null===(e=H.customerDetails)||void 0===e?void 0:e.full_name)||H.customer_name||"N/A"})]}),(0,z.jsxs)("span",{children:["Amount: ",(0,z.jsxs)("strong",{children:["\u20b9",Number(H.total_amount||0).toFixed(2)]})]}),H.is_gst_included&&(0,z.jsx)(u.A,{color:"blue",children:"GST Included"})]}),type:"success",action:(0,z.jsx)(m.Ay,{size:"small",onClick:()=>y(!0),children:"Change"})}):(0,z.jsx)(m.Ay,{type:"dashed",block:!0,icon:(0,z.jsx)(Q.A,{}),onClick:()=>y(!0),children:"Search & Select Invoice"})}),colSpan:3},{name:"return_number",label:"Return Number",rules:[{required:!0,message:"Return number is required"}],component:(0,z.jsx)(i.A,{placeholder:"Auto-generated or enter manually"})},{name:"return_date",label:"Return Date",initialValue:f()(),rules:[{required:!0,message:"Return date is required"}],component:(0,z.jsx)(x.A,{style:{width:"100%"},format:"YYYY-MM-DD"})},{name:"return_reason",label:"Return Reason",rules:[{required:!0,message:"Return reason is required"}],component:(0,z.jsxs)(l.A,{placeholder:"Select reason",children:[(0,z.jsx)(ie,{value:"damaged",children:"Damaged / Broken"}),(0,z.jsx)(ie,{value:"wrong_item",children:"Wrong Item Delivered"}),(0,z.jsx)(ie,{value:"expired",children:"Expired Product"}),(0,z.jsx)(ie,{value:"defective",children:"Defective / Not Working"}),(0,z.jsx)(ie,{value:"customer_request",children:"Customer Request"}),(0,z.jsx)(ie,{value:"other",children:"Other"})]})},{name:"return_reason_notes",label:"Reason Details",component:(0,z.jsx)(oe,{rows:2,placeholder:"Additional details about the return..."}),colSpan:3},{name:"refund_type",label:"Refund Type",initialValue:"cash",rules:[{required:!0,message:"Refund type is required"}],component:(0,z.jsxs)(l.A,{placeholder:"Select refund method",children:[(0,z.jsx)(ie,{value:"cash",children:"\ud83d\udcb5 Cash"}),(0,z.jsx)(ie,{value:"card",children:"\ud83d\udcb3 Card"}),(0,z.jsx)(ie,{value:"upi",children:"\ud83d\udcf1 UPI"}),(0,z.jsx)(ie,{value:"points",children:"\ud83c\udfaf Customer Points (Recommended)"}),(0,z.jsx)(ie,{value:"bank_transfer",children:"\ud83c\udfe6 Bank Transfer"})]})},{name:"refund_reference",label:"Refund Reference",component:(0,z.jsx)(i.A,{placeholder:"Transaction ID, Receipt No, etc."})},{name:"refund_date",label:"Refund Date",component:(0,z.jsx)(x.A,{style:{width:"100%"},format:"YYYY-MM-DD"})},{name:"notes",label:"Notes",component:(0,z.jsx)(oe,{rows:3,placeholder:"Additional notes about the return..."}),colSpan:3},{name:"items",label:"Return Items",rules:[{required:!0,message:"At least one item is required"},{validator:async(e,t)=>{if(!t||0===t.length)throw new Error("Please select an invoice with items to return")}}],component:(0,z.jsx)(K,{showCondition:!0}),colSpan:3}]}),[H]),me=(0,o.useMemo)((()=>({onView:e=>{W(e),V(!0)},onEdit:()=>{},onDelete:async e=>a.Ay.info("Delete handled by GenericCrudPage"),onSubmit:async e=>{p.A.confirm({title:"Submit Sales Return for Approval?",content:(0,z.jsxs)("div",{children:[(0,z.jsx)("p",{children:"Once submitted, the return will be sent for approval."}),(0,z.jsx)(i.A.TextArea,{rows:2,id:"submit-comments",placeholder:"Optional comments..."})]}),onOk:async()=>{try{var t;const n=(null===(t=document.getElementById("submit-comments"))||void 0===t?void 0:t.value)||void 0;await $({id:e._id,comments:n}).unwrap(),a.Ay.success("Sales return submitted for approval")}catch(r){var n;a.Ay.error((null===r||void 0===r||null===(n=r.data)||void 0===n?void 0:n.message)||"Failed to submit return")}}})},onApprove:e=>{W(e),B(!0)},onReject:async e=>{p.A.confirm({title:"Reject Sales Return?",content:(0,z.jsxs)("div",{children:[(0,z.jsx)("p",{children:"Please provide a reason for rejection:"}),(0,z.jsx)(i.A.TextArea,{rows:3,id:"rejection-reason",placeholder:"Enter reason..."})]}),onOk:async()=>{var t;const n=null===(t=document.getElementById("rejection-reason"))||void 0===t?void 0:t.value;if(!n)return a.Ay.error("Rejection reason is required"),Promise.reject();try{await le({id:e._id,reason:n}).unwrap(),a.Ay.success("Sales return rejected")}catch(o){var r;a.Ay.error((null===o||void 0===o||null===(r=o.data)||void 0===r?void 0:r.message)||"Failed to reject return")}}})},onComplete:async e=>{p.A.confirm({title:"Mark Return as Completed?",content:"This will finalize the return process.",onOk:async()=>{try{await se({id:e._id}).unwrap(),a.Ay.success("Sales return marked as completed")}catch(n){var t;a.Ay.error((null===n||void 0===n||null===(t=n.data)||void 0===t?void 0:t.message)||"Failed to complete return")}}})},onCancel:async e=>{p.A.confirm({title:"Cancel Sales Return?",content:"Are you sure you want to cancel this return?",onOk:async()=>{try{await ae({id:e._id}).unwrap(),a.Ay.success("Sales return cancelled")}catch(n){var t;a.Ay.error((null===n||void 0===n||null===(t=n.data)||void 0===t?void 0:t.message)||"Failed to cancel return")}}})},onPrint:()=>a.Ay.info("Print functionality coming soon")})),[$,le,se,ae]),xe=(0,o.useCallback)((t=>{var n,o,i;if(!H)throw a.Ay.error("Please select an invoice first"),new Error("No invoice selected");const l=ce(t.items||[]);return(0,r.A)((0,r.A)((0,r.A)({},t),{},{sales_record_id:H._id,invoice_number:H.invoice_no||H.invoice_number,invoice_date:H.date||H.invoice_date,customer_id:H.customer_id,customer_name:(null===(n=H.customerDetails)||void 0===n?void 0:n.full_name)||H.customer_name,customer_email:(null===(o=H.customerDetails)||void 0===o?void 0:o.email)||H.customer_email,customer_phone:(null===(i=H.customerDetails)||void 0===i?void 0:i.mobile)||H.customer_phone},l),{},{refund_amount:l.total_amount,return_date:t.return_date?f()(t.return_date).format("YYYY-MM-DD"):f()().format("YYYY-MM-DD"),refund_date:t.refund_date?f()(t.refund_date).format("YYYY-MM-DD"):void 0,status:t._id?t.status:"draft",created_by_id:null===e||void 0===e?void 0:e._id,created_by_name:null===e||void 0===e?void 0:e.username})}),[H,ce,e]),pe=(0,o.useMemo)((()=>{return{title:"Sales Returns",entityName:"SalesReturn",columns:(e=me,[{title:"Return Number",dataIndex:"return_number",key:"return_number",fixed:"left",width:140,render:e=>(0,z.jsx)(u.A,{icon:(0,z.jsx)(C.A,{}),color:"orange",style:{fontSize:"12px"},children:e})},{title:"Status",dataIndex:"status",key:"status",width:160,filters:Object.keys(L).map((e=>({text:L[e].label,value:e}))),onFilter:(e,t)=>t.status===e,render:e=>{const t=L[e]||L.draft;return(0,z.jsx)(j.A,{status:t.color,text:(0,z.jsx)(u.A,{color:t.color,icon:t.icon,children:t.label})})}},{title:"Return Date",dataIndex:"return_date",key:"return_date",width:120,sorter:(e,t)=>f()(e.return_date).unix()-f()(t.return_date).unix(),render:e=>(0,z.jsxs)("span",{children:[(0,z.jsx)(N.A,{style:{marginRight:4}}),f()(e).format("DD/MM/YYYY")]})},{title:"Original Invoice",dataIndex:"invoice_number",key:"invoice_number",width:140,render:(e,t)=>(0,z.jsx)(v.A,{title:"Invoice Date: ".concat(t.invoice_date?f()(t.invoice_date).format("DD/MM/YYYY"):"-"),children:(0,z.jsx)(u.A,{color:"blue",icon:(0,z.jsx)(D.A,{}),children:e||"-"})})},{title:"Customer",dataIndex:"CustomerItem",key:"customer",width:180,render:(e,t)=>{const n=e||{customer_name:t.customer_name};return(0,z.jsx)(v.A,{title:n.email||n.phone,children:(0,z.jsxs)("div",{children:[(0,z.jsx)(Y.A,{style:{marginRight:4,color:"#1890ff"}}),(0,z.jsx)("strong",{children:n.customer_name||t.customer_name||"-"}),n.phone&&(0,z.jsx)("div",{style:{fontSize:"11px",color:"#888"},children:n.phone})]})})}},{title:"Items Returned",dataIndex:"items",key:"items_count",width:100,align:"center",render:e=>(0,z.jsxs)(u.A,{color:"orange",children:[(null===e||void 0===e?void 0:e.length)||0," items"]})},{title:"Refund Type",dataIndex:"refund_type",key:"refund_type",width:130,filters:Object.keys(U).map((e=>({text:U[e].label,value:e}))),onFilter:(e,t)=>t.refund_type===e,render:e=>{const t=U[e]||U.cash;return(0,z.jsx)(u.A,{color:t.color,icon:t.icon,children:t.label})}},{title:"Refund Amount",dataIndex:"refund_amount",key:"refund_amount",width:130,sorter:(e,t)=>(Number(e.refund_amount)||0)-(Number(t.refund_amount)||0),render:(e,t)=>(0,z.jsxs)("div",{children:[(0,z.jsxs)("span",{style:{fontWeight:"bold",color:"#ff4d4f"},children:[(0,z.jsx)(S.A,{style:{marginRight:4}}),"\u20b9",Number(e||0).toLocaleString("en-IN",{minimumFractionDigits:2})]}),(0,z.jsx)("div",{style:{fontSize:"11px",color:"#888"},children:"completed"===t.refund_status?(0,z.jsx)(u.A,{color:"green",style:{marginTop:2},children:"Paid"}):(0,z.jsx)(u.A,{color:"orange",style:{marginTop:2},children:"Pending"})})]})},{title:"Points Issued",key:"points_issued",width:130,render:e=>{if("points"!==e.refund_type)return(0,z.jsx)("span",{style:{color:"#999"},children:"-"});const t=Math.floor(Number(e.refund_amount||0));return(0,z.jsx)(v.A,{title:"Points added to customer balance",children:(0,z.jsxs)(u.A,{color:"orange",icon:(0,z.jsx)(w.A,{}),children:[t," pts (\u20b9",t,")"]})})}},{title:"Stock Returned",key:"stock_returned",width:120,align:"center",render:e=>e.stock_returned?(0,z.jsx)(u.A,{color:"green",icon:(0,z.jsx)(R.A,{}),children:"Restocked"}):(0,z.jsx)(u.A,{color:"default",children:"Not Restocked"})},{title:"Created By",dataIndex:"created_by_name",key:"created_by",width:120,render:e=>(0,z.jsx)("span",{style:{fontSize:"12px"},children:e||"-"})},{title:"Actions",key:"actions",fixed:"right",width:120,render:t=>{const n=(0,E.Tt)(E.eZ.SALES_RETURN),r=(0,E.Ev)(E.eZ.SALES_RETURN),o=(0,E.W9)(E.eZ.SALES_RETURN),i="draft"===t.status,l="draft"===t.status,s=r&&i,a=o&&l,d=(0,z.jsxs)(A.A,{children:[n&&(0,z.jsx)(A.A.Item,{icon:(0,z.jsx)(F.A,{}),onClick:()=>e.onView(t),children:"View Details"},"view"),r&&(0,z.jsx)(A.A.Item,{icon:(0,z.jsx)(T.A,{}),onClick:()=>e.onSubmit(t),style:{color:"#1890ff"},disabled:"draft"!==t.status,children:"Submit for Approval"},"submit"),r&&(0,z.jsx)(A.A.Item,{icon:(0,z.jsx)(P.A,{}),onClick:()=>e.onApprove(t),style:{color:"#52c41a"},disabled:"pending_approval"!==t.status,children:"Approve Return"},"approve"),r&&(0,z.jsx)(A.A.Item,{icon:(0,z.jsx)(I.A,{}),onClick:()=>e.onReject(t),danger:!0,disabled:!["pending_approval","approved"].includes(t.status),children:"Reject Return"},"reject"),r&&(0,z.jsx)(A.A.Item,{icon:(0,z.jsx)(R.A,{}),onClick:()=>e.onComplete(t),style:{color:"#52c41a"},disabled:"approved"!==t.status,children:"Mark Completed"},"complete"),n&&(0,z.jsx)(A.A.Item,{icon:(0,z.jsx)(D.A,{}),onClick:()=>e.onPrint(t),children:"Print / Download"},"print"),r&&(0,z.jsxs)(z.Fragment,{children:[(0,z.jsx)(A.A.Divider,{}),(0,z.jsx)(A.A.Item,{icon:(0,z.jsx)(k.A,{}),onClick:()=>{window.confirm("Cancel this Return?")&&e.onCancel(t)},danger:!0,disabled:["completed","cancelled"].includes(t.status),children:"Cancel Return"},"cancel")]})]});return n||r||o?(0,z.jsxs)(c.A,{size:"small",children:[r&&(0,z.jsx)(v.A,{title:s?"Edit":"Edit (not available for this status)",children:(0,z.jsx)(m.Ay,{type:"link",size:"small",icon:(0,z.jsx)(g.A,{}),onClick:()=>e.onEdit(t),disabled:!s})}),o&&(0,z.jsx)(v.A,{title:a?"Delete":"Delete (only Draft can be deleted)",children:(0,z.jsx)(m.Ay,{type:"link",size:"small",danger:!0,icon:(0,z.jsx)(q.A,{}),onClick:()=>e.onDelete(t),disabled:!a})}),(n||r)&&(0,z.jsx)(_.A,{overlay:d,trigger:["click"],placement:"bottomRight",children:(0,z.jsx)(v.A,{title:"Return Actions",children:(0,z.jsx)(m.Ay,{type:"primary",size:"small",icon:(0,z.jsx)(M.A,{})})})})]}):null}}]),formItems:ue,formColumns:3,drawerWidth:1400,form:t,beforeSave:xe,canCreate:()=>(0,E.BA)(E.eZ.SALES_RETURN),canEdit:e=>{const t=(0,E.Ev)(E.eZ.SALES_RETURN),n="draft"===(null===e||void 0===e?void 0:e.status);return t&&n},canDelete:e=>{const t=(0,E.W9)(E.eZ.SALES_RETURN),n="draft"===(null===e||void 0===e?void 0:e.status);return t&&n}};var e}),[me,ue,xe,t]);return(0,z.jsxs)(z.Fragment,{children:[(0,z.jsx)(h.r,{config:pe}),(0,z.jsx)(J,{open:n,onClose:()=>y(!1),onSelect:de}),(0,z.jsx)(te,{open:b,onClose:()=>{B(!1),W(null)},salesReturn:Z}),(0,z.jsx)(ne,{open:G,onClose:()=>{V(!1),W(null)},salesReturn:Z})]})}}}]);
//# sourceMappingURL=6532.b15c5ab2.chunk.js.map