/*! For license information please see 3116.12f884f5.chunk.js.LICENSE.txt */
"use strict";(self.webpackChunkSUBRIVA_BILLING=self.webpackChunkSUBRIVA_BILLING||[]).push([[3116],{6004:(e,r,t)=>{t.d(r,{A:()=>p});var s=t(56403),n=t(16569);const a=500,o=503;var i=t(89472),c=t(26167);const l=class{constructor(e){this.api=void 0,this.isRefreshing=!1,this.refreshSubscribers=[],this.hasShownSessionExpiredMessage=!1,this.api=s.A.create({baseURL:e,timeout:6e4,headers:{"Content-Type":"application/json"}}),this.api.interceptors.request.use((e=>{const r=(0,i.getAuthToken)();if(r&&(e.headers.Token=r,e.headers.Authorization="Bearer ".concat(r)),e.method&&["post","put","patch","delete"].includes(e.method.toLowerCase())){const r=(0,c.m5)();e.headers["X-CSRF-Token"]=r}return e})),this.api.interceptors.response.use((e=>e),(async e=>{const r=e.config;if(e.response&&401===e.response.status&&!r._retry){var t,s;const o=(null===(t=e.response.data)||void 0===t?void 0:t.exception)||(null===(s=e.response.data)||void 0===s?void 0:s.message)||"";if(o.toLowerCase().includes("access denied")||o.toLowerCase().includes("insufficient permissions")||o.toLowerCase().includes("permission"))return n.Ay.error({content:"You do not have permission to perform this action.",duration:5}),Promise.reject(e);if(this.isRefreshing)return new Promise((e=>{this.refreshSubscribers.push((t=>{r.headers&&(r.headers.Token=t,r.headers.Authorization="Bearer ".concat(t)),e(this.api.request(r))}))}));r._retry=!0,this.isRefreshing=!0;try{const e=await this.refreshAccessToken();if(e)return r.headers&&(r.headers.Token=e,r.headers.Authorization="Bearer ".concat(e)),this.refreshSubscribers.forEach((r=>r(e))),this.refreshSubscribers=[],this.api.request(r)}catch(a){return console.error("Token refresh failed:",a),this.hasShownSessionExpiredMessage||(this.hasShownSessionExpiredMessage=!0,n.Ay.error("Your session has expired. Please login again.")),(0,i.clearAuthData)(),window.location.href="#/billing_login",Promise.reject(a)}finally{this.isRefreshing=!1}}return Promise.reject(e)}))}async refreshAccessToken(){const e=(0,i.getRefreshToken)();if(!e)return console.warn("No refresh token available"),null;try{var r;const t=await s.A.post("".concat(this.api.defaults.baseURL,"/auth/refresh-token"),{refreshToken:e},{headers:{"Content-Type":"application/json"}});if(200===(null===(r=t.data)||void 0===r?void 0:r.statusCode)){const{accessToken:e,refreshToken:r}=t.data.result;return(0,i.setAccessToken)(e),r&&(0,i.setRefreshToken)(r),e}return null}catch(t){throw console.error("Failed to refresh access token:",t),t}}async send(e){try{const{data:r}=await this.api.request({method:e.method,url:e.endpoint,data:e.data,signal:e.signal});return this.handleResponse(r)}catch(r){return s.A.isAxiosError(r)&&"CanceledError"===r.name?{statusCode:0,message:"Request cancelled",result:null,pagination:{}}:this.handleError(r)}}handleResponse(e){if(401===e.statusCode){const r=e.exception||e.message||"";return r.toLowerCase().includes("access denied")||r.toLowerCase().includes("insufficient permissions")||r.toLowerCase().includes("permission")?(n.Ay.error({content:"You do not have permission to perform this action.",duration:5}),e):(this.hasShownSessionExpiredMessage||(this.hasShownSessionExpiredMessage=!0,n.Ay.error("Your session has expired. Please login again.")),(0,i.clearAuthData)(),window.location.href="#/billing_login",e)}return{statusCode:e.statusCode,message:e.message,result:e.result,pagination:e.pagination}}handleError(e){let r="API call failed",t=a;var n;if(s.A.isAxiosError(e))if(e.response)t=e.response.status,r=(null===(n=e.response.data)||void 0===n?void 0:n.message)||"An error occurred";else if(e.request){var i;r="No response received from server",t=null!==(i=o)&&void 0!==i?i:503}else r=e.message;return{statusCode:t,message:r,result:null,pagination:{}}}};const d=new class{constructor(){this.backendUrl=null,this.isElectron=!1,this.isElectron=this.checkIfElectron(),this.initializeBackendUrl()}checkIfElectron(){return!(!window||!window.electronAPI)}async initializeBackendUrl(){if(this.isElectron&&window.electronAPI)try{this.backendUrl=await window.electronAPI.getBackendUrl()}catch(e){console.error("Failed to get backend URL from Electron:",e),this.backendUrl="http://localhost:8247"}else this.backendUrl="http://localhost:8247"}async getBackendUrl(){return this.backendUrl||await this.initializeBackendUrl(),this.backendUrl||"https://www.subrivabilling.com/api/"}async getApiUrl(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";const r=await this.getBackendUrl(),t=e.startsWith("/")?e:"/".concat(e);return"".concat(r,"/api").concat(t)}isElectronApp(){return this.isElectron}async waitForBackend(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3e4;const r=Date.now(),t=await this.getBackendUrl();for(;Date.now()-r<e;){try{if((await fetch("".concat(t,"/api/health"),{method:"GET",headers:{"Content-Type":"application/json"}})).ok)return!0}catch(s){}await new Promise((e=>setTimeout(e,500)))}return!1}async getAppVersion(){if(this.isElectron&&window.electronAPI)try{return await window.electronAPI.getAppVersion()}catch(e){return console.error("Failed to get app version:",e),"Unknown"}return"Web Version"}getPlatform(){return this.isElectron&&window.electronAPI?window.electronAPI.platform:"web"}};var u=t(79711);let h=null;const p=async e=>{const r=await(async()=>{if(!h){let e;e=d.isElectronApp()?await d.getBackendUrl():(0,u.getActiveApiUrl)(),h=new l(e)}return h})();return await r.send(e)}},73847:(e,r,t)=>{t.d(r,{A:()=>c});var s=t(65043),n=t(78500),a=t(66381);function o(){return o=Object.assign?Object.assign.bind():function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s])}return e},o.apply(this,arguments)}const i=(e,r)=>s.createElement(a.A,o({},e,{ref:r,icon:n.A}));const c=s.forwardRef(i)},83116:(e,r,t)=>{t.r(r),t.d(r,{default:()=>z});var s=t(65043),n=t(89379),a=t(62305),o=t(16569),i=t(62751),c=t(33359),l=t(9316),d=t(73847),u=t(4413),h=t(22671),p=t(71782),g=t(36621),m=t(26553),y=t(8354),f=t(6051),A=t(76399),x=t(89073),b=t(47419),k=t(11645),w=t(32513);const _=[{resource:"dashboard",label:"Dashboard",category:"Core",description:"Main dashboard view",menus:["dashboard"]},{resource:"sales_record",label:"Sales Records",category:"Sales",description:"Controls: SalesRecords menu, Create Sales, Sales List",menus:["SalesRecords","create-sales-record","sales-records-list"]},{resource:"quotation",label:"Quotations",category:"Sales",description:"Quotation/Estimate management for sales process",menus:["quotations"]},{resource:"sales_return",label:"Sales Returns",category:"Sales",description:"Customer returns and refund management",menus:["sales-returns-list","create-sales-return"]},{resource:"customer_points",label:"Customer Points",category:"Sales",description:"Unified points system for rewards and refunds",menus:["customer-points"]},{resource:"customer",label:"Customers",category:"Sales",description:"Customer management",menus:["add-customer"]},{resource:"vendor",label:"Vendors",category:"Procurement",description:"Vendor management",menus:["vendor"]},{resource:"purchase_order",label:"Purchase Orders",category:"Procurement",description:"Purchase order management with approval workflow",menus:["purchase-orders"]},{resource:"product",label:"Products",category:"Inventory",description:"Product management",menus:["add-product"]},{resource:"unit",label:"Units",category:"Inventory",description:"Unit management",menus:["unit"]},{resource:"category",label:"Categories",category:"Inventory",description:"Category management",menus:["category"]},{resource:"variant",label:"Variants",category:"Inventory",description:"Variant management",menus:["variant"]},{resource:"warehouse",label:"Warehouses",category:"Inventory",description:"Warehouse management",menus:["warehouse"]},{resource:"rack",label:"Racks",category:"Inventory",description:"Rack management",menus:["rack"]},{resource:"stock_audit",label:"Stock In / Org Stock",category:"Stock",description:"Controls: Stock In, Organisation Stock Available",menus:["stock-in","organisation-stock-available"]},{resource:"stock_out",label:"Stock Out",category:"Stock",description:"Stock out management",menus:["stock-out"]},{resource:"branch_stock",label:"Branch Stock",category:"Stock",description:"Controls: Branch Stock, Branch Stock Available",menus:["branch-stock","branch-stock-available"]},{resource:"storage_stock",label:"Storage Stock",category:"Stock",description:"Storage stock list",menus:["storage-stock-list"]},{resource:"payment_history",label:"Payment History",category:"Financial",description:"Payment history management",menus:["payment-history"]},{resource:"expense",label:"Expenses",category:"Financial",description:"Expense management",menus:["expenses"]},{resource:"reports",label:"Reports",category:"Reports",description:"All reports",menus:["reports","report"]},{resource:"custom_entities",label:"Custom Forms",category:"Advanced",description:"Custom entity management",menus:["custom_forms"]},{resource:"settings",label:"Settings",category:"Settings",description:"Application settings",menus:["settings"]},{resource:"organisation",label:"Organisation",category:"Master Settings",description:"Organisation management",menus:["organisation"]},{resource:"branch",label:"Branches",category:"Master Settings",description:"Branch management",menus:["braches"]},{resource:"billing_user",label:"Users",category:"Master Settings",description:"User management",menus:["users"]},{resource:"role",label:"Roles",category:"Master Settings",description:"Role management",menus:["roles"]},{resource:"permission",label:"Permissions",category:"Master Settings",description:"Permission management",menus:["permissions"]}];let j=null;new Map;var v=t(98350),S=t(70579);const{Title:C,Text:E}=p.A,{TextArea:R}=g.A,P=e=>{let{form:r,initialPermissions:t={},onPermissionsChange:o}=e;const[i,c]=(0,s.useState)(t),l=j||(j=_.reduce(((e,r)=>(e[r.category]||(e[r.category]=[]),e[r.category].push(r),e)),{}),j),{data:d,isLoading:u}=v.lh.useGetRoleTypeQuery({}),h=(0,s.useMemo)((()=>{var e;return(null===d||void 0===d||null===(e=d.result)||void 0===e?void 0:e.map((e=>({label:e.name,value:e.name}))))||[]}),[d]);(0,s.useEffect)((()=>{Object.keys(t).length>0&&c(t)}),[t]),(0,s.useEffect)((()=>{o&&o(i)}),[i,o]);const p=(e,r,t)=>{c((s=>(0,n.A)((0,n.A)({},s),{},{[e]:(0,n.A)((0,n.A)({},s[e]||{can_create:!1,can_read:!1,can_update:!1,can_delete:!1}),{},{[r]:t})})))},P=(e,r)=>{const t=(0,n.A)({},i);_.forEach((s=>{t[s.resource]||(t[s.resource]={can_create:!1,can_read:!1,can_update:!1,can_delete:!1}),t[s.resource][e]=r})),c(t)},T=()=>Object.entries(i).filter((e=>{let[r,t]=e;return t.can_create||t.can_read||t.can_update||t.can_delete})).map((e=>{let[r,t]=e;return{resource:r,can_create:t.can_create||!1,can_read:t.can_read||!1,can_update:t.can_update||!1,can_delete:t.can_delete||!1}}));return(0,s.useEffect)((()=>{r&&(r.getPermissionsArray=T)}),[i,r]),(0,S.jsxs)("div",{style:{width:"100%"},children:[(0,S.jsx)(a.A.Item,{label:"Role Name",name:"name",rules:[{required:!0,message:"Please enter role name!"}],children:(0,S.jsx)(g.A,{placeholder:"Enter role name"})}),(0,S.jsx)(a.A.Item,{label:"Role Type",name:"roles_type",rules:[{required:!0,message:"Please select role type!"}],children:(0,S.jsx)(m.A,{placeholder:"Select role type",allowClear:!0,showSearch:!0,optionFilterProp:"children",loading:u,children:h.map((e=>(0,S.jsx)(m.A.Option,{value:e.value,children:e.label},e.value)))})}),(0,S.jsx)(a.A.Item,{label:"Description",name:"description",children:(0,S.jsx)(R,{rows:3,placeholder:"Enter role description (optional)"})}),(0,S.jsx)(y.A,{orientation:"left",children:(0,S.jsxs)(f.A,{children:[(0,S.jsx)(C,{level:5,style:{margin:0},children:"Permissions (CRUD)"}),(0,S.jsx)(A.A,{color:"blue",children:"Select permissions for each resource"})]})}),(0,S.jsx)(x.A,{size:"small",style:{marginBottom:16,background:"#f0f2f5"},children:(0,S.jsxs)(b.A,{gutter:16,align:"middle",children:[(0,S.jsx)(k.A,{span:8,children:(0,S.jsx)(E,{strong:!0,children:"Select All:"})}),(0,S.jsx)(k.A,{span:4,style:{textAlign:"center"},children:(0,S.jsx)(w.A,{onChange:e=>P("can_create",e.target.checked),children:(0,S.jsx)(E,{strong:!0,children:"Create"})})}),(0,S.jsx)(k.A,{span:4,style:{textAlign:"center"},children:(0,S.jsx)(w.A,{onChange:e=>P("can_read",e.target.checked),children:(0,S.jsx)(E,{strong:!0,children:"Read"})})}),(0,S.jsx)(k.A,{span:4,style:{textAlign:"center"},children:(0,S.jsx)(w.A,{onChange:e=>P("can_update",e.target.checked),children:(0,S.jsx)(E,{strong:!0,children:"Update"})})}),(0,S.jsx)(k.A,{span:4,style:{textAlign:"center"},children:(0,S.jsx)(w.A,{onChange:e=>P("can_delete",e.target.checked),children:(0,S.jsx)(E,{strong:!0,children:"Delete"})})})]})}),(0,S.jsx)("div",{style:{maxHeight:"500px",overflowY:"auto",paddingRight:8},children:Object.entries(l).map((e=>{let[r,t]=e;return(0,S.jsx)(x.A,{title:(0,S.jsx)(E,{strong:!0,children:r}),size:"small",style:{marginBottom:16},children:t.map((e=>{const r=i[e.resource]||{can_create:!1,can_read:!1,can_update:!1,can_delete:!1},t=r.can_create&&r.can_read&&r.can_update&&r.can_delete;return(0,S.jsxs)(b.A,{gutter:16,align:"middle",style:{marginBottom:12,padding:8,borderBottom:"1px solid #f0f0f0"},children:[(0,S.jsx)(k.A,{span:8,children:(0,S.jsxs)(f.A,{direction:"vertical",size:0,children:[(0,S.jsxs)(f.A,{children:[(0,S.jsx)(E,{strong:!0,children:e.label}),(0,S.jsx)(w.A,{checked:t,onChange:r=>{return t=e.resource,s=r.target.checked,void c((e=>(0,n.A)((0,n.A)({},e),{},{[t]:{can_create:s,can_read:s,can_update:s,can_delete:s}})));var t,s},style:{fontSize:11},children:(0,S.jsx)(E,{type:"secondary",style:{fontSize:11},children:"All"})})]}),(0,S.jsx)(E,{type:"secondary",style:{fontSize:11},children:e.description})]})}),(0,S.jsx)(k.A,{span:4,style:{textAlign:"center"},children:(0,S.jsx)(w.A,{checked:r.can_create,onChange:r=>p(e.resource,"can_create",r.target.checked)})}),(0,S.jsx)(k.A,{span:4,style:{textAlign:"center"},children:(0,S.jsx)(w.A,{checked:r.can_read,onChange:r=>p(e.resource,"can_read",r.target.checked)})}),(0,S.jsx)(k.A,{span:4,style:{textAlign:"center"},children:(0,S.jsx)(w.A,{checked:r.can_update,onChange:r=>p(e.resource,"can_update",r.target.checked)})}),(0,S.jsx)(k.A,{span:4,style:{textAlign:"center"},children:(0,S.jsx)(w.A,{checked:r.can_delete,onChange:r=>p(e.resource,"can_delete",r.target.checked)})})]},e.resource)}))},r)}))}),(0,S.jsx)(a.A.Item,{name:"permissions",hidden:!0,children:(0,S.jsx)(g.A,{type:"hidden"})})]})},T=[{title:"Role Name",dataIndex:"name",key:"name",render:e=>(0,S.jsx)("strong",{children:e})},{title:"Role Type",dataIndex:"roles_type",key:"roles_type",render:e=>(0,S.jsx)("span",{style:{padding:"4px 8px",borderRadius:"4px",fontSize:"12px",fontWeight:"500",backgroundColor:"Admin"===e?"#f6ffed":"#fff7e6",color:"Admin"===e?"#52c41a":"#fa8c16",border:"1px solid ".concat("Admin"===e?"#b7eb8f":"#ffd591")},children:e})},{title:"Description",dataIndex:"description",key:"description",ellipsis:!0}];var U=t(6004);const I=()=>{const[e]=a.A.useForm(),[r,t]=(0,s.useState)([]),[p,g]=(0,s.useState)(!1),[m,y]=(0,s.useState)(!1),[f,A]=(0,s.useState)(null),[x,b]=(0,s.useState)({}),[k,w]=(0,s.useState)(!1),[_,j]=(0,s.useState)({current:1,pageSize:10,total:0});(0,s.useEffect)((()=>{v()}),[_.current,_.pageSize]);const v=async()=>{g(!0);try{const e=await(0,U.A)({method:"GET",endpoint:"/roles",data:{pageNumber:_.current,pageLimit:_.pageSize}});if(200===e.statusCode){t(e.result||[]);const r=e.pagination;j((t=>{var s;return(0,n.A)((0,n.A)({},t),{},{total:(null===r||void 0===r?void 0:r.totalCount)||(null===r||void 0===r?void 0:r.total)||(null===(s=e.result)||void 0===s?void 0:s.length)||0})}))}else o.Ay.error("Failed to fetch roles: ".concat(e.message||"Unknown error"))}catch(e){console.error("Error fetching roles:",e),o.Ay.error("Error fetching roles")}finally{g(!1)}},C=()=>{y(!1),e.resetFields(),b({}),A(null)},E=[...T,{title:"Actions",key:"actions",render:(r,t)=>(0,S.jsxs)("div",{style:{display:"flex",gap:"16px",justifyContent:"center"},children:[(0,S.jsx)(c.A,{style:{cursor:"pointer",color:"#1890ff",fontSize:"16px"},onClick:()=>(async r=>{A(r),e.setFieldsValue({name:r.name,description:r.description,roles_type:r.roles_type});try{const e=await(0,U.A)({method:"GET",endpoint:"/permissions/role/".concat(r._id)});if(200===e.statusCode){var t;const r=(null===(t=e.result)||void 0===t?void 0:t.resources)||[],s={};r.forEach((e=>{s[e.resource]={can_create:e.can_create,can_read:e.can_read,can_update:e.can_update,can_delete:e.can_delete}})),b(s)}}catch(s){console.error("Error fetching role permissions:",s),o.Ay.warning("Could not load permissions for this role")}y(!0)})(t)}),(0,S.jsx)(l.A,{style:{cursor:"pointer",color:"#ff4d4f",fontSize:"16px"},onClick:()=>(async e=>{i.A.confirm({title:"Delete Role",content:'Are you sure you want to delete role "'.concat(e.name,'"?'),okText:"Yes",okType:"danger",cancelText:"No",onOk:async()=>{try{const r=await(0,U.A)({method:"DELETE",endpoint:"/roles/".concat(e._id)});200===r.statusCode?(o.Ay.success("Role deleted successfully"),v()):o.Ay.error("Failed to delete role: ".concat(r.message||"Unknown error"))}catch(r){console.error("Error deleting role:",r),o.Ay.error("Error deleting role")}}})})(t)})]})}];return(0,S.jsxs)("div",{children:[(0,S.jsxs)("div",{style:{marginBottom:16,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,S.jsx)("h1",{style:{margin:0},children:"Roles"}),(0,S.jsxs)("button",{onClick:()=>{A(null),b({}),e.resetFields(),y(!0)},style:{padding:"8px 16px",background:"#1890ff",color:"white",border:"none",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",gap:"8px"},children:[(0,S.jsx)(d.A,{})," Add Role"]})]}),(0,S.jsx)(u.A,{columns:E,data:r,loading:p,totalCount:_.total,pageLimit:_.pageSize,onPaginationChange:(e,r)=>{j((t=>(0,n.A)((0,n.A)({},t),{},{current:e,pageSize:r})))},rowKeyField:"_id"}),(0,S.jsx)(h.A,{title:f?"Edit Role":"Create Role",open:m,onClose:C,width:900,children:(0,S.jsxs)(a.A,{form:e,layout:"vertical",onFinish:async()=>{try{const r=await e.validateFields(),t=Object.entries(x).filter((e=>{let[r,t]=e;return t.can_create||t.can_read||t.can_update||t.can_delete})).map((e=>{let[r,t]=e;return{resource:r,can_create:t.can_create||!1,can_read:t.can_read||!1,can_update:t.can_update||!1,can_delete:t.can_delete||!1}}));if(0===t.length)return void o.Ay.warning("Please select at least one permission");const s={name:r.name,description:r.description,roles_type:r.roles_type,permissions:t};if(w(!0),f){const r=await(0,U.A)({method:"PATCH",endpoint:"/roles/".concat(f._id),data:s});200===r.statusCode?(o.Ay.success("Role updated successfully"),y(!1),e.resetFields(),b({}),v()):o.Ay.error("Failed to update role: ".concat(r.message||"Unknown error"))}else{const r=await(0,U.A)({method:"PUT",endpoint:"/roles",data:s});201===r.statusCode||200===r.statusCode?(o.Ay.success("Role created successfully"),y(!1),e.resetFields(),b({}),v()):o.Ay.error("Failed to create role: ".concat(r.message||"Unknown error"))}}catch(r){console.error("Error submitting role:",r),r.errorFields?o.Ay.error("Please fill in all required fields"):o.Ay.error("Error submitting role")}finally{w(!1)}},children:[(0,S.jsx)(P,{form:e,initialPermissions:x,onPermissionsChange:b}),(0,S.jsxs)("div",{style:{marginTop:24,display:"flex",justifyContent:"flex-end",gap:12},children:[(0,S.jsx)("button",{type:"button",onClick:C,style:{padding:"8px 24px",background:"#fff",color:"#000",border:"1px solid #d9d9d9",borderRadius:"4px",cursor:"pointer"},children:"Cancel"}),(0,S.jsx)("button",{type:"submit",disabled:k,style:{padding:"8px 24px",background:k?"#d9d9d9":"#1890ff",color:"white",border:"none",borderRadius:"4px",cursor:k?"not-allowed":"pointer"},children:k?"Submitting...":"Submit"})]})]})})]})},B=(0,s.memo)(I),F=()=>(0,S.jsx)(B,{}),z=(0,s.memo)(F)}}]);
//# sourceMappingURL=3116.12f884f5.chunk.js.map