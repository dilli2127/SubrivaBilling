/*! For license information please see 116.98ff364c.chunk.js.LICENSE.txt */
"use strict";(self.webpackChunkSUBRIVA_BILLING=self.webpackChunkSUBRIVA_BILLING||[]).push([[116,847],{6004:(e,t,r)=>{r.d(t,{A:()=>h});var s=r(56403),n=r(16569);const a=500,o=503;var i=r(89472),c=r(26167);const l=class{constructor(e){this.api=void 0,this.isRefreshing=!1,this.refreshSubscribers=[],this.hasShownSessionExpiredMessage=!1,this.api=s.A.create({baseURL:e,timeout:6e4,headers:{"Content-Type":"application/json"}}),this.api.interceptors.request.use((e=>{const t=(0,i.c4)();if(t&&(e.headers.Token=t,e.headers.Authorization="Bearer ".concat(t)),e.method&&["post","put","patch","delete"].includes(e.method.toLowerCase())){const t=(0,c.m5)();e.headers["X-CSRF-Token"]=t}return e})),this.api.interceptors.response.use((e=>e),(async e=>{const t=e.config;if(e.response&&401===e.response.status&&!t._retry){var r,s;const o=(null===(r=e.response.data)||void 0===r?void 0:r.exception)||(null===(s=e.response.data)||void 0===s?void 0:s.message)||"";if(o.toLowerCase().includes("access denied")||o.toLowerCase().includes("insufficient permissions")||o.toLowerCase().includes("permission"))return n.Ay.error({content:"You do not have permission to perform this action.",duration:5}),Promise.reject(e);if(this.isRefreshing)return new Promise((e=>{this.refreshSubscribers.push((r=>{t.headers&&(t.headers.Token=r,t.headers.Authorization="Bearer ".concat(r)),e(this.api.request(t))}))}));t._retry=!0,this.isRefreshing=!0;try{const e=await this.refreshAccessToken();if(e)return t.headers&&(t.headers.Token=e,t.headers.Authorization="Bearer ".concat(e)),this.refreshSubscribers.forEach((t=>t(e))),this.refreshSubscribers=[],this.api.request(t)}catch(a){return console.error("Token refresh failed:",a),this.hasShownSessionExpiredMessage||(this.hasShownSessionExpiredMessage=!0,n.Ay.error("Your session has expired. Please login again.")),(0,i.m_)(),window.location.href="#/billing_login",Promise.reject(a)}finally{this.isRefreshing=!1}}return Promise.reject(e)}))}async refreshAccessToken(){const e=(0,i.ve)();if(!e)return console.warn("No refresh token available"),null;try{var t;const r=await s.A.post("".concat(this.api.defaults.baseURL,"/auth/refresh-token"),{refreshToken:e},{headers:{"Content-Type":"application/json"}});if(200===(null===(t=r.data)||void 0===t?void 0:t.statusCode)){const{accessToken:e,refreshToken:t}=r.data.result;return(0,i.ki)(e),t&&(0,i.fE)(t),e}return null}catch(r){throw console.error("Failed to refresh access token:",r),r}}async send(e){try{const{data:t}=await this.api.request({method:e.method,url:e.endpoint,data:e.data,signal:e.signal});return this.handleResponse(t)}catch(t){return s.A.isAxiosError(t)&&"CanceledError"===t.name?{statusCode:0,message:"Request cancelled",result:null,pagination:{}}:this.handleError(t)}}handleResponse(e){if(401===e.statusCode){const t=e.exception||e.message||"";return t.toLowerCase().includes("access denied")||t.toLowerCase().includes("insufficient permissions")||t.toLowerCase().includes("permission")?(n.Ay.error({content:"You do not have permission to perform this action.",duration:5}),e):(this.hasShownSessionExpiredMessage||(this.hasShownSessionExpiredMessage=!0,n.Ay.error("Your session has expired. Please login again.")),(0,i.m_)(),window.location.href="#/billing_login",e)}return{statusCode:e.statusCode,message:e.message,result:e.result,pagination:e.pagination}}handleError(e){let t="API call failed",r=a;var n;if(s.A.isAxiosError(e))if(e.response)r=e.response.status,t=(null===(n=e.response.data)||void 0===n?void 0:n.message)||"An error occurred";else if(e.request){var i;t="No response received from server",r=null!==(i=o)&&void 0!==i?i:503}else t=e.message;return{statusCode:r,message:t,result:null,pagination:{}}}};const d=new class{constructor(){this.backendUrl=null,this.isElectron=!1,this.isElectron=this.checkIfElectron(),this.initializeBackendUrl()}checkIfElectron(){return!(!window||!window.electronAPI)}async initializeBackendUrl(){if(this.isElectron&&window.electronAPI)try{this.backendUrl=await window.electronAPI.getBackendUrl()}catch(e){console.error("Failed to get backend URL from Electron:",e),this.backendUrl="http://localhost:8247"}else this.backendUrl="http://localhost:8247"}async getBackendUrl(){return this.backendUrl||await this.initializeBackendUrl(),this.backendUrl||"http://localhost:8249/"}async getApiUrl(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";const t=await this.getBackendUrl(),r=e.startsWith("/")?e:"/".concat(e);return"".concat(t,"/api").concat(r)}isElectronApp(){return this.isElectron}async waitForBackend(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3e4;const t=Date.now(),r=await this.getBackendUrl();for(;Date.now()-t<e;){try{if((await fetch("".concat(r,"/api/health"),{method:"GET",headers:{"Content-Type":"application/json"}})).ok)return!0}catch(s){}await new Promise((e=>setTimeout(e,500)))}return!1}async getAppVersion(){if(this.isElectron&&window.electronAPI)try{return await window.electronAPI.getAppVersion()}catch(e){return console.error("Failed to get app version:",e),"Unknown"}return"Web Version"}getPlatform(){return this.isElectron&&window.electronAPI?window.electronAPI.platform:"web"}};let u=null;const h=async e=>{const t=await(async()=>{if(!u){let e;e=d.isElectronApp()?await d.getBackendUrl():"http://localhost:8249/",u=new l(e)}return u})();return await t.send(e)}},73847:(e,t,r)=>{r.d(t,{A:()=>c});var s=r(65043),n=r(78500),a=r(66381);function o(){return o=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(e[s]=r[s])}return e},o.apply(this,arguments)}const i=(e,t)=>s.createElement(a.A,o({},e,{ref:t,icon:n.A}));const c=s.forwardRef(i)},83116:(e,t,r)=>{r.r(t),r.d(t,{default:()=>z});var s=r(65043),n=r(89379),a=r(62305),o=r(16569),i=r(62751),c=r(33359),l=r(9316),d=r(73847),u=r(4413),h=r(22671),p=r(71782),g=r(36621),m=r(26553),y=r(8354),f=r(6051),A=r(76399),x=r(89073),b=r(47419),k=r(11645),_=r(32513);const w=[{resource:"dashboard",label:"Dashboard",category:"Core",description:"Main dashboard view",menus:["dashboard"]},{resource:"sales_record",label:"Sales Records",category:"Sales",description:"Controls: SalesRecords menu, Create Sales, Sales List",menus:["SalesRecords","create-sales-record","sales-records-list"]},{resource:"customer",label:"Customers",category:"Sales",description:"Customer management",menus:["add-customer"]},{resource:"vendor",label:"Vendors",category:"Sales",description:"Vendor management",menus:["vendor"]},{resource:"product",label:"Products",category:"Inventory",description:"Product management",menus:["add-product"]},{resource:"unit",label:"Units",category:"Inventory",description:"Unit management",menus:["unit"]},{resource:"category",label:"Categories",category:"Inventory",description:"Category management",menus:["category"]},{resource:"variant",label:"Variants",category:"Inventory",description:"Variant management",menus:["variant"]},{resource:"warehouse",label:"Warehouses",category:"Inventory",description:"Warehouse management",menus:["warehouse"]},{resource:"rack",label:"Racks",category:"Inventory",description:"Rack management",menus:["rack"]},{resource:"stock_audit",label:"Stock In / Org Stock",category:"Stock",description:"Controls: Stock In, Organisation Stock Available",menus:["stock-in","organisation-stock-available"]},{resource:"stock_out",label:"Stock Out",category:"Stock",description:"Stock out management",menus:["stock-out"]},{resource:"branch_stock",label:"Branch Stock",category:"Stock",description:"Controls: Branch Stock, Branch Stock Available",menus:["branch-stock","branch-stock-available"]},{resource:"storage_stock",label:"Storage Stock",category:"Stock",description:"Storage stock list",menus:["storage-stock-list"]},{resource:"payment_history",label:"Payment History",category:"Financial",description:"Payment history management",menus:["payment-history"]},{resource:"expense",label:"Expenses",category:"Financial",description:"Expense management",menus:["expenses"]},{resource:"reports",label:"Reports",category:"Reports",description:"All reports",menus:["reports","report"]},{resource:"custom_entities",label:"Custom Forms",category:"Advanced",description:"Custom entity management",menus:["custom_forms"]},{resource:"settings",label:"Settings",category:"Settings",description:"Application settings",menus:["settings"]},{resource:"organisation",label:"Organisation",category:"Master Settings",description:"Organisation management",menus:["organisation"]},{resource:"branch",label:"Branches",category:"Master Settings",description:"Branch management",menus:["braches"]},{resource:"billing_user",label:"Users",category:"Master Settings",description:"User management",menus:["users"]},{resource:"role",label:"Roles",category:"Master Settings",description:"Role management",menus:["roles"]},{resource:"permission",label:"Permissions",category:"Master Settings",description:"Permission management",menus:["permissions"]}];let j=null;new Map;var v=r(98350),S=r(70579);const{Title:C,Text:E}=p.A,{TextArea:R}=g.A,P=e=>{let{form:t,initialPermissions:r={},onPermissionsChange:o}=e;const[i,c]=(0,s.useState)(r),l=j||(j=w.reduce(((e,t)=>(e[t.category]||(e[t.category]=[]),e[t.category].push(t),e)),{}),j),{data:d,isLoading:u}=v.lh.useGetRoleTypeQuery({}),h=(0,s.useMemo)((()=>{var e;return(null===d||void 0===d||null===(e=d.result)||void 0===e?void 0:e.map((e=>({label:e.name,value:e.name}))))||[]}),[d]);(0,s.useEffect)((()=>{Object.keys(r).length>0&&c(r)}),[r]),(0,s.useEffect)((()=>{o&&o(i)}),[i,o]);const p=(e,t,r)=>{c((s=>(0,n.A)((0,n.A)({},s),{},{[e]:(0,n.A)((0,n.A)({},s[e]||{can_create:!1,can_read:!1,can_update:!1,can_delete:!1}),{},{[t]:r})})))},P=(e,t)=>{const r=(0,n.A)({},i);w.forEach((s=>{r[s.resource]||(r[s.resource]={can_create:!1,can_read:!1,can_update:!1,can_delete:!1}),r[s.resource][e]=t})),c(r)},I=()=>Object.entries(i).filter((e=>{let[t,r]=e;return r.can_create||r.can_read||r.can_update||r.can_delete})).map((e=>{let[t,r]=e;return{resource:t,can_create:r.can_create||!1,can_read:r.can_read||!1,can_update:r.can_update||!1,can_delete:r.can_delete||!1}}));return(0,s.useEffect)((()=>{t&&(t.getPermissionsArray=I)}),[i,t]),(0,S.jsxs)("div",{style:{width:"100%"},children:[(0,S.jsx)(a.A.Item,{label:"Role Name",name:"name",rules:[{required:!0,message:"Please enter role name!"}],children:(0,S.jsx)(g.A,{placeholder:"Enter role name"})}),(0,S.jsx)(a.A.Item,{label:"Role Type",name:"roles_type",rules:[{required:!0,message:"Please select role type!"}],children:(0,S.jsx)(m.A,{placeholder:"Select role type",allowClear:!0,showSearch:!0,optionFilterProp:"children",loading:u,children:h.map((e=>(0,S.jsx)(m.A.Option,{value:e.value,children:e.label},e.value)))})}),(0,S.jsx)(a.A.Item,{label:"Description",name:"description",children:(0,S.jsx)(R,{rows:3,placeholder:"Enter role description (optional)"})}),(0,S.jsx)(y.A,{orientation:"left",children:(0,S.jsxs)(f.A,{children:[(0,S.jsx)(C,{level:5,style:{margin:0},children:"Permissions (CRUD)"}),(0,S.jsx)(A.A,{color:"blue",children:"Select permissions for each resource"})]})}),(0,S.jsx)(x.A,{size:"small",style:{marginBottom:16,background:"#f0f2f5"},children:(0,S.jsxs)(b.A,{gutter:16,align:"middle",children:[(0,S.jsx)(k.A,{span:8,children:(0,S.jsx)(E,{strong:!0,children:"Select All:"})}),(0,S.jsx)(k.A,{span:4,style:{textAlign:"center"},children:(0,S.jsx)(_.A,{onChange:e=>P("can_create",e.target.checked),children:(0,S.jsx)(E,{strong:!0,children:"Create"})})}),(0,S.jsx)(k.A,{span:4,style:{textAlign:"center"},children:(0,S.jsx)(_.A,{onChange:e=>P("can_read",e.target.checked),children:(0,S.jsx)(E,{strong:!0,children:"Read"})})}),(0,S.jsx)(k.A,{span:4,style:{textAlign:"center"},children:(0,S.jsx)(_.A,{onChange:e=>P("can_update",e.target.checked),children:(0,S.jsx)(E,{strong:!0,children:"Update"})})}),(0,S.jsx)(k.A,{span:4,style:{textAlign:"center"},children:(0,S.jsx)(_.A,{onChange:e=>P("can_delete",e.target.checked),children:(0,S.jsx)(E,{strong:!0,children:"Delete"})})})]})}),(0,S.jsx)("div",{style:{maxHeight:"500px",overflowY:"auto",paddingRight:8},children:Object.entries(l).map((e=>{let[t,r]=e;return(0,S.jsx)(x.A,{title:(0,S.jsx)(E,{strong:!0,children:t}),size:"small",style:{marginBottom:16},children:r.map((e=>{const t=i[e.resource]||{can_create:!1,can_read:!1,can_update:!1,can_delete:!1},r=t.can_create&&t.can_read&&t.can_update&&t.can_delete;return(0,S.jsxs)(b.A,{gutter:16,align:"middle",style:{marginBottom:12,padding:8,borderBottom:"1px solid #f0f0f0"},children:[(0,S.jsx)(k.A,{span:8,children:(0,S.jsxs)(f.A,{direction:"vertical",size:0,children:[(0,S.jsxs)(f.A,{children:[(0,S.jsx)(E,{strong:!0,children:e.label}),(0,S.jsx)(_.A,{checked:r,onChange:t=>{return r=e.resource,s=t.target.checked,void c((e=>(0,n.A)((0,n.A)({},e),{},{[r]:{can_create:s,can_read:s,can_update:s,can_delete:s}})));var r,s},style:{fontSize:11},children:(0,S.jsx)(E,{type:"secondary",style:{fontSize:11},children:"All"})})]}),(0,S.jsx)(E,{type:"secondary",style:{fontSize:11},children:e.description})]})}),(0,S.jsx)(k.A,{span:4,style:{textAlign:"center"},children:(0,S.jsx)(_.A,{checked:t.can_create,onChange:t=>p(e.resource,"can_create",t.target.checked)})}),(0,S.jsx)(k.A,{span:4,style:{textAlign:"center"},children:(0,S.jsx)(_.A,{checked:t.can_read,onChange:t=>p(e.resource,"can_read",t.target.checked)})}),(0,S.jsx)(k.A,{span:4,style:{textAlign:"center"},children:(0,S.jsx)(_.A,{checked:t.can_update,onChange:t=>p(e.resource,"can_update",t.target.checked)})}),(0,S.jsx)(k.A,{span:4,style:{textAlign:"center"},children:(0,S.jsx)(_.A,{checked:t.can_delete,onChange:t=>p(e.resource,"can_delete",t.target.checked)})})]},e.resource)}))},t)}))}),(0,S.jsx)(a.A.Item,{name:"permissions",hidden:!0,children:(0,S.jsx)(g.A,{type:"hidden"})})]})},I=[{title:"Role Name",dataIndex:"name",key:"name",render:e=>(0,S.jsx)("strong",{children:e})},{title:"Role Type",dataIndex:"roles_type",key:"roles_type",render:e=>(0,S.jsx)("span",{style:{padding:"4px 8px",borderRadius:"4px",fontSize:"12px",fontWeight:"500",backgroundColor:"Admin"===e?"#f6ffed":"#fff7e6",color:"Admin"===e?"#52c41a":"#fa8c16",border:"1px solid ".concat("Admin"===e?"#b7eb8f":"#ffd591")},children:e})},{title:"Description",dataIndex:"description",key:"description",ellipsis:!0}];var U=r(6004);const T=()=>{const[e]=a.A.useForm(),[t,r]=(0,s.useState)([]),[p,g]=(0,s.useState)(!1),[m,y]=(0,s.useState)(!1),[f,A]=(0,s.useState)(null),[x,b]=(0,s.useState)({}),[k,_]=(0,s.useState)(!1),[w,j]=(0,s.useState)({current:1,pageSize:10,total:0});(0,s.useEffect)((()=>{v()}),[w.current,w.pageSize]);const v=async()=>{g(!0);try{const e=await(0,U.A)({method:"GET",endpoint:"/roles",data:{pageNumber:w.current,pageLimit:w.pageSize}});if(200===e.statusCode){r(e.result||[]);const t=e.pagination;j((r=>{var s;return(0,n.A)((0,n.A)({},r),{},{total:(null===t||void 0===t?void 0:t.totalCount)||(null===t||void 0===t?void 0:t.total)||(null===(s=e.result)||void 0===s?void 0:s.length)||0})}))}else o.Ay.error("Failed to fetch roles: ".concat(e.message||"Unknown error"))}catch(e){console.error("Error fetching roles:",e),o.Ay.error("Error fetching roles")}finally{g(!1)}},C=()=>{y(!1),e.resetFields(),b({}),A(null)},E=[...I,{title:"Actions",key:"actions",render:(t,r)=>(0,S.jsxs)("div",{style:{display:"flex",gap:"16px",justifyContent:"center"},children:[(0,S.jsx)(c.A,{style:{cursor:"pointer",color:"#1890ff",fontSize:"16px"},onClick:()=>(async t=>{A(t),e.setFieldsValue({name:t.name,description:t.description,roles_type:t.roles_type});try{const e=await(0,U.A)({method:"GET",endpoint:"/permissions/role/".concat(t._id)});if(200===e.statusCode){var r;const t=(null===(r=e.result)||void 0===r?void 0:r.resources)||[],s={};t.forEach((e=>{s[e.resource]={can_create:e.can_create,can_read:e.can_read,can_update:e.can_update,can_delete:e.can_delete}})),b(s)}}catch(s){console.error("Error fetching role permissions:",s),o.Ay.warning("Could not load permissions for this role")}y(!0)})(r)}),(0,S.jsx)(l.A,{style:{cursor:"pointer",color:"#ff4d4f",fontSize:"16px"},onClick:()=>(async e=>{i.A.confirm({title:"Delete Role",content:'Are you sure you want to delete role "'.concat(e.name,'"?'),okText:"Yes",okType:"danger",cancelText:"No",onOk:async()=>{try{const t=await(0,U.A)({method:"DELETE",endpoint:"/roles/".concat(e._id)});200===t.statusCode?(o.Ay.success("Role deleted successfully"),v()):o.Ay.error("Failed to delete role: ".concat(t.message||"Unknown error"))}catch(t){console.error("Error deleting role:",t),o.Ay.error("Error deleting role")}}})})(r)})]})}];return(0,S.jsxs)("div",{children:[(0,S.jsxs)("div",{style:{marginBottom:16,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,S.jsx)("h1",{style:{margin:0},children:"Roles"}),(0,S.jsxs)("button",{onClick:()=>{A(null),b({}),e.resetFields(),y(!0)},style:{padding:"8px 16px",background:"#1890ff",color:"white",border:"none",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",gap:"8px"},children:[(0,S.jsx)(d.A,{})," Add Role"]})]}),(0,S.jsx)(u.A,{columns:E,data:t,loading:p,totalCount:w.total,pageLimit:w.pageSize,onPaginationChange:(e,t)=>{j((r=>(0,n.A)((0,n.A)({},r),{},{current:e,pageSize:t})))},rowKeyField:"_id"}),(0,S.jsx)(h.A,{title:f?"Edit Role":"Create Role",open:m,onClose:C,width:900,children:(0,S.jsxs)(a.A,{form:e,layout:"vertical",onFinish:async()=>{try{const t=await e.validateFields(),r=Object.entries(x).filter((e=>{let[t,r]=e;return r.can_create||r.can_read||r.can_update||r.can_delete})).map((e=>{let[t,r]=e;return{resource:t,can_create:r.can_create||!1,can_read:r.can_read||!1,can_update:r.can_update||!1,can_delete:r.can_delete||!1}}));if(0===r.length)return void o.Ay.warning("Please select at least one permission");const s={name:t.name,description:t.description,roles_type:t.roles_type,permissions:r};if(_(!0),f){const t=await(0,U.A)({method:"PATCH",endpoint:"/roles/".concat(f._id),data:s});200===t.statusCode?(o.Ay.success("Role updated successfully"),y(!1),e.resetFields(),b({}),v()):o.Ay.error("Failed to update role: ".concat(t.message||"Unknown error"))}else{const t=await(0,U.A)({method:"PUT",endpoint:"/roles",data:s});201===t.statusCode||200===t.statusCode?(o.Ay.success("Role created successfully"),y(!1),e.resetFields(),b({}),v()):o.Ay.error("Failed to create role: ".concat(t.message||"Unknown error"))}}catch(t){console.error("Error submitting role:",t),t.errorFields?o.Ay.error("Please fill in all required fields"):o.Ay.error("Error submitting role")}finally{_(!1)}},children:[(0,S.jsx)(P,{form:e,initialPermissions:x,onPermissionsChange:b}),(0,S.jsxs)("div",{style:{marginTop:24,display:"flex",justifyContent:"flex-end",gap:12},children:[(0,S.jsx)("button",{type:"button",onClick:C,style:{padding:"8px 24px",background:"#fff",color:"#000",border:"1px solid #d9d9d9",borderRadius:"4px",cursor:"pointer"},children:"Cancel"}),(0,S.jsx)("button",{type:"submit",disabled:k,style:{padding:"8px 24px",background:k?"#d9d9d9":"#1890ff",color:"white",border:"none",borderRadius:"4px",cursor:k?"not-allowed":"pointer"},children:k?"Submitting...":"Submit"})]})]})})]})},B=(0,s.memo)(T),F=()=>(0,S.jsx)(B,{}),z=(0,s.memo)(F)}}]);
//# sourceMappingURL=116.98ff364c.chunk.js.map