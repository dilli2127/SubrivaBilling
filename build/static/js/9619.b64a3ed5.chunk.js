/*! For license information please see 9619.b64a3ed5.chunk.js.LICENSE.txt */
"use strict";(self.webpackChunkSUBRIVA_BILLING=self.webpackChunkSUBRIVA_BILLING||[]).push([[9619],{6004:(e,r,s)=>{s.d(r,{A:()=>p});var n=s(56403),t=s(16569);const a=500,i=503;var o=s(89472),c=s(26167);const l=class{constructor(e){this.api=void 0,this.isRefreshing=!1,this.refreshSubscribers=[],this.hasShownSessionExpiredMessage=!1,this.api=n.A.create({baseURL:e,timeout:6e4,headers:{"Content-Type":"application/json"}}),this.api.interceptors.request.use((e=>{const r=(0,o.getAuthToken)();if(r&&(e.headers.Token=r,e.headers.Authorization="Bearer ".concat(r)),e.method&&["post","put","patch","delete"].includes(e.method.toLowerCase())){const r=(0,c.m5)();e.headers["X-CSRF-Token"]=r}return e})),this.api.interceptors.response.use((e=>e),(async e=>{const r=e.config;if(e.response&&401===e.response.status&&!r._retry){var s,n;const i=(null===(s=e.response.data)||void 0===s?void 0:s.exception)||(null===(n=e.response.data)||void 0===n?void 0:n.message)||"";if(i.toLowerCase().includes("access denied")||i.toLowerCase().includes("insufficient permissions")||i.toLowerCase().includes("permission"))return t.Ay.error({content:"You do not have permission to perform this action.",duration:5}),Promise.reject(e);if(this.isRefreshing)return new Promise((e=>{this.refreshSubscribers.push((s=>{r.headers&&(r.headers.Token=s,r.headers.Authorization="Bearer ".concat(s)),e(this.api.request(r))}))}));r._retry=!0,this.isRefreshing=!0;try{const e=await this.refreshAccessToken();if(e)return r.headers&&(r.headers.Token=e,r.headers.Authorization="Bearer ".concat(e)),this.refreshSubscribers.forEach((r=>r(e))),this.refreshSubscribers=[],this.api.request(r)}catch(a){return console.error("Token refresh failed:",a),this.hasShownSessionExpiredMessage||(this.hasShownSessionExpiredMessage=!0,t.Ay.error("Your session has expired. Please login again.")),(0,o.clearAuthData)(),window.location.href="#/billing_login",Promise.reject(a)}finally{this.isRefreshing=!1}}return Promise.reject(e)}))}async refreshAccessToken(){const e=(0,o.getRefreshToken)();if(!e)return console.warn("No refresh token available"),null;try{var r;const s=await n.A.post("".concat(this.api.defaults.baseURL,"/auth/refresh-token"),{refreshToken:e},{headers:{"Content-Type":"application/json"}});if(200===(null===(r=s.data)||void 0===r?void 0:r.statusCode)){const{accessToken:e,refreshToken:r}=s.data.result;return(0,o.setAccessToken)(e),r&&(0,o.setRefreshToken)(r),e}return null}catch(s){throw console.error("Failed to refresh access token:",s),s}}async send(e){try{const{data:r}=await this.api.request({method:e.method,url:e.endpoint,data:e.data,signal:e.signal});return this.handleResponse(r)}catch(r){return n.A.isAxiosError(r)&&"CanceledError"===r.name?{statusCode:0,message:"Request cancelled",result:null,pagination:{}}:this.handleError(r)}}handleResponse(e){if(401===e.statusCode){const r=e.exception||e.message||"";return r.toLowerCase().includes("access denied")||r.toLowerCase().includes("insufficient permissions")||r.toLowerCase().includes("permission")?(t.Ay.error({content:"You do not have permission to perform this action.",duration:5}),e):(this.hasShownSessionExpiredMessage||(this.hasShownSessionExpiredMessage=!0,t.Ay.error("Your session has expired. Please login again.")),(0,o.clearAuthData)(),window.location.href="#/billing_login",e)}return{statusCode:e.statusCode,message:e.message,result:e.result,pagination:e.pagination}}handleError(e){let r="API call failed",s=a;var t;if(n.A.isAxiosError(e))if(e.response)s=e.response.status,r=(null===(t=e.response.data)||void 0===t?void 0:t.message)||"An error occurred";else if(e.request){var o;r="No response received from server",s=null!==(o=i)&&void 0!==o?o:503}else r=e.message;return{statusCode:s,message:r,result:null,pagination:{}}}};const d=new class{constructor(){this.backendUrl=null,this.isElectron=!1,this.isElectron=this.checkIfElectron(),this.initializeBackendUrl()}checkIfElectron(){return!(!window||!window.electronAPI)}async initializeBackendUrl(){if(this.isElectron&&window.electronAPI)try{this.backendUrl=await window.electronAPI.getBackendUrl()}catch(e){console.error("Failed to get backend URL from Electron:",e),this.backendUrl="http://localhost:8247"}else this.backendUrl="http://localhost:8247"}async getBackendUrl(){return this.backendUrl||await this.initializeBackendUrl(),this.backendUrl||"https://www.subrivabilling.com/api/"}async getApiUrl(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";const r=await this.getBackendUrl(),s=e.startsWith("/")?e:"/".concat(e);return"".concat(r,"/api").concat(s)}isElectronApp(){return this.isElectron}async waitForBackend(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3e4;const r=Date.now(),s=await this.getBackendUrl();for(;Date.now()-r<e;){try{if((await fetch("".concat(s,"/api/health"),{method:"GET",headers:{"Content-Type":"application/json"}})).ok)return!0}catch(n){}await new Promise((e=>setTimeout(e,500)))}return!1}async getAppVersion(){if(this.isElectron&&window.electronAPI)try{return await window.electronAPI.getAppVersion()}catch(e){return console.error("Failed to get app version:",e),"Unknown"}return"Web Version"}getPlatform(){return this.isElectron&&window.electronAPI?window.electronAPI.platform:"web"}};var h=s(79711);let u=null;const p=async e=>{const r=await(async()=>{if(!u){let e;e=d.isElectronApp()?await d.getBackendUrl():(0,h.getActiveApiUrl)(),u=new l(e)}return u})();return await r.send(e)}},19619:(e,r,s)=>{s.r(r),s.d(r,{default:()=>b});var n=s(89379),t=s(65043),a=s(71782),i=s(26553),o=s(16569),c=s(6051),l=s(76399),d=s(32513),h=s(89073),u=s(96651),p=s(95206),g=s(91686),f=s(91065),A=s(46237),m=s(89967),y=s(90617),x=s(88143),w=s(6004),_=s(70579);const{Title:j,Text:v}=a.A,{Option:k}=i.A,b=()=>{const[e,r]=(0,t.useState)([]),[s,a]=(0,t.useState)(""),[b,C]=(0,t.useState)({}),[E,S]=(0,t.useState)(!1),[T,U]=(0,t.useState)(!1);(0,t.useEffect)((()=>{P()}),[]),(0,t.useEffect)((()=>{s&&z(s)}),[s]);const P=async()=>{S(!0);try{const e=await(0,w.A)({method:"GET",endpoint:"/roles"});if(200===e.statusCode){const s=e.result||[];r(s)}else o.Ay.error("Failed to fetch roles: ".concat(e.message||"Unknown error"))}catch(e){console.error("Error fetching roles:",e),o.Ay.error("Error fetching roles")}finally{S(!1)}},z=async e=>{S(!0);try{const s=await(0,w.A)({method:"GET",endpoint:"/permissions/role/".concat(e)});if(200===s.statusCode){var r;const e=(null===(r=s.result)||void 0===r?void 0:r.resources)||[];if(0===e.length)return o.Ay.warning("No permissions found for this role. Please seed permissions first."),void C({});const n={};e.forEach((e=>{n[e.resource]={resource:e.resource,can_create:e.can_create,can_read:e.can_read,can_update:e.can_update,can_delete:e.can_delete,allowed_menu_keys:e.allowed_menu_keys||[]}})),C(n)}else o.Ay.error("Failed to fetch permissions: ".concat(s.message||"Unknown error"))}catch(s){console.error("Error fetching permissions:",s),o.Ay.error("Error fetching permissions")}finally{S(!1)}},R=(e,r,s)=>{C((t=>(0,n.A)((0,n.A)({},t),{},{[e]:(0,n.A)((0,n.A)({},t[e]),{},{[r]:s})})))},I=(e,r)=>{const s=(0,n.A)({},b);Object.keys(s).forEach((t=>{s[t]=(0,n.A)((0,n.A)({},s[t]),{},{[e]:r})})),C(s)},B=[{title:"Resource",dataIndex:"resource",key:"resource",width:250,fixed:"left",render:e=>(0,_.jsxs)(c.A,{children:[(0,_.jsx)(v,{strong:!0,children:L(e)}),(0,_.jsx)(l.A,{color:"blue",children:e})]})},{title:(0,_.jsxs)(c.A,{direction:"vertical",size:0,align:"center",children:[(0,_.jsx)(v,{children:"Create"}),(0,_.jsx)(d.A,{onChange:e=>I("can_create",e.target.checked),disabled:!s,children:(0,_.jsx)(v,{type:"secondary",style:{fontSize:11},children:"All"})})]}),dataIndex:"can_create",key:"can_create",align:"center",width:100,render:(e,r)=>(0,_.jsx)(d.A,{checked:e,onChange:e=>R(r.resource,"can_create",e.target.checked),disabled:!s})},{title:(0,_.jsxs)(c.A,{direction:"vertical",size:0,align:"center",children:[(0,_.jsx)(v,{children:"Read"}),(0,_.jsx)(d.A,{onChange:e=>I("can_read",e.target.checked),disabled:!s,children:(0,_.jsx)(v,{type:"secondary",style:{fontSize:11},children:"All"})})]}),dataIndex:"can_read",key:"can_read",align:"center",width:100,render:(e,r)=>(0,_.jsx)(d.A,{checked:e,onChange:e=>R(r.resource,"can_read",e.target.checked),disabled:!s})},{title:(0,_.jsxs)(c.A,{direction:"vertical",size:0,align:"center",children:[(0,_.jsx)(v,{children:"Update"}),(0,_.jsx)(d.A,{onChange:e=>I("can_update",e.target.checked),disabled:!s,children:(0,_.jsx)(v,{type:"secondary",style:{fontSize:11},children:"All"})})]}),dataIndex:"can_update",key:"can_update",align:"center",width:100,render:(e,r)=>(0,_.jsx)(d.A,{checked:e,onChange:e=>R(r.resource,"can_update",e.target.checked),disabled:!s})},{title:(0,_.jsxs)(c.A,{direction:"vertical",size:0,align:"center",children:[(0,_.jsx)(v,{children:"Delete"}),(0,_.jsx)(d.A,{onChange:e=>I("can_delete",e.target.checked),disabled:!s,children:(0,_.jsx)(v,{type:"secondary",style:{fontSize:11},children:"All"})})]}),dataIndex:"can_delete",key:"can_delete",align:"center",width:100,render:(e,r)=>(0,_.jsx)(d.A,{checked:e,onChange:e=>R(r.resource,"can_delete",e.target.checked),disabled:!s})},{title:"Summary",key:"summary",align:"center",width:120,render:(e,r)=>{const s=b[r.resource],n=[null===s||void 0===s?void 0:s.can_create,null===s||void 0===s?void 0:s.can_read,null===s||void 0===s?void 0:s.can_update,null===s||void 0===s?void 0:s.can_delete].filter(Boolean).length;return(0,_.jsx)(c.A,{children:4===n?(0,_.jsx)(l.A,{color:"success",icon:(0,_.jsx)(A.A,{}),children:"Full Access"}):0===n?(0,_.jsx)(l.A,{color:"error",icon:(0,_.jsx)(m.A,{}),children:"No Access"}):(0,_.jsxs)(l.A,{color:"processing",children:[n,"/4"]})})}}],L=e=>e.split("_").map((e=>e.charAt(0).toUpperCase()+e.slice(1))).join(" "),V=Object.entries(b).map((e=>{let[r,s]=e;return{key:r,resource:r,can_create:s.can_create,can_read:s.can_read,can_update:s.can_update,can_delete:s.can_delete}})),F=e.find((e=>e._id===s));return(0,_.jsx)("div",{className:"permission-management",children:(0,_.jsx)(h.A,{title:(0,_.jsx)(c.A,{children:(0,_.jsx)(j,{level:4,style:{margin:0},children:"Permission Management"})}),extra:(0,_.jsxs)(c.A,{children:[(0,_.jsx)(u.A,{title:"Refresh",children:(0,_.jsx)(p.Ay,{icon:(0,_.jsx)(y.A,{}),onClick:()=>{P(),s&&z(s)},children:"Refresh"})}),(0,_.jsx)(p.Ay,{type:"primary",icon:(0,_.jsx)(x.A,{}),onClick:async()=>{if(s){U(!0);try{const e=Object.entries(b).map((e=>{let[r,s]=e;return{resource:r,can_create:s.can_create||!1,can_read:s.can_read||!1,can_update:s.can_update||!1,can_delete:s.can_delete||!1}})),r=await(0,w.A)({method:"POST",endpoint:"/permissions/bulk",data:{role_id:s,permissions:e}});200===r.statusCode?(o.Ay.success("Permissions updated successfully"),z(s)):o.Ay.error(r.message||"Failed to update permissions")}catch(n){var e,r;console.error("Error saving permissions:",n),o.Ay.error((null===n||void 0===n||null===(e=n.response)||void 0===e||null===(r=e.data)||void 0===r?void 0:r.exception)||"Error saving permissions")}finally{U(!1)}}else o.Ay.warning("Please select a role first")},loading:T,disabled:!s,children:"Save Changes"})]}),children:(0,_.jsxs)(c.A,{direction:"vertical",size:"large",style:{width:"100%"},children:[(0,_.jsxs)("div",{children:[(0,_.jsx)(v,{strong:!0,style:{marginRight:8},children:"Select Role:"}),(0,_.jsx)(i.A,{style:{width:300},placeholder:"Choose a role to manage permissions",value:s||void 0,onChange:a,loading:E,children:e.map((e=>(0,_.jsx)(k,{value:e._id,children:(0,_.jsxs)(c.A,{children:[(0,_.jsx)(v,{children:e.name}),(0,_.jsx)(l.A,{color:"blue",children:e.roles_type})]})},e._id)))}),F&&(0,_.jsx)(v,{type:"secondary",style:{marginLeft:12},children:F.description})]}),(0,_.jsx)(g.A,{spinning:E,children:(0,_.jsx)(f.A,{columns:B,dataSource:V,pagination:!1,scroll:{x:800,y:500},bordered:!0,size:"small",locale:{emptyText:s?"No permissions found for this role":"Please select a role to view permissions"}})}),s&&V.length>0&&(0,_.jsx)(h.A,{size:"small",style:{background:"#f5f5f5"},children:(0,_.jsxs)(c.A,{size:"large",children:[(0,_.jsxs)(v,{children:[(0,_.jsx)(v,{strong:!0,children:"Total Resources:"})," ",V.length]}),(0,_.jsxs)(v,{children:[(0,_.jsx)(v,{strong:!0,children:"Full Access:"})," ",V.filter((e=>e.can_create&&e.can_read&&e.can_update&&e.can_delete)).length]}),(0,_.jsxs)(v,{children:[(0,_.jsx)(v,{strong:!0,children:"No Access:"})," ",V.filter((e=>!e.can_create&&!e.can_read&&!e.can_update&&!e.can_delete)).length]}),(0,_.jsxs)(v,{children:[(0,_.jsx)(v,{strong:!0,children:"Partial Access:"})," ",V.filter((e=>[e.can_create,e.can_read,e.can_update,e.can_delete].filter(Boolean).length>0&&!(e.can_create&&e.can_read&&e.can_update&&e.can_delete))).length]})]})})]})})})}},88143:(e,r,s)=>{s.d(r,{A:()=>c});var n=s(65043);const t={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M893.3 293.3L730.7 130.7c-7.5-7.5-16.7-13-26.7-16V112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V338.5c0-17-6.7-33.2-18.7-45.2zM384 184h256v104H384V184zm456 656H184V184h136v136c0 17.7 14.3 32 32 32h320c17.7 0 32-14.3 32-32V205.8l136 136V840zM512 442c-79.5 0-144 64.5-144 144s64.5 144 144 144 144-64.5 144-144-64.5-144-144-144zm0 224c-44.2 0-80-35.8-80-80s35.8-80 80-80 80 35.8 80 80-35.8 80-80 80z"}}]},name:"save",theme:"outlined"};var a=s(66381);function i(){return i=Object.assign?Object.assign.bind():function(e){for(var r=1;r<arguments.length;r++){var s=arguments[r];for(var n in s)Object.prototype.hasOwnProperty.call(s,n)&&(e[n]=s[n])}return e},i.apply(this,arguments)}const o=(e,r)=>n.createElement(a.A,i({},e,{ref:r,icon:t}));const c=n.forwardRef(o)}}]);
//# sourceMappingURL=9619.b64a3ed5.chunk.js.map