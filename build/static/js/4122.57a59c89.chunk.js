/*! For license information please see 4122.57a59c89.chunk.js.LICENSE.txt */
"use strict";(self.webpackChunkSUBRIVA_BILLING=self.webpackChunkSUBRIVA_BILLING||[]).push([[4122],{4122:(e,t,n)=>{n.r(t),n.d(t,{default:()=>ye});var i=n(89379),o=n(65043),a=n(36621),r=n(26553),l=n(93504),s=n(12624),d=n(16569),c=n(62751),u=n(73146),m=n(76399),h=n(37490),x=n(96651),_=n(79126),v=n(6051),g=n(95206),p=n(30326),j=n(60446),y=n.n(j),A=n(33359),f=n(4394),b=n(46237),C=n(89967),I=n(95240);const S={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M296 256c-4.4 0-8 3.6-8 8v48c0 4.4 3.6 8 8 8h384c4.4 0 8-3.6 8-8v-48c0-4.4-3.6-8-8-8H296zm192 200v-48c0-4.4-3.6-8-8-8H296c-4.4 0-8 3.6-8 8v48c0 4.4 3.6 8 8 8h184c4.4 0 8-3.6 8-8zm-48 396H208V148h560v344c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V108c0-17.7-14.3-32-32-32H168c-17.7 0-32 14.3-32 32v784c0 17.7 14.3 32 32 32h272c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm104.1-115.6c1.8-34.5 16.2-66.8 40.8-91.4 26.2-26.2 62-41 99.1-41 37.4 0 72.6 14.6 99.1 41 3.2 3.2 6.3 6.6 9.2 10.1L769.2 673a8 8 0 003 14.1l93.3 22.5c5 1.2 9.8-2.6 9.9-7.7l.6-95.4a8 8 0 00-12.9-6.4l-20.3 15.8C805.4 569.6 748.1 540 684 540c-109.9 0-199.6 86.9-204 195.7-.2 4.5 3.5 8.3 8 8.3h48.1c4.3 0 7.8-3.3 8-7.6zM880 744h-48.1c-4.3 0-7.8 3.3-8 7.6-1.8 34.5-16.2 66.8-40.8 91.4-26.2 26.2-62 41-99.1 41-37.4 0-72.6-14.6-99.1-41-3.2-3.2-6.3-6.6-9.2-10.1l23.1-17.9a8 8 0 00-3-14.1l-93.3-22.5c-5-1.2-9.8 2.6-9.9 7.7l-.6 95.4a8 8 0 0012.9 6.4l20.3-15.8C562.6 918.4 619.9 948 684 948c109.9 0 199.6-86.9 204-195.7.2-4.5-3.5-8.3-8-8.3z"}}]},name:"file-sync",theme:"outlined"};var k=n(66381);function w(){return w=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},w.apply(this,arguments)}const D=(e,t)=>o.createElement(k.A,w({},e,{ref:t,icon:S}));const q=o.forwardRef(D);var N=n(36091),T=n(53722),F=n(6881),M=n(76401),Y=n(61118),L=n(75388),P=n(92003),O=n(9316),E=n(18758),Q=n(58209),z=n(70579);const V={draft:{color:"default",icon:(0,z.jsx)(A.A,{}),label:"Draft"},sent:{color:"processing",icon:(0,z.jsx)(f.A,{}),label:"Sent"},accepted:{color:"success",icon:(0,z.jsx)(b.A,{}),label:"Accepted"},rejected:{color:"error",icon:(0,z.jsx)(C.A,{}),label:"Rejected"},expired:{color:"warning",icon:(0,z.jsx)(I.A,{}),label:"Expired"},converted:{color:"green",icon:(0,z.jsx)(q,{}),label:"Converted"}};var R=n(98350),B=n(97679),U=n(7866),G=n(60647),H=n(91065),W=n(73847),Z=n(51333);const K=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const n=Number(e);return Number.isFinite(n)?n:t},X=e=>Number((Math.round(100*(e+Number.EPSILON))/100).toFixed(2)),J=function(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const n=K(e.quantity),i=K(e.unit_price),o=K(e.tax_percentage),a=K(e.discount),r=n*i;let l="percentage"===("amount"===e.discount_type?"amount":"percentage")?r*a/100:a;l=Math.min(Math.max(l,0),r);const s=Math.max(r-l,0);let d=0,c=s,u=s;return o>0?t?(d=s*(o/(100+o)),u=s-d,c=s):(d=s*(o/100),c=s+d,u=s):u=s,{line_total:X(c),item_subtotal:X(s),item_discount_amount:X(l),item_tax_amount:X(d),item_value_of_goods:X(u)}},$=e=>{let{value:t=[],onChange:n,disabled:l=!1,isGstIncluded:s=!0}=e;const[d,c]=(0,o.useState)(""),[u,m]=(0,o.useState)(""),[h,_]=(0,o.useState)(1),[p,j]=(0,o.useState)([]),[y,A]=(0,o.useState)(!0),f=(0,o.useRef)(null),b=(0,o.useRef)(!1);(0,o.useEffect)((()=>{if(d!==u)return f.current&&clearTimeout(f.current),f.current=setTimeout((()=>{m(d),_(1),j([]),A(!0),b.current=!1}),300),()=>{f.current&&clearTimeout(f.current)}}),[d,u]);const C=(0,o.useMemo)((()=>({pageNumber:h,pageLimit:20,searchString:u||""})),[h,u]),{data:I,isLoading:S,isFetching:k}=R.lh.useGetProductQuery(C,{refetchOnMountOrArgChange:!1,refetchOnFocus:!1,refetchOnReconnect:!1});(0,o.useEffect)((()=>{if(I){var e,t;const n=(null===I||void 0===I?void 0:I.result)||[],i=(null===(e=I.pagination)||void 0===e?void 0:e.totalCount)||(null===(t=I.pagination)||void 0===t?void 0:t.total)||0;j((e=>{if(1===h)return A(n.length<i&&n.length>0),n;{const t=new Set(e.map((e=>e._id))),o=n.filter((e=>!t.has(e._id)));if(0===o.length)return e;const a=[...e,...o];return A(a.length<i&&o.length>0),a}})),b.current=!1}}),[I,h]);const w=(0,o.useCallback)((e=>{const t=e.target,n=t.scrollTop,i=t.scrollHeight;(n+t.clientHeight)/i>.7&&y&&!S&&!b.current&&(b.current=!0,_((e=>e+1)))}),[y,S]),D=(0,o.useCallback)((e=>{}),[]),q=p,N=o.memo((e=>{let{record:t,index:n,disabled:i,onStockAuditSelect:a}=e;const[l,s]=(0,o.useState)(""),[d,c]=(0,o.useState)(""),[u,m]=(0,o.useState)(1),[h,x]=(0,o.useState)([]),[_,v]=(0,o.useState)(!0),g=(0,o.useRef)(null),p=(0,o.useRef)(!1),j=(0,o.useRef)(void 0),y=(0,o.useRef)(""),A=(0,o.useRef)(!1),f=t.product_id;(0,o.useEffect)((()=>{if(l!==d)return g.current&&clearTimeout(g.current),g.current=setTimeout((()=>{c(l),m(1),x([]),v(!0),p.current=!1,A.current=!1}),300),()=>{g.current&&clearTimeout(g.current)}}),[l,d]),(0,o.useEffect)((()=>{j.current!==f&&(j.current=f,m(1),x([]),v(!0),s(""),c(""),p.current=!1,A.current=!1)}),[f]);const b=(0,o.useMemo)((()=>({pageNumber:u,pageLimit:20,searchString:d||"",product_id:f||void 0})),[u,d,f]),C=(0,o.useMemo)((()=>JSON.stringify({page:u,searchString:d,product_id:f})),[u,d,f]),{data:I,isLoading:S,isFetching:k}=((0,o.useMemo)((()=>{const e=y.current!==C;return e&&(y.current=C),e}),[C]),R.lh.useGetStockAuditQuery(b,{skip:!f,refetchOnMountOrArgChange:!1,refetchOnFocus:!1,refetchOnReconnect:!1}));(0,o.useEffect)((()=>{if(I&&f){var e,t;const n=(null===I||void 0===I?void 0:I.result)||[],i=(null===(e=I.pagination)||void 0===e?void 0:e.totalCount)||(null===(t=I.pagination)||void 0===t?void 0:t.total)||0;x((e=>{var t,o;if(1===u)return e.length===n.length&&e.length>0&&(null===(t=e[0])||void 0===t?void 0:t._id)===(null===(o=n[0])||void 0===o?void 0:o._id)?e:(v(n.length<i&&n.length>0),A.current=!0,n);{const t=new Set(e.map((e=>e._id))),o=n.filter((e=>!t.has(e._id)));if(0===o.length)return e;const a=[...e,...o];return v(a.length<i&&o.length>0),a}})),p.current=!1}}),[I,u,f]);const w=(0,o.useCallback)((e=>{const t=e.target,n=t.scrollTop,i=t.scrollHeight;(n+t.clientHeight)/i>.7&&_&&!S&&!p.current&&f&&(p.current=!0,m((e=>e+1)))}),[_,S,f]),D=(0,o.useCallback)((e=>{}),[]);return(0,z.jsx)(r.A,{showSearch:!0,allowClear:!0,placeholder:f?"Select stock batch":"Select product first",style:{width:"100%"},value:t.stock_audit_id||void 0,onChange:e=>{if(void 0===e||null===e)return void a(n,void 0,void 0);const t=h.find((t=>t._id===e));a(n,e,t||void 0)},disabled:i||!f,loading:S&&0===h.length,onSearch:s,onPopupScroll:w,onDropdownVisibleChange:D,filterOption:!1,notFoundContent:f?S&&!A.current?"Loading stock batches...":0!==h.length||S?null:"No stock batches found for this product":"Please select a product first",dropdownRender:e=>(0,z.jsxs)(z.Fragment,{children:[e,_&&h.length>0&&(0,z.jsx)("div",{style:{textAlign:"center",padding:"8px",color:"#999"},children:S?"Loading...":"Scroll for more"})]}),children:h.map((e=>{var t,n,i;return(0,z.jsxs)(r.A.Option,{value:e._id,children:[(null===(t=e.ProductItem)||void 0===t?void 0:t.name)||"N/A",null!==(n=e.ProductItem)&&void 0!==n&&null!==(i=n.VariantItem)&&void 0!==i&&i.variant_name?" - ".concat(e.ProductItem.VariantItem.variant_name):"",e.batch_no?" (Batch: ".concat(e.batch_no,")"):""]},e._id)}))})}),((e,t)=>e.record.product_id===t.record.product_id&&e.index===t.index&&e.disabled===t.disabled&&e.onStockAuditSelect===t.onStockAuditSelect)),T=(0,o.useCallback)((()=>{null===n||void 0===n||n([...t,{product_id:"",product_name:"",variant_name:"",description:"",quantity:1,unit_price:0,tax_percentage:18,discount:0,discount_type:"percentage",line_total:0}])}),[t,n]),F=(0,o.useCallback)((e=>{const i=t.filter(((t,n)=>n!==e));null===n||void 0===n||n(i)}),[t,n]),M=(0,o.useCallback)((e=>J(e,s)),[s]),Y=(0,o.useCallback)(((e,o,a)=>{const r=[...t],l=(0,i.A)((0,i.A)({},r[e]),{},{[o]:a});if(["quantity","unit_price","tax_percentage","discount","discount_type"].includes(o)){const e=M(l);l.line_total=e.line_total}r[e]=l,null===n||void 0===n||n(r)}),[t,n,M]),L=(0,o.useCallback)(((e,o)=>{var a,r,l;const s=q.find((e=>e._id===o));if(!s)return;const d=[...t],c=(null===(a=s.CategoryItem)||void 0===a?void 0:a.tax_percentage)||(null===(r=s.category)||void 0===r?void 0:r.tax_percentage)||s.tax_percentage||18,u=(0,i.A)((0,i.A)({},d[e]),{},{product_id:o,product_name:s.name,variant_name:(null===(l=s.VariantItem)||void 0===l?void 0:l.variant_name)||"",description:s.description||"",tax_percentage:Number(c)||18,unit_price:s.sell_price||0}),m=M(u);d[e]=(0,i.A)((0,i.A)({},u),{},{line_total:m.line_total}),null===n||void 0===n||n(d)}),[t,n,q,M]),P=(0,o.useCallback)(((e,o,a)=>{const r=[...t],l=(0,i.A)({},r[e]);if(!o)return l.stock_audit_id=void 0,r[e]=l,void(null===n||void 0===n||n(r));if(!a)return l.stock_audit_id=o,r[e]=l,void(null===n||void 0===n||n(r));if(l.stock_audit_id=o,void 0!==a.sell_price&&null!==a.sell_price&&(l.unit_price=Number(a.sell_price)||0),a.ProductItem&&!l.product_id){var s,d,c;l.product_id=a.ProductItem._id||"",l.product_name=a.ProductItem.name||"",l.variant_name=(null===(s=a.ProductItem.VariantItem)||void 0===s?void 0:s.variant_name)||"";const e=(null===(d=a.ProductItem.CategoryItem)||void 0===d?void 0:d.tax_percentage)||(null===(c=a.category)||void 0===c?void 0:c.tax_percentage)||18;l.tax_percentage=Number(e)||18}const u=M(l);l.line_total=u.line_total,r[e]=l,null===n||void 0===n||n(r)}),[t,n,M]),E=(0,o.useRef)(s);(0,o.useEffect)((()=>{if(E.current===s)return;if(!t||0===t.length)return void(E.current=s);const e=t.map((e=>{const t=J(e,s);return(0,i.A)((0,i.A)({},e),{},{line_total:t.line_total})}));null===n||void 0===n||n(e),E.current=s}),[s,t,n]);const Q=(0,o.useMemo)((()=>{const e=t.reduce(((e,t)=>{const n=J(t,s);return e.subtotal+=n.line_total,e.discountAmount+=n.item_discount_amount,e.valueOfGoods+=n.item_value_of_goods,e.taxAmount+=n.item_tax_amount,e.total+=n.line_total,e}),{subtotal:0,discountAmount:0,valueOfGoods:0,taxAmount:0,total:0});return{subtotal:Number(e.subtotal.toFixed(2)),discountAmount:Number(e.discountAmount.toFixed(2)),valueOfGoods:Number(e.valueOfGoods.toFixed(2)),taxAmount:Number(e.taxAmount.toFixed(2)),total:Number(e.total.toFixed(2))}}),[t,s]),V=[{title:"#",key:"index",width:40,render:(e,t,n)=>n+1},{title:(0,z.jsx)("span",{style:{color:"red"},children:"* Product"}),key:"product",width:200,render:(e,t,n)=>(0,z.jsx)(r.A,{showSearch:!0,allowClear:!0,placeholder:"Select product",style:{width:"100%"},value:t.product_id||void 0,onChange:e=>L(n,e),disabled:l,loading:S&&0===p.length,onSearch:c,onPopupScroll:w,onDropdownVisibleChange:D,filterOption:!1,notFoundContent:S&&0===p.length?"Loading products...":0===p.length?"No products found":null,dropdownRender:e=>(0,z.jsxs)(z.Fragment,{children:[e,y&&p.length>0&&(0,z.jsx)("div",{style:{textAlign:"center",padding:"8px",color:"#999"},children:S?"Loading...":"Scroll for more"})]}),children:p.map((e=>{var t;return(0,z.jsxs)(r.A.Option,{value:e._id,children:[e.name," ",null!==(t=e.VariantItem)&&void 0!==t&&t.variant_name?"- ".concat(e.VariantItem.variant_name):""]},e._id)}))})},{title:"Stock Audit",key:"stock_audit",width:200,render:(e,t,n)=>(0,z.jsx)(N,{record:t,index:n,disabled:l,onStockAuditSelect:P})},{title:"Description",key:"description",width:150,render:(e,t,n)=>(0,z.jsx)(a.A,{placeholder:"Description",value:t.description,onChange:e=>Y(n,"description",e.target.value),disabled:l})},{title:(0,z.jsx)("span",{style:{color:"red"},children:"* Quantity"}),key:"quantity",width:100,render:(e,t,n)=>(0,z.jsx)(U.A,{min:1,precision:0,placeholder:"Qty",style:{width:"100%"},value:t.quantity,onChange:e=>Y(n,"quantity",e),disabled:l})},{title:(0,z.jsx)("span",{style:{color:"red"},children:"* Unit Price"}),key:"unit_price",width:110,render:(e,t,n)=>(0,z.jsx)(U.A,{min:0,precision:2,placeholder:"\u20b90.00",prefix:"\u20b9",style:{width:"100%"},value:t.unit_price,onChange:e=>Y(n,"unit_price",e),disabled:l})},{title:"Tax %",key:"tax_percentage",width:80,render:(e,t,n)=>(0,z.jsx)(U.A,{min:0,max:100,precision:2,placeholder:"18%",suffix:"%",style:{width:"100%"},value:t.tax_percentage,onChange:e=>Y(n,"tax_percentage",e),disabled:l})},{title:"Discount",key:"discount",width:130,render:(e,t,n)=>(0,z.jsxs)(v.A.Compact,{style:{width:"100%"},children:[(0,z.jsx)(U.A,{min:0,precision:2,placeholder:"0",style:{width:"70%"},value:t.discount,onChange:e=>Y(n,"discount",e),disabled:l}),(0,z.jsxs)(r.A,{style:{width:"30%"},value:t.discount_type,onChange:e=>Y(n,"discount_type",e),disabled:l,children:[(0,z.jsx)(r.A.Option,{value:"percentage",children:"%"}),(0,z.jsx)(r.A.Option,{value:"amount",children:"\u20b9"})]})]})},{title:"Line Total",key:"line_total",width:110,render:(e,t)=>(0,z.jsx)(x.A,{title:"Qty: ".concat(t.quantity," \xd7 \u20b9").concat(t.unit_price),children:(0,z.jsxs)("strong",{style:{color:"#52c41a"},children:["\u20b9",(t.line_total||0).toLocaleString("en-IN",{minimumFractionDigits:2})]})})},{title:"Actions",key:"actions",width:70,render:(e,n,i)=>(0,z.jsx)(G.A,{title:"Delete this line item?",onConfirm:()=>F(i),disabled:l||1===t.length,children:(0,z.jsx)(g.Ay,{type:"link",danger:!0,size:"small",icon:(0,z.jsx)(O.A,{}),disabled:l||1===t.length})})}];return(0,z.jsxs)("div",{style:{width:"100%"},children:[(0,z.jsxs)("div",{style:{marginBottom:12,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,z.jsx)("strong",{style:{fontSize:"14px"},children:"Line Items"}),(0,z.jsx)(g.Ay,{type:"dashed",icon:(0,z.jsx)(W.A,{}),onClick:T,disabled:l,children:"Add Item"})]}),(0,z.jsx)(H.A,{columns:V,dataSource:t,pagination:!1,size:"small",scroll:{x:"max-content"},rowKey:(e,t)=>"item-".concat(t),bordered:!0,footer:()=>(0,z.jsx)("div",{style:{textAlign:"right"},children:(0,z.jsxs)(v.A,{direction:"vertical",size:"small",style:{width:"100%"},children:[Q.discountAmount>0&&(0,z.jsxs)("div",{style:{display:"flex",justifyContent:"flex-end",gap:"20px"},children:[(0,z.jsx)("span",{children:"Discount:"}),(0,z.jsxs)("strong",{style:{color:"#ff4d4f"},children:["-\u20b9",Q.discountAmount.toLocaleString("en-IN",{minimumFractionDigits:2})]})]}),Math.abs(Q.subtotal-Q.total)>.01&&(0,z.jsxs)("div",{style:{display:"flex",justifyContent:"flex-end",gap:"20px"},children:[(0,z.jsx)("span",{children:"Subtotal:"}),(0,z.jsxs)("strong",{children:["\u20b9",Q.subtotal.toLocaleString("en-IN",{minimumFractionDigits:2})]})]}),(0,z.jsxs)("div",{style:{display:"flex",justifyContent:"flex-end",gap:"20px"},children:[(0,z.jsx)("span",{children:"Value of Goods:"}),(0,z.jsxs)("strong",{children:["\u20b9",Q.valueOfGoods.toLocaleString("en-IN",{minimumFractionDigits:2})]})]}),Q.taxAmount>0&&(0,z.jsxs)("div",{style:{display:"flex",justifyContent:"flex-end",gap:"20px"},children:[(0,z.jsx)("span",{children:"Tax Amount:"}),(0,z.jsxs)("strong",{children:["\u20b9",Q.taxAmount.toLocaleString("en-IN",{minimumFractionDigits:2})]})]}),(0,z.jsxs)("div",{style:{display:"flex",justifyContent:"flex-end",gap:"20px",fontSize:"16px",color:"#52c41a"},children:[(0,z.jsxs)("span",{children:[(0,z.jsx)(Z.A,{})," Total:"]}),(0,z.jsxs)("strong",{children:["\u20b9",Q.total.toLocaleString("en-IN",{minimumFractionDigits:2})]})]})]})})}),0===t.length&&(0,z.jsx)("div",{style:{textAlign:"center",padding:"40px",color:"#999"},children:'No items added. Click "Add Item" to get started.'})]})};var ee=n(71782),te=n(20691),ne=n(8354);const{Text:ie}=ee.A,oe=e=>{var t;let{open:n,onClose:i,quotation:a}=e;const r=a,l=a&&!r.customer&&!a.CustomerItem&&a.customer_id&&n,{data:s}=R.lh.useGetCustomerByIdQuery((null===a||void 0===a?void 0:a.customer_id)||"",{skip:!l}),d=(0,o.useMemo)((()=>{if(!a)return null;if(r.customer&&(r.customer.customer_name||r.customer.full_name||r.customer.name))return{customer_name:r.customer.customer_name||r.customer.full_name||r.customer.name,company_name:r.customer.company_name,email:r.customer.email,phone:r.customer.phone||r.customer.mobile,address:r.customer.address,gst_number:r.customer.gst_number};if(a.CustomerItem){const e=a.CustomerItem;if(e.customer_name||e.full_name||e.name)return{customer_name:e.customer_name||e.full_name||e.name,company_name:e.company_name,email:e.email,phone:e.phone||e.mobile,address:e.address,gst_number:e.gst_number}}if(l&&s){const e=(null===s||void 0===s?void 0:s.result)||s;if(e&&(e.customer_name||e.full_name||e.name))return{customer_name:e.customer_name||e.full_name||e.name,company_name:e.company_name,email:e.email,phone:e.phone||e.mobile||e.contact_number,address:e.address,gst_number:e.gst_number}}return a.customer_name||r.full_name||r.name?{customer_name:a.customer_name||r.full_name||r.name,company_name:r.customer_company_name||r.company_name,email:a.customer_email||r.email,phone:a.customer_phone||r.mobile||r.phone,address:r.customer_address||r.address}:null}),[a,s,l]),u={draft:{color:"default",icon:(0,z.jsx)(N.A,{}),label:"Draft"},sent:{color:"processing",icon:(0,z.jsx)(f.A,{}),label:"Sent"},accepted:{color:"success",icon:(0,z.jsx)(b.A,{}),label:"Accepted"},rejected:{color:"error",icon:(0,z.jsx)(C.A,{}),label:"Rejected"},expired:{color:"warning",icon:(0,z.jsx)(I.A,{}),label:"Expired"},converted:{color:"green",icon:(0,z.jsx)(q,{}),label:"Converted"}},h=(null===a||void 0===a?void 0:a.status)||"draft",x=u[h]||u.draft,_=[{title:"#",key:"index",width:50,render:(e,t,n)=>n+1},{title:"Product",dataIndex:"product_name",key:"product_name",render:(e,t)=>(0,z.jsxs)("div",{children:[(0,z.jsx)("strong",{children:e||"-"}),t.variant_name&&(0,z.jsx)("div",{style:{fontSize:"12px",color:"#888"},children:t.variant_name})]})},{title:"Description",dataIndex:"description",key:"description",render:e=>e||"-"},{title:"Quantity",dataIndex:"quantity",key:"quantity",align:"right",render:e=>e||0},{title:"Unit Price",dataIndex:"unit_price",key:"unit_price",align:"right",render:e=>"\u20b9".concat((e||0).toLocaleString("en-IN",{minimumFractionDigits:2}))},{title:"Tax %",dataIndex:"tax_percentage",key:"tax_percentage",align:"right",render:e=>"".concat(e||0,"%")},{title:"Discount",dataIndex:"discount",key:"discount",align:"right",render:(e,t)=>{if(!e)return"-";const n="amount"===t.discount_type?"\u20b9":"%";return"".concat(n).concat(e)}},{title:"Line Total",dataIndex:"line_total",key:"line_total",align:"right",render:e=>(0,z.jsxs)("strong",{style:{color:"#52c41a"},children:["\u20b9",(e||0).toLocaleString("en-IN",{minimumFractionDigits:2})]})}];if(!a)return null;const g=a.valid_until&&y()(a.valid_until).isBefore(y()())&&!["converted","rejected"].includes(h);return(0,z.jsx)(c.A,{title:(0,z.jsxs)(v.A,{children:[(0,z.jsx)(N.A,{}),(0,z.jsx)("span",{children:"Quotation Details"}),(0,z.jsx)(m.A,{color:x.color,icon:x.icon,children:x.label})]}),open:n,onCancel:i,footer:null,width:1e3,style:{top:20},children:(0,z.jsxs)("div",{style:{maxHeight:"80vh",overflowY:"auto"},children:[(0,z.jsxs)(te.A,{bordered:!0,column:2,size:"small",children:[(0,z.jsx)(te.A.Item,{label:"Quotation Number",span:1,children:(0,z.jsx)(m.A,{color:"blue",icon:(0,z.jsx)(N.A,{}),children:a.quotation_number})}),(0,z.jsx)(te.A.Item,{label:"Quotation Date",span:1,children:(0,z.jsxs)(v.A,{children:[(0,z.jsx)(F.A,{}),a.quotation_date?y()(a.quotation_date).format("DD/MM/YYYY"):"-"]})}),(0,z.jsx)(te.A.Item,{label:"Valid Until",span:1,children:(0,z.jsxs)(v.A,{children:[(0,z.jsx)(F.A,{}),a.valid_until?(0,z.jsxs)("span",{style:{color:g?"#ff4d4f":"inherit"},children:[y()(a.valid_until).format("DD/MM/YYYY"),g&&(0,z.jsx)(m.A,{color:"red",style:{marginLeft:8},children:"EXPIRED"})]}):"-"]})}),(0,z.jsx)(te.A.Item,{label:"Status",span:1,children:(0,z.jsx)(m.A,{color:x.color,icon:x.icon,children:x.label})})]}),(0,z.jsx)(ne.A,{}),(0,z.jsxs)(te.A,{title:"Customer Information",bordered:!0,column:2,size:"small",children:[(0,z.jsx)(te.A.Item,{label:"Customer Name",span:1,children:(0,z.jsxs)(v.A,{children:[(0,z.jsx)(T.A,{}),(0,z.jsx)("strong",{children:(null===d||void 0===d?void 0:d.customer_name)||a.customer_name||"-"})]})}),(0,z.jsx)(te.A.Item,{label:"Email",span:1,children:(null===d||void 0===d?void 0:d.email)||a.customer_email||"-"}),(0,z.jsx)(te.A.Item,{label:"Phone",span:1,children:(null===d||void 0===d?void 0:d.phone)||a.customer_phone||"-"}),(null===d||void 0===d?void 0:d.gst_number)&&(0,z.jsx)(te.A.Item,{label:"GST Number",span:1,children:d.gst_number}),(null===d||void 0===d?void 0:d.address)&&(0,z.jsx)(te.A.Item,{label:"Address",span:2,children:d.address})]}),(0,z.jsx)(ne.A,{}),(0,z.jsx)(te.A,{bordered:!0,column:1,size:"small",children:(0,z.jsxs)(te.A.Item,{label:"GST Status",children:[(0,z.jsx)(m.A,{color:a.is_gst_included?"green":"orange",children:a.is_gst_included?"GST INCLUDED":"GST EXCLUDED"}),(0,z.jsx)("span",{style:{marginLeft:8,fontSize:"12px",color:"#888"},children:a.is_gst_included?"Tax is included in the prices shown":"Tax will be added on top of the prices shown"})]})}),(0,z.jsx)(ne.A,{}),(0,z.jsxs)("div",{children:[(0,z.jsxs)(ie,{strong:!0,style:{fontSize:"16px"},children:["Line Items (",(null===(t=a.items)||void 0===t?void 0:t.length)||0,")"]}),(0,z.jsx)(H.A,{columns:_,dataSource:a.items||[],pagination:!1,size:"small",bordered:!0,style:{marginTop:12},rowKey:(e,t)=>"item-".concat(t),summary:()=>{const e=a.subtotal||0,t=a.tax_amount||0,n=a.discount_amount||0,i=a.total_amount||0;return(0,z.jsxs)(H.A.Summary,{fixed:!0,children:[(0,z.jsxs)(H.A.Summary.Row,{children:[(0,z.jsx)(H.A.Summary.Cell,{index:0,colSpan:6,align:"right",children:(0,z.jsx)("strong",{children:"Subtotal:"})}),(0,z.jsx)(H.A.Summary.Cell,{index:1,align:"right",children:(0,z.jsxs)("strong",{children:["\u20b9",e.toLocaleString("en-IN",{minimumFractionDigits:2})]})})]}),n>0&&(0,z.jsxs)(H.A.Summary.Row,{children:[(0,z.jsx)(H.A.Summary.Cell,{index:0,colSpan:6,align:"right",children:(0,z.jsx)("strong",{children:"Discount:"})}),(0,z.jsx)(H.A.Summary.Cell,{index:1,align:"right",children:(0,z.jsxs)("strong",{style:{color:"#ff4d4f"},children:["-\u20b9",n.toLocaleString("en-IN",{minimumFractionDigits:2})]})})]}),(0,z.jsxs)(H.A.Summary.Row,{children:[(0,z.jsx)(H.A.Summary.Cell,{index:0,colSpan:6,align:"right",children:(0,z.jsx)("strong",{children:"Tax Amount:"})}),(0,z.jsx)(H.A.Summary.Cell,{index:1,align:"right",children:(0,z.jsxs)("strong",{children:["\u20b9",t.toLocaleString("en-IN",{minimumFractionDigits:2})]})})]}),(0,z.jsxs)(H.A.Summary.Row,{children:[(0,z.jsx)(H.A.Summary.Cell,{index:0,colSpan:6,align:"right",children:(0,z.jsxs)("strong",{style:{fontSize:"16px",color:"#52c41a"},children:[(0,z.jsx)(M.A,{})," Total Amount:"]})}),(0,z.jsx)(H.A.Summary.Cell,{index:1,align:"right",children:(0,z.jsxs)("strong",{style:{fontSize:"16px",color:"#52c41a"},children:["\u20b9",i.toLocaleString("en-IN",{minimumFractionDigits:2})]})})]})]})}})]}),(a.converted_to_invoice_no||a.converted_to_sales_record_id)&&(0,z.jsxs)(z.Fragment,{children:[(0,z.jsx)(ne.A,{}),(0,z.jsx)(te.A,{bordered:!0,column:1,size:"small",children:(0,z.jsxs)(te.A.Item,{label:"Converted To Invoice",children:[(0,z.jsx)(m.A,{color:"green",icon:(0,z.jsx)(q,{}),children:a.converted_to_invoice_no||a.converted_to_sales_record_id}),a.converted_date&&(0,z.jsxs)("span",{style:{marginLeft:8,color:"#888"},children:["on ",y()(a.converted_date).format("DD/MM/YYYY")]})]})})]}),(a.notes||a.terms_conditions)&&(0,z.jsxs)(z.Fragment,{children:[(0,z.jsx)(ne.A,{}),a.notes&&(0,z.jsxs)("div",{style:{marginBottom:16},children:[(0,z.jsx)(ie,{strong:!0,children:"Notes:"}),(0,z.jsx)("div",{style:{marginTop:8,padding:12,background:"#f5f5f5",borderRadius:4},children:a.notes})]}),a.terms_conditions&&(0,z.jsxs)("div",{children:[(0,z.jsx)(ie,{strong:!0,children:"Terms & Conditions:"}),(0,z.jsx)("div",{style:{marginTop:8,padding:12,background:"#f5f5f5",borderRadius:4},children:a.terms_conditions})]})]})]})})};var ae=n(62305),re=n(42261),le=n(47419),se=n(11645),de=n(32513),ce=n(1259),ue=n(89472);const{TextArea:me}=a.A,{Option:he}=r.A,xe=e=>{var t,n,a,s,u,h,x;let{open:_,onClose:g,quotation:p,onSuccess:j}=e;const[A]=ae.A.useForm(),[f,{isLoading:b}]=(0,B.Wz)(),C=((0,ue.getCurrentUser)(),(null===p||void 0===p?void 0:p.items)||[]),S=C.length>0,k=ae.A.useWatch("is_paid",A),w=ae.A.useWatch("is_partially_paid",A),D=(0,o.useMemo)((()=>C&&0!==C.length?C.filter((e=>e.stock_audit&&e.stock_audit._id)).map((e=>(0,i.A)((0,i.A)({},e.stock_audit),{},{product_name:e.product_name,variant_name:e.variant_name,product_id:e.product_id,required_quantity:Number(e.quantity)||0}))):[]),[C]),N=(0,o.useMemo)((()=>D.some((e=>(Number(e.available_quantity)||0)<(Number(e.required_quantity)||0)))),[D]),T=(0,o.useMemo)((()=>[{title:"#",key:"index",width:50,render:(e,t,n)=>n+1},{title:"Product",dataIndex:"product_name",key:"product_name",render:(e,t)=>(0,z.jsxs)("div",{children:[(0,z.jsx)("strong",{children:e||"-"}),t.variant_name&&(0,z.jsx)("div",{style:{fontSize:12,color:"#888"},children:t.variant_name})]})},{title:"Qty",dataIndex:"quantity",key:"quantity",align:"right"},{title:"Unit Price",dataIndex:"unit_price",key:"unit_price",align:"right",render:e=>"\u20b9".concat((e||0).toLocaleString("en-IN",{minimumFractionDigits:2}))},{title:"Tax %",dataIndex:"tax_percentage",key:"tax_percentage",align:"right",render:e=>"".concat(e||0,"%")},{title:"Line Total",dataIndex:"line_total",key:"line_total",align:"right",render:e=>(0,z.jsxs)("strong",{style:{color:"#52c41a"},children:["\u20b9",(e||0).toLocaleString("en-IN",{minimumFractionDigits:2})]})}]),[]);(0,o.useEffect)((()=>{p&&_&&A.setFieldsValue({invoice_date:y()(),payment_mode:"cash",is_paid:!1,is_partially_paid:!1,paid_amount:0,notes:"Converted from Quotation ".concat(p.quotation_number)})}),[p,_,A]);const F=(e,t)=>{e?A.setFieldsValue({is_partially_paid:!1,paid_amount:(null===p||void 0===p?void 0:p.total_amount)||0}):t?A.setFieldsValue({is_paid:!1}):A.setFieldsValue({paid_amount:0})};return p?(0,z.jsxs)(c.A,{title:(0,z.jsxs)(v.A,{children:[(0,z.jsx)(q,{}),(0,z.jsx)("span",{children:"Convert Quotation to Invoice"})]}),open:_,onCancel:g,onOk:async()=>{try{const e=await A.validateFields();if(null===p||void 0===p||!p._id)return void d.Ay.error("Quotation not found");const t=(()=>{const e=[];return C.forEach((t=>{if(t.stock_audit&&t.stock_audit._id){const n=Number(t.stock_audit.available_quantity)||0,i=Number(t.quantity)||0;n<i&&e.push("".concat(t.product_name).concat(t.variant_name?" (".concat(t.variant_name,")"):""," - Available: ").concat(n,", Required: ").concat(i))}})),e})();if(t.length>0)return void d.Ay.error({content:(0,z.jsxs)("div",{children:[(0,z.jsx)("div",{style:{marginBottom:8,fontWeight:"bold"},children:"Insufficient stock available:"}),(0,z.jsx)("ul",{style:{margin:0,paddingLeft:20},children:t.map(((e,t)=>(0,z.jsx)("li",{style:{marginBottom:4},children:e},t)))})]}),duration:8});if(e.is_partially_paid&&(!e.paid_amount||e.paid_amount<=0))return void d.Ay.error("Please enter paid amount for partial payment");e.is_paid&&e.paid_amount!==p.total_amount&&(A.setFieldsValue({paid_amount:p.total_amount}),e.paid_amount=p.total_amount);const n={id:p._id,invoice_date:e.invoice_date?y()(e.invoice_date).format("YYYY-MM-DD"):y()().format("YYYY-MM-DD"),payment_mode:e.payment_mode||"cash",is_paid:e.is_paid||!1,is_partially_paid:e.is_partially_paid||!1,paid_amount:e.is_paid?p.total_amount:e.paid_amount||0,notes:e.notes||""},i=await f(n).unwrap();if(!(200===(null===i||void 0===i?void 0:i.statusCode)||null!==i&&void 0!==i&&i.data))throw new Error((null===i||void 0===i?void 0:i.message)||"Failed to convert quotation");d.Ay.success("Quotation converted to invoice successfully!"),A.resetFields(),null===j||void 0===j||j(),g()}catch(t){var e;console.error("Convert quotation error:",t),d.Ay.error((null===t||void 0===t||null===(e=t.data)||void 0===e?void 0:e.message)||(null===t||void 0===t?void 0:t.message)||"Failed to convert quotation")}},confirmLoading:b,width:1e3,okText:"Convert to Invoice",cancelText:"Cancel",children:[(0,z.jsx)(re.A,{message:"Converting Quotation to Invoice",description:"This will create a new sales record/invoice from quotation ".concat(p.quotation_number,". Stock will be deducted automatically."),type:"info",showIcon:!0,style:{marginBottom:16}}),(0,z.jsxs)(te.A,{bordered:!0,column:2,size:"small",style:{marginBottom:16},children:[(0,z.jsx)(te.A.Item,{label:"Quotation Number",children:(0,z.jsx)(m.A,{color:"blue",children:p.quotation_number})}),(0,z.jsx)(te.A.Item,{label:"Customer",children:(null===(t=p.customer)||void 0===t?void 0:t.full_name)||(null===(n=p.customer)||void 0===n?void 0:n.name)||(null===(a=p.customer)||void 0===a?void 0:a.customer_name)||(null===(s=p.CustomerItem)||void 0===s?void 0:s.customer_name)||(null===(u=p.CustomerItem)||void 0===u?void 0:u.full_name)||(null===(h=p.CustomerItem)||void 0===h?void 0:h.name)||p.customer_name||p.full_name||p.name||"-"}),(0,z.jsxs)(te.A.Item,{label:"Total Items",children:[(null===(x=p.items)||void 0===x?void 0:x.length)||0," items"]}),(0,z.jsx)(te.A.Item,{label:"Total Amount",children:(0,z.jsxs)("strong",{style:{color:"#52c41a",fontSize:"16px"},children:[(0,z.jsx)(M.A,{})," \u20b9",(p.total_amount||0).toLocaleString("en-IN",{minimumFractionDigits:2})]})})]}),S&&(0,z.jsxs)(z.Fragment,{children:[(0,z.jsx)(ne.A,{}),(0,z.jsx)(H.A,{columns:T,dataSource:C,size:"small",pagination:!1,bordered:!0,rowKey:(e,t)=>(null===e||void 0===e?void 0:e._id)||"convert-item-".concat(t),scroll:{y:260},title:()=>(0,z.jsxs)(v.A,{children:[(0,z.jsx)(q,{}),(0,z.jsx)("span",{children:"Items / Stock List"})]}),summary:()=>(0,z.jsxs)(H.A.Summary,{fixed:!0,children:[(0,z.jsxs)(H.A.Summary.Row,{children:[(0,z.jsx)(H.A.Summary.Cell,{index:0,colSpan:4,align:"right",children:"Subtotal"}),(0,z.jsx)(H.A.Summary.Cell,{index:1,colSpan:2,align:"right",children:(0,z.jsxs)("strong",{children:["\u20b9",(p.subtotal||0).toLocaleString("en-IN",{minimumFractionDigits:2})]})})]}),p.discount_amount>0&&(0,z.jsxs)(H.A.Summary.Row,{children:[(0,z.jsx)(H.A.Summary.Cell,{index:0,colSpan:4,align:"right",children:"Discount"}),(0,z.jsx)(H.A.Summary.Cell,{index:1,colSpan:2,align:"right",children:(0,z.jsxs)("strong",{style:{color:"#ff4d4f"},children:["-\u20b9",(p.discount_amount||0).toLocaleString("en-IN",{minimumFractionDigits:2})]})})]}),(0,z.jsxs)(H.A.Summary.Row,{children:[(0,z.jsx)(H.A.Summary.Cell,{index:0,colSpan:4,align:"right",children:"Tax Amount"}),(0,z.jsx)(H.A.Summary.Cell,{index:1,colSpan:2,align:"right",children:(0,z.jsxs)("strong",{children:["\u20b9",(p.tax_amount||0).toLocaleString("en-IN",{minimumFractionDigits:2})]})})]}),(0,z.jsxs)(H.A.Summary.Row,{children:[(0,z.jsx)(H.A.Summary.Cell,{index:0,colSpan:4,align:"right",children:(0,z.jsx)("strong",{style:{fontSize:16,color:"#52c41a"},children:"Grand Total"})}),(0,z.jsx)(H.A.Summary.Cell,{index:1,colSpan:2,align:"right",children:(0,z.jsxs)("strong",{style:{fontSize:16,color:"#52c41a"},children:["\u20b9",(p.total_amount||0).toLocaleString("en-IN",{minimumFractionDigits:2})]})})]})]})})]}),(0,z.jsx)(ne.A,{}),S&&D.length>0&&(0,z.jsxs)(z.Fragment,{children:[N&&(0,z.jsx)(re.A,{message:"Insufficient Stock Warning",description:"Some products have insufficient available stock. Please check the stock audit details below. Invoice conversion will be blocked if stock is insufficient.",type:"warning",showIcon:!0,style:{marginBottom:16}}),(0,z.jsxs)("div",{style:{marginBottom:16},children:[(0,z.jsxs)(v.A,{style:{marginBottom:8},children:[(0,z.jsx)(ce.A,{}),(0,z.jsx)("strong",{children:"Stock Audit Details"})]}),(0,z.jsx)(H.A,{columns:[{title:"Product",key:"product",render:(e,t)=>(0,z.jsxs)("div",{children:[(0,z.jsx)("strong",{children:t.product_name||"-"}),t.variant_name&&(0,z.jsx)("div",{style:{fontSize:12,color:"#888"},children:t.variant_name})]})},{title:"Batch No",dataIndex:"batch_no",key:"batch_no",render:e=>(0,z.jsx)(m.A,{color:"purple",children:e||"-"})},{title:"Required Qty",dataIndex:"required_quantity",key:"required_quantity",align:"right",render:e=>(0,z.jsx)("strong",{children:e||0})},{title:"Available Qty",dataIndex:"available_quantity",key:"available_quantity",align:"right",render:(e,t)=>{const n=Number(e)||0,i=n<(Number(t.required_quantity)||0);return(0,z.jsxs)(m.A,{color:i?"red":n>0?"green":"red",children:[n,i&&(0,z.jsx)("span",{style:{marginLeft:4,fontSize:11},children:"\u26a0\ufe0f Insufficient"})]})}},{title:"Buy Price",dataIndex:"buy_price",key:"buy_price",align:"right",render:e=>{const t=Number(e)||0;return"\u20b9".concat(t.toFixed(2))}},{title:"Expiry Date",dataIndex:"expiry_date",key:"expiry_date",render:e=>{if(!e)return"-";const t=y()(e),n=y()(),i=t.isBefore(n),o=t.diff(n,"days")<=30&&t.diff(n,"days")>0;let a="green";return i?a="red":o&&(a="orange"),(0,z.jsx)(m.A,{color:a,children:t.format("DD/MM/YYYY")})}}],dataSource:D,size:"small",pagination:!1,bordered:!0,rowKey:e=>e._id||"stock-".concat(Math.random()),scroll:{y:200}})]}),(0,z.jsx)(ne.A,{})]}),(0,z.jsxs)(ae.A,{form:A,layout:"vertical",initialValues:{invoice_date:y()(),payment_mode:"cash",is_paid:!1,is_partially_paid:!1,paid_amount:0},children:[(0,z.jsxs)(le.A,{gutter:16,children:[(0,z.jsx)(se.A,{span:12,children:(0,z.jsx)(ae.A.Item,{name:"invoice_date",label:"Invoice Date",rules:[{required:!0,message:"Invoice date is required"}],children:(0,z.jsx)(l.A,{style:{width:"100%"},format:"YYYY-MM-DD"})})}),(0,z.jsx)(se.A,{span:12,children:(0,z.jsx)(ae.A.Item,{name:"payment_mode",label:"Payment Mode",rules:[{required:!0,message:"Payment mode is required"}],children:(0,z.jsxs)(r.A,{onChange:e=>{A.setFieldsValue({payment_mode:e})},children:[(0,z.jsx)(he,{value:"cash",children:"Cash"}),(0,z.jsx)(he,{value:"card",children:"Card"}),(0,z.jsx)(he,{value:"upi",children:"UPI"}),(0,z.jsx)(he,{value:"bank_transfer",children:"Bank Transfer"}),(0,z.jsx)(he,{value:"cheque",children:"Cheque"}),(0,z.jsx)(he,{value:"credit",children:"Credit"}),(0,z.jsx)(he,{value:"other",children:"Other"})]})})})]}),(0,z.jsx)(ae.A.Item,{label:"Payment Status",children:(0,z.jsxs)(v.A,{size:"large",children:[(0,z.jsx)(ae.A.Item,{name:"is_paid",valuePropName:"checked",noStyle:!0,children:(0,z.jsx)(de.A,{onChange:e=>{F(e.target.checked,!1)},children:"Fully Paid"})}),(0,z.jsx)(ae.A.Item,{name:"is_partially_paid",valuePropName:"checked",noStyle:!0,children:(0,z.jsx)(de.A,{onChange:e=>{F(!1,e.target.checked)},children:"Partially Paid"})})]})}),(w||k)&&(0,z.jsx)(ae.A.Item,{name:"paid_amount",label:"Paid Amount",rules:[{required:!0,message:"Paid amount is required"},{validator:(e,t)=>t>((null===p||void 0===p?void 0:p.total_amount)||0)?Promise.reject("Paid amount cannot exceed total amount"):Promise.resolve()}],children:(0,z.jsx)(U.A,{min:0,max:(null===p||void 0===p?void 0:p.total_amount)||0,precision:2,style:{width:"100%"},prefix:"\u20b9",placeholder:"Enter paid amount"})}),(0,z.jsx)(ae.A.Item,{name:"notes",label:"Notes",children:(0,z.jsx)(me,{rows:3,placeholder:"Additional notes for the invoice"})})]}),(0,z.jsx)(re.A,{message:(0,z.jsxs)(z.Fragment,{children:[(0,z.jsx)(I.A,{})," Important"]}),description:"Once converted, the quotation status will be updated to 'converted' and cannot be edited. Stock will be deducted automatically.",type:"warning",showIcon:!0,style:{marginTop:16}})]}):null};var _e=n(94834);const{TextArea:ve}=a.A,ge=e=>{var t,n,i,r,l,s,u,h;let{open:x,onClose:_,quotation:p}=e;const[j]=ae.A.useForm(),[y,{isLoading:A}]=(0,B.xB)();(0,o.useEffect)((()=>{if(p&&x){var e,t,n,i,o,a,r,l,s;const d=(null===(e=p.customer)||void 0===e?void 0:e.email)||(null===(t=p.CustomerItem)||void 0===t?void 0:t.email)||p.customer_email||"";j.setFieldsValue({email:d,message:"Dear ".concat((null===(n=p.customer)||void 0===n?void 0:n.full_name)||(null===(i=p.customer)||void 0===i?void 0:i.name)||(null===(o=p.customer)||void 0===o?void 0:o.customer_name)||(null===(a=p.CustomerItem)||void 0===a?void 0:a.customer_name)||(null===(r=p.CustomerItem)||void 0===r?void 0:r.full_name)||(null===(l=p.CustomerItem)||void 0===l?void 0:l.name)||p.customer_name||p.full_name||p.name||"Customer",",\n\nPlease find attached our quotation ").concat(p.quotation_number," for your review.\n\nQuotation Details:\n- Quotation Number: ").concat(p.quotation_number,"\n- Valid Until: ").concat(p.valid_until?new Date(p.valid_until).toLocaleDateString():"N/A","\n- Total Amount: \u20b9").concat((p.total_amount||0).toLocaleString("en-IN",{minimumFractionDigits:2}),"\n\nWe look forward to your response.\n\nBest regards,\n").concat((null===(s=p.CreatedByUser)||void 0===s?void 0:s.username)||"Sales Team")})}}),[p,x,j]);const b=async()=>{try{const e=await j.validateFields();if(null===p||void 0===p||!p._id)return void d.Ay.error("Quotation not found");if(!e.email)return void d.Ay.error("Customer email is required");const t={id:p._id,email:e.email,message:e.message||""},n=await y(t).unwrap();if(!(200===(null===n||void 0===n?void 0:n.statusCode)||null!==n&&void 0!==n&&n.data))throw new Error((null===n||void 0===n?void 0:n.message)||"Failed to send quotation");d.Ay.success("Quotation sent to customer successfully!"),j.resetFields(),_()}catch(t){var e;console.error("Send quotation error:",t),d.Ay.error((null===t||void 0===t||null===(e=t.data)||void 0===e?void 0:e.message)||(null===t||void 0===t?void 0:t.message)||"Failed to send quotation")}};if(!p)return null;(null===(t=p.customer)||void 0===t?void 0:t.email)||(null===(n=p.CustomerItem)||void 0===n?void 0:n.email)||p.customer_email||p.email;const C=(null===(i=p.customer)||void 0===i?void 0:i.full_name)||(null===(r=p.customer)||void 0===r?void 0:r.name)||(null===(l=p.customer)||void 0===l?void 0:l.customer_name)||(null===(s=p.CustomerItem)||void 0===s?void 0:s.customer_name)||(null===(u=p.CustomerItem)||void 0===u?void 0:u.full_name)||(null===(h=p.CustomerItem)||void 0===h?void 0:h.name)||p.customer_name||p.full_name||p.name||"Customer";return(0,z.jsxs)(c.A,{title:(0,z.jsxs)(v.A,{children:[(0,z.jsx)(L.A,{}),(0,z.jsx)("span",{children:"Send Quotation to Customer"})]}),open:x,onCancel:_,onOk:b,confirmLoading:A,width:700,okText:"Send Email",cancelText:"Cancel",footer:[(0,z.jsx)(g.Ay,{icon:(0,z.jsx)(_e.A,{}),onClick:()=>{d.Ay.info("Print functionality coming soon")},children:"Print"},"print"),(0,z.jsx)(g.Ay,{icon:(0,z.jsx)(P.A,{}),onClick:()=>{d.Ay.info("PDF download functionality coming soon")},children:"Download PDF"},"pdf"),(0,z.jsx)(g.Ay,{onClick:_,children:"Cancel"},"cancel"),(0,z.jsx)(g.Ay,{type:"primary",icon:(0,z.jsx)(f.A,{}),loading:A,onClick:b,children:"Send Email"},"send")],children:[(0,z.jsx)(re.A,{message:"Sending Quotation",description:"This will send quotation ".concat(p.quotation_number," to the customer via email. The quotation status will be updated to 'sent'."),type:"info",showIcon:!0,style:{marginBottom:16}}),(0,z.jsxs)(te.A,{bordered:!0,column:2,size:"small",style:{marginBottom:16},children:[(0,z.jsx)(te.A.Item,{label:"Quotation Number",children:(0,z.jsx)(m.A,{color:"blue",children:p.quotation_number})}),(0,z.jsx)(te.A.Item,{label:"Customer",children:C}),(0,z.jsx)(te.A.Item,{label:"Total Amount",children:(0,z.jsxs)("strong",{style:{color:"#52c41a"},children:["\u20b9",(p.total_amount||0).toLocaleString("en-IN",{minimumFractionDigits:2})]})}),(0,z.jsx)(te.A.Item,{label:"Valid Until",children:p.valid_until?new Date(p.valid_until).toLocaleDateString():"-"})]}),(0,z.jsxs)(ae.A,{form:j,layout:"vertical",children:[(0,z.jsx)(ae.A.Item,{name:"email",label:"Customer Email",rules:[{required:!0,message:"Customer email is required"},{type:"email",message:"Please enter a valid email address"}],children:(0,z.jsx)(a.A,{prefix:(0,z.jsx)(L.A,{}),placeholder:"customer@example.com"})}),(0,z.jsx)(ae.A.Item,{name:"message",label:"Email Message",rules:[{required:!0,message:"Email message is required"}],children:(0,z.jsx)(ve,{rows:8,placeholder:"Enter email message to customer..."})})]}),(0,z.jsx)(re.A,{message:"Note",description:"The quotation PDF will be attached automatically to the email. Make sure the customer email is correct before sending.",type:"warning",showIcon:!0,style:{marginTop:16}})]})},{TextArea:pe}=a.A,{Option:je}=r.A,ye=()=>{const e=(0,ue.getCurrentUser)(),[t,n]=(0,o.useState)(!1),[j,f]=(0,o.useState)(!1),[S,k]=(0,o.useState)(!1),[w,D]=(0,o.useState)(null),[U,G]=(0,o.useState)(!0),H=(0,o.useMemo)((()=>({pageNumber:1,pageLimit:100})),[]),{data:W,isLoading:Z}=R.lh.useGetCustomerQuery(H),ee=(0,o.useMemo)((()=>(null===W||void 0===W?void 0:W.result)||[]),[W]),[te]=(0,B.xB)(),[ne]=(0,B.Hn)(),[ie]=(0,B.g5)(),[ae]=(0,B.Wz)(),re=(0,o.useCallback)((function(){return function(){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const t=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).reduce(((t,n)=>{const i=J(n,e);return t.subtotal+=i.line_total,t.tax_amount+=i.item_tax_amount,t.discount_amount+=i.item_discount_amount,t.value_of_goods+=i.item_value_of_goods,t.total_amount+=i.line_total,t}),{subtotal:0,tax_amount:0,discount_amount:0,value_of_goods:0,total_amount:0});return{subtotal:X(t.subtotal),tax_amount:X(t.tax_amount),discount_amount:X(t.discount_amount),value_of_goods:X(t.value_of_goods),total_amount:X(t.total_amount)}}(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],arguments.length>1&&void 0!==arguments[1]?arguments[1]:U)}),[U]),le=(0,o.useMemo)((()=>[{name:"quotation_number",label:"Quotation Number",rules:[{required:!1,message:"Quotation number is required"}],component:(0,z.jsx)(a.A,{placeholder:"Auto-generated or enter manually"})},{name:"quotation_date",label:"Quotation Date",initialValue:y()(),rules:[{required:!0,message:"Quotation date is required"}],component:(0,z.jsx)(l.A,{style:{width:"100%"},format:"YYYY-MM-DD"})},{name:"customer_id",label:"Customer",rules:[{required:!0,message:"Customer is required"}],component:(0,z.jsx)(r.A,{showSearch:!0,placeholder:"Select customer",loading:Z,filterOption:(e,t)=>String((null===t||void 0===t?void 0:t.children)||"").toLowerCase().includes(e.toLowerCase()),children:ee.map((e=>(0,z.jsxs)(je,{value:e._id,children:[e.full_name||e.name||e.customer_name||"Unknown Customer",e.mobile||e.phone?" - ".concat(e.mobile||e.phone):""]},e._id)))})},{name:"valid_until",label:"Valid Until",initialValue:y()().add(30,"days"),rules:[{required:!0,message:"Valid until date is required"}],component:(0,z.jsx)(l.A,{style:{width:"100%"},format:"YYYY-MM-DD"})},{name:"notes",label:"Notes",component:(0,z.jsx)(pe,{rows:3,placeholder:"Additional notes or instructions"})},{name:"terms_conditions",label:"Terms & Conditions",component:(0,z.jsx)(pe,{rows:3,placeholder:"Terms and conditions for this quotation"})},{name:"items",label:"Line Items",rules:[{required:!0,message:"At least one item is required"},{validator:async(e,t)=>{if(!t||0===t.length)throw new Error("At least one item is required");if(t.some((e=>!e.product_id||!e.quantity||!e.unit_price)))throw new Error("All items must have product, quantity, and price")}}],component:(0,z.jsx)($,{isGstIncluded:U}),colSpan:3},{name:"is_gst_included",label:"GST",initialValue:!0,valuePropName:"checked",component:(0,z.jsx)(s.A,{checkedChildren:"INCLUDED",unCheckedChildren:"EXCLUDED",defaultChecked:!0})}]),[ee,Z,U]),se=(0,o.useMemo)((()=>({onView:e=>{D(e),n(!0)},onEdit:()=>{},onDelete:async e=>d.Ay.info("Delete handled by GenericCrudPage"),onSend:e=>{D(e),k(!0)},onConvert:e=>{D(e),f(!0)},onAccept:async e=>{c.A.confirm({title:"Mark Quotation as Accepted?",content:"This will mark the quotation as accepted by the customer.",onOk:async()=>{try{await ne({id:e._id}).unwrap(),d.Ay.success("Quotation marked as accepted")}catch(n){var t;d.Ay.error((null===n||void 0===n||null===(t=n.data)||void 0===t?void 0:t.message)||"Failed to accept quotation")}}})},onReject:async e=>{c.A.confirm({title:"Mark Quotation as Rejected?",content:(0,z.jsxs)("div",{children:[(0,z.jsx)("p",{children:"Please provide a reason for rejection:"}),(0,z.jsx)(a.A.TextArea,{rows:3,id:"rejection-reason",placeholder:"Enter reason..."})]}),onOk:async()=>{var t;const n=null===(t=document.getElementById("rejection-reason"))||void 0===t?void 0:t.value;if(!n)return d.Ay.error("Rejection reason is required"),Promise.reject();try{await ie({id:e._id,reason:n}).unwrap(),d.Ay.success("Quotation marked as rejected")}catch(o){var i;d.Ay.error((null===o||void 0===o||null===(i=o.data)||void 0===i?void 0:i.message)||"Failed to reject quotation")}}})},onPrint:()=>d.Ay.info("Print functionality coming soon")})),[ne,ie]),de=(0,o.useCallback)((t=>{var n,o,a;const r=null===(n=null!==(o=t.is_gst_included)&&void 0!==o?o:U)||void 0===n||n,l=function(){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).map((t=>{const n=(0,i.A)((0,i.A)({},t),{},{quantity:K(t.quantity),unit_price:K(t.unit_price),tax_percentage:K(t.tax_percentage),discount:K(t.discount),discount_type:"amount"===t.discount_type?"amount":"percentage"}),o=J(n,e);return(0,i.A)((0,i.A)({},n),{},{stock_audit_id:t.stock_audit_id||n.stock_audit_id||void 0},o)}))}(t.items||[],r),s=re(l,r);return(0,i.A)((0,i.A)({},t),{},{items:l,subtotal:s.subtotal,tax_amount:s.tax_amount,discount_amount:s.discount_amount,value_of_goods:s.value_of_goods,total_amount:s.total_amount,quotation_date:t.quotation_date?y()(t.quotation_date).format("YYYY-MM-DD"):y()().format("YYYY-MM-DD"),valid_until:t.valid_until?y()(t.valid_until).format("YYYY-MM-DD"):y()().add(30,"days").format("YYYY-MM-DD"),status:t._id?t.status:"draft",is_gst_included:r,created_by_id:null===e||void 0===e?void 0:e._id,created_by_name:null===e||void 0===e?void 0:e.username,branch_id:(null===e||void 0===e?void 0:e.branch_id)||(null===e||void 0===e||null===(a=e.branchItems)||void 0===a?void 0:a._id)})}),[re,e,U]),ce=(0,o.useCallback)(((e,t,n)=>{const i=void 0!==e.is_gst_included?e.is_gst_included:void 0!==t.is_gst_included?t.is_gst_included:U;i!==U&&G(i)}),[U]),me=(0,o.useMemo)((()=>{return{title:"Quotations",entityName:"Quotation",columns:(e=se,[{title:"Quotation #",dataIndex:"quotation_number",key:"quotation_number",fixed:"left",width:140,render:(e,t)=>(0,z.jsxs)("div",{children:[(0,z.jsx)(m.A,{icon:(0,z.jsx)(N.A,{}),color:"blue",style:{fontSize:"12px"},children:e}),"converted"===t.status&&(0,z.jsx)(m.A,{color:"green",style:{marginTop:4},children:"CONVERTED"})]})},{title:"Status",dataIndex:"status",key:"status",width:140,filters:Object.keys(V).map((e=>({text:V[e].label,value:e}))),onFilter:(e,t)=>t.status===e,render:(e,t)=>{const n=V[e]||V.draft,i=t.valid_until&&y()(t.valid_until).isBefore(y()())&&!["converted","rejected"].includes(e);return(0,z.jsxs)("div",{children:[(0,z.jsx)(h.A,{status:n.color,text:(0,z.jsx)(m.A,{color:n.color,icon:n.icon,children:n.label})}),i&&"expired"!==e&&(0,z.jsx)(m.A,{color:"red",icon:(0,z.jsx)(I.A,{}),style:{marginTop:4},children:"EXPIRED"})]})}},{title:"Customer",dataIndex:"customer",key:"customer",width:180,render:(e,t)=>{const n=t,i=e||t.CustomerItem||{customer_name:t.customer_name,full_name:n.full_name,name:n.name,company_name:""},o=i.customer_name||i.full_name||i.name||"-";return(0,z.jsx)(x.A,{title:i.company_name||i.email||"No additional info",children:(0,z.jsxs)("div",{children:[(0,z.jsx)(T.A,{style:{marginRight:4,color:"#1890ff"}}),(0,z.jsx)("strong",{children:o}),i.company_name&&(0,z.jsx)("div",{style:{fontSize:"11px",color:"#888"},children:i.company_name})]})})}},{title:"Quotation Date",dataIndex:"quotation_date",key:"quotation_date",width:120,sorter:(e,t)=>y()(e.quotation_date).unix()-y()(t.quotation_date).unix(),render:e=>e?(0,z.jsxs)("span",{children:[(0,z.jsx)(F.A,{style:{marginRight:4}}),y()(e).format("DD/MM/YYYY")]}):(0,z.jsx)("span",{style:{color:"#999"},children:"-"})},{title:"Valid Until",dataIndex:"valid_until",key:"valid_until",width:140,sorter:(e,t)=>y()(e.valid_until||0).unix()-y()(t.valid_until||0).unix(),render:(e,t)=>{if(!e)return(0,z.jsx)("span",{style:{color:"#999"},children:"-"});const n=y()(e).isBefore(y()())&&!["converted","rejected"].includes(t.status),i=y()(e).diff(y()(),"days");return(0,z.jsx)(x.A,{title:n?"Expired!":"".concat(i," days left"),children:(0,z.jsxs)("span",{style:{color:n?"#ff4d4f":i<=3?"#faad14":"inherit"},children:[(0,z.jsx)(F.A,{style:{marginRight:4}}),y()(e).format("DD/MM/YYYY")]})})}},{title:"Items",dataIndex:"items",key:"items_count",width:80,align:"center",render:e=>(0,z.jsxs)(m.A,{color:"geekblue",children:[(null===e||void 0===e?void 0:e.length)||0," items"]})},{title:"Total Amount",dataIndex:"total_amount",key:"total_amount",width:130,sorter:(e,t)=>(e.total_amount||0)-(t.total_amount||0),render:e=>(0,z.jsxs)("span",{style:{fontWeight:"bold",color:"#52c41a"},children:[(0,z.jsx)(M.A,{style:{marginRight:4}}),"\u20b9",null===e||void 0===e?void 0:e.toLocaleString("en-IN",{minimumFractionDigits:2})]})},{title:"Converted To",dataIndex:"converted_to_invoice_no",key:"converted_to",width:150,render:(e,t)=>{if(!e)return(0,z.jsx)("span",{style:{color:"#999"},children:"-"});const n=t.converted_date?"Converted on ".concat(y()(t.converted_date).format("DD/MM/YYYY")):"Converted to Invoice";return(0,z.jsx)(x.A,{title:n,children:(0,z.jsx)(m.A,{color:"green",icon:(0,z.jsx)(q,{}),children:e})})}},{title:"Created By",dataIndex:"CreatedByUser",key:"created_by",width:130,render:e=>(0,z.jsx)(x.A,{title:null===e||void 0===e?void 0:e.email,children:(0,z.jsx)("span",{style:{fontSize:"12px"},children:(null===e||void 0===e?void 0:e.username)||"-"})})},{title:"Actions",key:"actions",fixed:"right",width:120,render:(t,n)=>{const i=(0,Q.Tt)(Q.eZ.QUOTATION),o=(0,Q.Ev)(Q.eZ.QUOTATION),a=(0,Q.W9)(Q.eZ.QUOTATION),r=["draft","rejected"].includes(n.status),l="draft"===n.status,s=["draft","sent","accepted"].includes(n.status),d="draft"===n.status,c=o&&r,u=a&&l,m=(0,z.jsxs)(_.A,{children:[i&&(0,z.jsx)(_.A.Item,{icon:(0,z.jsx)(Y.A,{}),onClick:()=>e.onView(n),children:"View Details"},"view"),o&&d&&(0,z.jsx)(_.A.Item,{icon:(0,z.jsx)(L.A,{}),onClick:()=>e.onSend(n),children:"Send to Customer"},"send"),o&&s&&(0,z.jsx)(_.A.Item,{icon:(0,z.jsx)(q,{}),onClick:()=>e.onConvert(n),children:"Convert to Invoice"},"convert"),o&&"sent"===n.status&&(0,z.jsx)(_.A.Item,{icon:(0,z.jsx)(b.A,{}),onClick:()=>e.onAccept(n),children:"Mark as Accepted"},"accept"),o&&"sent"===n.status&&(0,z.jsx)(_.A.Item,{icon:(0,z.jsx)(C.A,{}),onClick:()=>e.onReject(n),children:"Mark as Rejected"},"reject"),i&&(0,z.jsx)(_.A.Item,{icon:(0,z.jsx)(P.A,{}),onClick:()=>e.onPrint(n),children:"Print/PDF"},"print"),c&&(0,z.jsx)(_.A.Item,{icon:(0,z.jsx)(A.A,{}),onClick:()=>e.onEdit(n),children:"Edit"},"edit"),u&&(0,z.jsxs)(z.Fragment,{children:[(0,z.jsx)(_.A.Divider,{}),(0,z.jsx)(_.A.Item,{icon:(0,z.jsx)(O.A,{}),danger:!0,onClick:()=>e.onDelete(n),children:"Delete"},"delete")]})]});return(0,z.jsxs)(v.A,{children:[i&&(0,z.jsx)(x.A,{title:"View Details",children:(0,z.jsx)(g.Ay,{type:"text",size:"small",icon:(0,z.jsx)(Y.A,{}),onClick:()=>e.onView(n)})}),o&&s&&(0,z.jsx)(x.A,{title:"Convert to Invoice",children:(0,z.jsx)(g.Ay,{type:"text",size:"small",icon:(0,z.jsx)(q,{}),onClick:()=>e.onConvert(n),style:{color:"#52c41a"}})}),(0,z.jsx)(p.A,{overlay:m,trigger:["click"],children:(0,z.jsx)(g.Ay,{type:"text",size:"small",icon:(0,z.jsx)(E.A,{})})})]})}}]),formItems:le,formColumns:3,drawerWidth:1400,beforeSave:de,canCreate:()=>(0,Q.BA)(Q.eZ.QUOTATION),canEdit:e=>{const t=(0,Q.Ev)(Q.eZ.QUOTATION),n=["draft","rejected"].includes(null===e||void 0===e?void 0:e.status);return t&&n},canDelete:e=>{const t=(0,Q.W9)(Q.eZ.QUOTATION),n="draft"===(null===e||void 0===e?void 0:e.status);return t&&n}};var e}),[se,le,de]);return(0,z.jsxs)(z.Fragment,{children:[(0,z.jsx)(u.r,{config:me,onValuesChange:ce}),(0,z.jsx)(oe,{open:t,onClose:()=>{n(!1),D(null)},quotation:w}),(0,z.jsx)(xe,{open:j,onClose:()=>{f(!1),D(null)},quotation:w,onSuccess:()=>{f(!1),D(null)}}),(0,z.jsx)(ge,{open:S,onClose:()=>{k(!1),D(null)},quotation:w})]})}},94834:(e,t,n)=>{n.d(t,{A:()=>s});var i=n(65043);const o={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M820 436h-40c-4.4 0-8 3.6-8 8v40c0 4.4 3.6 8 8 8h40c4.4 0 8-3.6 8-8v-40c0-4.4-3.6-8-8-8zm32-104H732V120c0-4.4-3.6-8-8-8H300c-4.4 0-8 3.6-8 8v212H172c-44.2 0-80 35.8-80 80v328c0 17.7 14.3 32 32 32h168v132c0 4.4 3.6 8 8 8h424c4.4 0 8-3.6 8-8V772h168c17.7 0 32-14.3 32-32V412c0-44.2-35.8-80-80-80zM360 180h304v152H360V180zm304 664H360V568h304v276zm200-140H732V500H292v204H160V412c0-6.6 5.4-12 12-12h680c6.6 0 12 5.4 12 12v292z"}}]},name:"printer",theme:"outlined"};var a=n(66381);function r(){return r=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},r.apply(this,arguments)}const l=(e,t)=>i.createElement(a.A,r({},e,{ref:t,icon:o}));const s=i.forwardRef(l)}}]);
//# sourceMappingURL=4122.57a59c89.chunk.js.map