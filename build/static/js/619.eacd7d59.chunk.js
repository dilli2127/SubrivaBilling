/*! For license information please see 619.eacd7d59.chunk.js.LICENSE.txt */
"use strict";(self.webpackChunkSUBRIVA_BILLING=self.webpackChunkSUBRIVA_BILLING||[]).push([[619],{6004:(e,s,r)=>{r.d(s,{A:()=>u});var n=r(56403),t=r(16569);const a=500,i=503;var o=r(89472),c=r(26167);const l=class{constructor(e){this.api=void 0,this.isRefreshing=!1,this.refreshSubscribers=[],this.hasShownSessionExpiredMessage=!1,this.api=n.A.create({baseURL:e,timeout:6e4,headers:{"Content-Type":"application/json"}}),this.api.interceptors.request.use((e=>{const s=(0,o.c4)();if(s&&(e.headers.Token=s,e.headers.Authorization="Bearer ".concat(s)),e.method&&["post","put","patch","delete"].includes(e.method.toLowerCase())){const s=(0,c.m5)();e.headers["X-CSRF-Token"]=s}return e})),this.api.interceptors.response.use((e=>e),(async e=>{const s=e.config;if(e.response&&401===e.response.status&&!s._retry){var r,n;const i=(null===(r=e.response.data)||void 0===r?void 0:r.exception)||(null===(n=e.response.data)||void 0===n?void 0:n.message)||"";if(i.toLowerCase().includes("access denied")||i.toLowerCase().includes("insufficient permissions")||i.toLowerCase().includes("permission"))return t.Ay.error({content:"You do not have permission to perform this action.",duration:5}),Promise.reject(e);if(this.isRefreshing)return new Promise((e=>{this.refreshSubscribers.push((r=>{s.headers&&(s.headers.Token=r,s.headers.Authorization="Bearer ".concat(r)),e(this.api.request(s))}))}));s._retry=!0,this.isRefreshing=!0;try{const e=await this.refreshAccessToken();if(e)return s.headers&&(s.headers.Token=e,s.headers.Authorization="Bearer ".concat(e)),this.refreshSubscribers.forEach((s=>s(e))),this.refreshSubscribers=[],this.api.request(s)}catch(a){return console.error("Token refresh failed:",a),this.hasShownSessionExpiredMessage||(this.hasShownSessionExpiredMessage=!0,t.Ay.error("Your session has expired. Please login again.")),(0,o.m_)(),window.location.href="#/billing_login",Promise.reject(a)}finally{this.isRefreshing=!1}}return Promise.reject(e)}))}async refreshAccessToken(){const e=(0,o.ve)();if(!e)return console.warn("No refresh token available"),null;try{var s;const r=await n.A.post("".concat(this.api.defaults.baseURL,"/auth/refresh-token"),{refreshToken:e},{headers:{"Content-Type":"application/json"}});if(200===(null===(s=r.data)||void 0===s?void 0:s.statusCode)){const{accessToken:e,refreshToken:s}=r.data.result;return(0,o.ki)(e),s&&(0,o.fE)(s),e}return null}catch(r){throw console.error("Failed to refresh access token:",r),r}}async send(e){try{const{data:s}=await this.api.request({method:e.method,url:e.endpoint,data:e.data,signal:e.signal});return this.handleResponse(s)}catch(s){return n.A.isAxiosError(s)&&"CanceledError"===s.name?{statusCode:0,message:"Request cancelled",result:null,pagination:{}}:this.handleError(s)}}handleResponse(e){if(401===e.statusCode){const s=e.exception||e.message||"";return s.toLowerCase().includes("access denied")||s.toLowerCase().includes("insufficient permissions")||s.toLowerCase().includes("permission")?(t.Ay.error({content:"You do not have permission to perform this action.",duration:5}),e):(this.hasShownSessionExpiredMessage||(this.hasShownSessionExpiredMessage=!0,t.Ay.error("Your session has expired. Please login again.")),(0,o.m_)(),window.location.href="#/billing_login",e)}return{statusCode:e.statusCode,message:e.message,result:e.result,pagination:e.pagination}}handleError(e){let s="API call failed",r=a;var t;if(n.A.isAxiosError(e))if(e.response)r=e.response.status,s=(null===(t=e.response.data)||void 0===t?void 0:t.message)||"An error occurred";else if(e.request){var o;s="No response received from server",r=null!==(o=i)&&void 0!==o?o:503}else s=e.message;return{statusCode:r,message:s,result:null,pagination:{}}}};const d=new class{constructor(){this.backendUrl=null,this.isElectron=!1,this.isElectron=this.checkIfElectron(),this.initializeBackendUrl()}checkIfElectron(){return!(!window||!window.electronAPI)}async initializeBackendUrl(){if(this.isElectron&&window.electronAPI)try{this.backendUrl=await window.electronAPI.getBackendUrl()}catch(e){console.error("Failed to get backend URL from Electron:",e),this.backendUrl="http://localhost:8247"}else this.backendUrl="http://localhost:8247"}async getBackendUrl(){return this.backendUrl||await this.initializeBackendUrl(),this.backendUrl||"http://localhost:8249/"}async getApiUrl(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";const s=await this.getBackendUrl(),r=e.startsWith("/")?e:"/".concat(e);return"".concat(s,"/api").concat(r)}isElectronApp(){return this.isElectron}async waitForBackend(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3e4;const s=Date.now(),r=await this.getBackendUrl();for(;Date.now()-s<e;){try{if((await fetch("".concat(r,"/api/health"),{method:"GET",headers:{"Content-Type":"application/json"}})).ok)return!0}catch(n){}await new Promise((e=>setTimeout(e,500)))}return!1}async getAppVersion(){if(this.isElectron&&window.electronAPI)try{return await window.electronAPI.getAppVersion()}catch(e){return console.error("Failed to get app version:",e),"Unknown"}return"Web Version"}getPlatform(){return this.isElectron&&window.electronAPI?window.electronAPI.platform:"web"}};let h=null;const u=async e=>{const s=await(async()=>{if(!h){let e;e=d.isElectronApp()?await d.getBackendUrl():"http://localhost:8249/",h=new l(e)}return h})();return await s.send(e)}},19619:(e,s,r)=>{r.r(s),r.d(s,{default:()=>b});var n=r(89379),t=r(65043),a=r(71782),i=r(26553),o=r(16569),c=r(6051),l=r(76399),d=r(32513),h=r(89073),u=r(96651),p=r(95206),g=r(91686),f=r(39249),A=r(46237),m=r(89967),y=r(90617),x=r(88143),w=r(6004),_=r(70579);const{Title:j,Text:v}=a.A,{Option:k}=i.A,b=()=>{const[e,s]=(0,t.useState)([]),[r,a]=(0,t.useState)(""),[b,C]=(0,t.useState)({}),[E,S]=(0,t.useState)(!1),[U,P]=(0,t.useState)(!1);(0,t.useEffect)((()=>{z()}),[]),(0,t.useEffect)((()=>{r&&T(r)}),[r]);const z=async()=>{S(!0);try{const e=await(0,w.A)({method:"GET",endpoint:"/roles"});if(200===e.statusCode){const r=e.result||[];s(r)}else o.Ay.error("Failed to fetch roles: ".concat(e.message||"Unknown error"))}catch(e){console.error("Error fetching roles:",e),o.Ay.error("Error fetching roles")}finally{S(!1)}},T=async e=>{S(!0);try{const r=await(0,w.A)({method:"GET",endpoint:"/permissions/role/".concat(e)});if(200===r.statusCode){var s;const e=(null===(s=r.result)||void 0===s?void 0:s.resources)||[];if(0===e.length)return o.Ay.warning("No permissions found for this role. Please seed permissions first."),void C({});const n={};e.forEach((e=>{n[e.resource]={resource:e.resource,can_create:e.can_create,can_read:e.can_read,can_update:e.can_update,can_delete:e.can_delete,allowed_menu_keys:e.allowed_menu_keys||[]}})),C(n)}else o.Ay.error("Failed to fetch permissions: ".concat(r.message||"Unknown error"))}catch(r){console.error("Error fetching permissions:",r),o.Ay.error("Error fetching permissions")}finally{S(!1)}},I=(e,s,r)=>{C((t=>(0,n.A)((0,n.A)({},t),{},{[e]:(0,n.A)((0,n.A)({},t[e]),{},{[s]:r})})))},R=(e,s)=>{const r=(0,n.A)({},b);Object.keys(r).forEach((t=>{r[t]=(0,n.A)((0,n.A)({},r[t]),{},{[e]:s})})),C(r)},B=[{title:"Resource",dataIndex:"resource",key:"resource",width:250,fixed:"left",render:e=>(0,_.jsxs)(c.A,{children:[(0,_.jsx)(v,{strong:!0,children:L(e)}),(0,_.jsx)(l.A,{color:"blue",children:e})]})},{title:(0,_.jsxs)(c.A,{direction:"vertical",size:0,align:"center",children:[(0,_.jsx)(v,{children:"Create"}),(0,_.jsx)(d.A,{onChange:e=>R("can_create",e.target.checked),disabled:!r,children:(0,_.jsx)(v,{type:"secondary",style:{fontSize:11},children:"All"})})]}),dataIndex:"can_create",key:"can_create",align:"center",width:100,render:(e,s)=>(0,_.jsx)(d.A,{checked:e,onChange:e=>I(s.resource,"can_create",e.target.checked),disabled:!r})},{title:(0,_.jsxs)(c.A,{direction:"vertical",size:0,align:"center",children:[(0,_.jsx)(v,{children:"Read"}),(0,_.jsx)(d.A,{onChange:e=>R("can_read",e.target.checked),disabled:!r,children:(0,_.jsx)(v,{type:"secondary",style:{fontSize:11},children:"All"})})]}),dataIndex:"can_read",key:"can_read",align:"center",width:100,render:(e,s)=>(0,_.jsx)(d.A,{checked:e,onChange:e=>I(s.resource,"can_read",e.target.checked),disabled:!r})},{title:(0,_.jsxs)(c.A,{direction:"vertical",size:0,align:"center",children:[(0,_.jsx)(v,{children:"Update"}),(0,_.jsx)(d.A,{onChange:e=>R("can_update",e.target.checked),disabled:!r,children:(0,_.jsx)(v,{type:"secondary",style:{fontSize:11},children:"All"})})]}),dataIndex:"can_update",key:"can_update",align:"center",width:100,render:(e,s)=>(0,_.jsx)(d.A,{checked:e,onChange:e=>I(s.resource,"can_update",e.target.checked),disabled:!r})},{title:(0,_.jsxs)(c.A,{direction:"vertical",size:0,align:"center",children:[(0,_.jsx)(v,{children:"Delete"}),(0,_.jsx)(d.A,{onChange:e=>R("can_delete",e.target.checked),disabled:!r,children:(0,_.jsx)(v,{type:"secondary",style:{fontSize:11},children:"All"})})]}),dataIndex:"can_delete",key:"can_delete",align:"center",width:100,render:(e,s)=>(0,_.jsx)(d.A,{checked:e,onChange:e=>I(s.resource,"can_delete",e.target.checked),disabled:!r})},{title:"Summary",key:"summary",align:"center",width:120,render:(e,s)=>{const r=b[s.resource],n=[null===r||void 0===r?void 0:r.can_create,null===r||void 0===r?void 0:r.can_read,null===r||void 0===r?void 0:r.can_update,null===r||void 0===r?void 0:r.can_delete].filter(Boolean).length;return(0,_.jsx)(c.A,{children:4===n?(0,_.jsx)(l.A,{color:"success",icon:(0,_.jsx)(A.A,{}),children:"Full Access"}):0===n?(0,_.jsx)(l.A,{color:"error",icon:(0,_.jsx)(m.A,{}),children:"No Access"}):(0,_.jsxs)(l.A,{color:"processing",children:[n,"/4"]})})}}],L=e=>e.split("_").map((e=>e.charAt(0).toUpperCase()+e.slice(1))).join(" "),V=Object.entries(b).map((e=>{let[s,r]=e;return{key:s,resource:s,can_create:r.can_create,can_read:r.can_read,can_update:r.can_update,can_delete:r.can_delete}})),F=e.find((e=>e._id===r));return(0,_.jsx)("div",{className:"permission-management",children:(0,_.jsx)(h.A,{title:(0,_.jsx)(c.A,{children:(0,_.jsx)(j,{level:4,style:{margin:0},children:"Permission Management"})}),extra:(0,_.jsxs)(c.A,{children:[(0,_.jsx)(u.A,{title:"Refresh",children:(0,_.jsx)(p.Ay,{icon:(0,_.jsx)(y.A,{}),onClick:()=>{z(),r&&T(r)},children:"Refresh"})}),(0,_.jsx)(p.Ay,{type:"primary",icon:(0,_.jsx)(x.A,{}),onClick:async()=>{if(r){P(!0);try{const e=Object.entries(b).map((e=>{let[s,r]=e;return{resource:s,can_create:r.can_create||!1,can_read:r.can_read||!1,can_update:r.can_update||!1,can_delete:r.can_delete||!1}})),s=await(0,w.A)({method:"POST",endpoint:"/permissions/bulk",data:{role_id:r,permissions:e}});200===s.statusCode?(o.Ay.success("Permissions updated successfully"),T(r)):o.Ay.error(s.message||"Failed to update permissions")}catch(n){var e,s;console.error("Error saving permissions:",n),o.Ay.error((null===n||void 0===n||null===(e=n.response)||void 0===e||null===(s=e.data)||void 0===s?void 0:s.exception)||"Error saving permissions")}finally{P(!1)}}else o.Ay.warning("Please select a role first")},loading:U,disabled:!r,children:"Save Changes"})]}),children:(0,_.jsxs)(c.A,{direction:"vertical",size:"large",style:{width:"100%"},children:[(0,_.jsxs)("div",{children:[(0,_.jsx)(v,{strong:!0,style:{marginRight:8},children:"Select Role:"}),(0,_.jsx)(i.A,{style:{width:300},placeholder:"Choose a role to manage permissions",value:r||void 0,onChange:a,loading:E,children:e.map((e=>(0,_.jsx)(k,{value:e._id,children:(0,_.jsxs)(c.A,{children:[(0,_.jsx)(v,{children:e.name}),(0,_.jsx)(l.A,{color:"blue",children:e.roles_type})]})},e._id)))}),F&&(0,_.jsx)(v,{type:"secondary",style:{marginLeft:12},children:F.description})]}),(0,_.jsx)(g.A,{spinning:E,children:(0,_.jsx)(f.A,{columns:B,dataSource:V,pagination:!1,scroll:{x:800,y:500},bordered:!0,size:"small",locale:{emptyText:r?"No permissions found for this role":"Please select a role to view permissions"}})}),r&&V.length>0&&(0,_.jsx)(h.A,{size:"small",style:{background:"#f5f5f5"},children:(0,_.jsxs)(c.A,{size:"large",children:[(0,_.jsxs)(v,{children:[(0,_.jsx)(v,{strong:!0,children:"Total Resources:"})," ",V.length]}),(0,_.jsxs)(v,{children:[(0,_.jsx)(v,{strong:!0,children:"Full Access:"})," ",V.filter((e=>e.can_create&&e.can_read&&e.can_update&&e.can_delete)).length]}),(0,_.jsxs)(v,{children:[(0,_.jsx)(v,{strong:!0,children:"No Access:"})," ",V.filter((e=>!e.can_create&&!e.can_read&&!e.can_update&&!e.can_delete)).length]}),(0,_.jsxs)(v,{children:[(0,_.jsx)(v,{strong:!0,children:"Partial Access:"})," ",V.filter((e=>[e.can_create,e.can_read,e.can_update,e.can_delete].filter(Boolean).length>0&&!(e.can_create&&e.can_read&&e.can_update&&e.can_delete))).length]})]})})]})})})}},88143:(e,s,r)=>{r.d(s,{A:()=>c});var n=r(65043);const t={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M893.3 293.3L730.7 130.7c-7.5-7.5-16.7-13-26.7-16V112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V338.5c0-17-6.7-33.2-18.7-45.2zM384 184h256v104H384V184zm456 656H184V184h136v136c0 17.7 14.3 32 32 32h320c17.7 0 32-14.3 32-32V205.8l136 136V840zM512 442c-79.5 0-144 64.5-144 144s64.5 144 144 144 144-64.5 144-144-64.5-144-144-144zm0 224c-44.2 0-80-35.8-80-80s35.8-80 80-80 80 35.8 80 80-35.8 80-80 80z"}}]},name:"save",theme:"outlined"};var a=r(66381);function i(){return i=Object.assign?Object.assign.bind():function(e){for(var s=1;s<arguments.length;s++){var r=arguments[s];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},i.apply(this,arguments)}const o=(e,s)=>n.createElement(a.A,i({},e,{ref:s,icon:t}));const c=n.forwardRef(o)}}]);
//# sourceMappingURL=619.eacd7d59.chunk.js.map